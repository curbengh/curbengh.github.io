<!DOCTYPE html><html lang="en-GB"><head><meta charset="utf-8"><title>Installing Caddy plugins in NixOS | Ming Di Leom&#39;s Blog</title><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="canonical" href="https://mdleom.com/blog/2021/12/27/caddy-plugins-nixos/"><meta name="description" content="By using custom package"><meta property="article:author" content="Ming Di Leom"><meta property="article:tag" content="caddy"><meta property="article:tag" content="nixos"><meta property="og:type" content="article"><meta property="og:title" content="Installing Caddy plugins in NixOS"><meta property="og:url" content="https://mdleom.com/blog/2021/12/27/caddy-plugins-nixos/"><meta property="og:site_name" content="Ming Di Leom&#39;s Blog"><meta property="og:description" content="By using custom package"><meta property="og:locale" content="en_GB"><meta property="og:image" content="https://mdleom.com/screenshot/blog/2021/12/27/caddy-plugins-nixos/"><meta property="article:published_time" content="2021-12-27T00:00:00.000Z"><meta property="article:modified_time" content="2023-02-26T00:00:00.000Z"><link rel="alternate" href="/atom.xml" title="Ming Di Leom's Blog" type="application/atom+xml"><link rel="icon" href="/favicon.ico"><link rel="icon" href="/svg/favicon.svg" type="image/svg+xml" sizes="any"><link rel="apple-touch-icon" href="/apple-touch-icon-180x180.png"><link rel="manifest" href="/site.webmanifest"><link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml"><link rel="stylesheet" href="/css/chameleon.css"><meta name="yandex-verification" content="e026a03a5dd06730"><meta name="generator" content="Hexo 7.1.1"></head><body><div id="container" class="container"><article id="post-caddy-plugins-nixos" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting"><header id="header" class="header"><nav class="main-nav"><a class="main-nav-link" href="/">Home</a> <a class="main-nav-link" href="/blog/">Blog</a> <a class="main-nav-link" href="/about/">About</a> <a class="main-nav-link" href="/atom.xml">Feed</a> <a class="main-nav-link" href="https://gitlab.com/curben/blog" rel="noopener external nofollow noreferrer">GitLab</a><div class="search-container"><form id="searchForm" method="post" action="https://duckduckgo.com/" rel="noopener external nofollow noreferrer" role="search"><input type="search" name="q" class="search-box" placeholder="Search..." title="Powered by DuckDuckGo" enterkeyhint="search"> <input type="hidden" name="sites" value="mdleom.com"> <input type="hidden" name="kd" value="-1"> <input type="hidden" name="kg" value="p"> <input type="hidden" name="kae" value="#000"> <a class="search-button" id="search-click"><img src="/svg/search.svg"></a></form></div></nav><nav class="mobile-nav"><a class="site-title" href="/">mdleom.com</a><ul class="mobile-nav-menu"><label for="mobile-menu-toggle"><a class="no-underline" id="menu-button">&#9776;</a></label> <input id="mobile-menu-toggle" type="checkbox"><ul id="mobile-nav-link"><div class="search-container"><form id="searchFormMob" method="post" action="https://duckduckgo.com/" rel="noopener external nofollow noreferrer" role="search"><input type="search" name="q" class="search-box" placeholder="Search..." title="Powered by DuckDuckGo" enterkeyhint="search"> <input type="hidden" name="sites" value="mdleom.com"> <input type="hidden" name="kd" value="-1"> <input type="hidden" name="kg" value="p"> <input type="hidden" name="kae" value="#000"> <a class="search-button" id="search-click-mobile"><img src="/svg/search.svg"></a></form></div><i>Powered by DuckDuckGo</i> <a class="mobile-nav-link-a" href="/">Home</a> <a class="mobile-nav-link-a" href="/blog/">Blog</a> <a class="mobile-nav-link-a" href="/about/">About</a> <a class="mobile-nav-link-a" href="/atom.xml">Feed</a> <a class="mobile-nav-link-a" href="https://gitlab.com/curben/blog" rel="noopener external nofollow noreferrer">GitLab</a></ul></ul></nav></header><hr class="header-hr"><div class="article-inner"><header class="article-header"><h1 class="p-name entry-title article-title" itemprop="headline name">Installing Caddy plugins in NixOS <a id="btnshare"><img src="/svg/share.svg"></a></h1></header><p class="p-summary">By using custom package</p><div class="e-content article-entry" itemprop="articleBody"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Custom-package"><span class="toc-text">Custom package</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Install-custom-package"><span class="toc-text">Install custom package</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#xcaddy"><span class="toc-text">xcaddy</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Nix-sandbox"><span class="toc-text">Nix sandbox</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Build-custom-plugins-with-xcaddy"><span class="toc-text">Build custom plugins with xcaddy</span></a></li></ol></li></ol><blockquote><p><a href="#Custom-package">Previous method</a> no longer works on 22.11. Refer to <a href="#xcaddy">xcaddy</a> section instead.</p></blockquote><p>Caddy, like any other web servers, is extensible through plugins. Plugin is usually installed using <a href="https://github.com/caddyserver/xcaddy" rel="noopener external nofollow noreferrer">xcaddy</a>; using it is as easy as <code>$ xcaddy build --with github.com/caddyserver/ntlm-transport</code> to build the latest caddy binary with <a href="https://github.com/caddyserver/ntlm-transport" rel="noopener external nofollow noreferrer">ntlm-transport</a> plugin.</p><p>NixOS has its <a href="https://nixos.org/manual/nixpkgs/stable/#sec-language-go" rel="noopener external nofollow noreferrer">own way</a> of building Go package (Caddy is written in Go), so using xcaddy may be counterintuitive. The <em>Nix</em>-way to go is to build a custom package using a “*.nix” file and instruct the service (also known as a <em>module</em> in Nix ecosystem) to use that package instead of the repo’s.</p><p>In NixOS, the Caddy module has long included <a href="https://search.nixos.org/options?channel=21.11&show=services.caddy.package&from=0&size=50&sort=relevance&type=packages&query=caddy" rel="noopener external nofollow noreferrer"><code>services.caddy.package</code></a> option to specify custom package. It was primarily used as a way to install Caddy 2 from the unstable channel (<code>unstable.caddy</code>) because the package in stable channel (<code>pkgs.caddy</code>) of NixOS 20.03 is still Caddy 1. I talked about that option in a <a href="/blog/2020/05/24/caddy-v2-nixos/" title="Running Caddy 2 in NixOS 20.03">previous post</a>.</p><p>Aside from installing Caddy from different channel, that option can also be used to specify a custom package by using <a href="https://nixos.org/guides/nix-pills/callpackage-design-pattern.html" rel="noopener external nofollow noreferrer"><code>pkgs.callPackage</code></a>. I <a href="/blog/2021/07/02/custom-package-nixos-module/" title="Using custom package in a NixOS module">previously used</a> <code>callPackage</code> as a workaround to install cloudflared in an IPv6-only instance from a repository other than GitHub because GitHub doesn’t support IPv6 yet.</p><p>If a custom package is defined in “&#x2F;etc&#x2F;caddy&#x2F;custom-package.nix”, then the configuration will be:</p><pre><div class="caption"><span>/etc/nixos/configuration.nix</span></div><code class="hljs nix">services.<span class="hljs-attr">caddy</span> = &#123;
  <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">package</span> = pkgs.callPackage /etc/caddy/custom-package.nix &#123; &#125;;
&#125;;</code><button class="copy-button">Copy</button></pre><h2 id="Custom-package">Custom package <a href="#Custom-package" class="headerlink" title="Custom package">§</a></h2><p>The following package patches the “<a href="https://github.com/caddyserver/caddy/blob/master/cmd/main.go" rel="noopener external nofollow noreferrer">main.go</a>“ file of the upstream source to insert additional plugins. The code snippet is courtesy of <a href="https://github.com/diamondburned" rel="noopener external nofollow noreferrer">@diamondburned</a>. The marked lines show how plugins are specified through the <code>plugins</code> option.</p><pre><div class="caption"><span>/etc/caddy/custom-package.nix</span><a href="https://github.com/NixOS/nixpkgs/issues/89268#issuecomment-636529668" rel="noopener external nofollow noreferrer">source</a></div><code class="hljs nix">&#123; lib, buildGoModule, fetchFromGitHub, plugins ? [], vendorSha256 ? <span class="hljs-string">&quot;&quot;</span> &#125;:
<span class="hljs-keyword">with</span> lib;
<mark><span class="hljs-keyword">let</span> <span class="hljs-attr">imports</span> = flip concatMapStrings plugins (pkg: <span class="hljs-string">&quot;\t\t\t_ \&quot;</span>$&#123;pkg&#125;\<span class="hljs-string">&quot;\n&quot;</span>);</mark>

  <span class="hljs-attr">main</span> = <span class="hljs-string">&#x27;&#x27;</span>
<span class="hljs-string">    package main</span>
<span class="hljs-string"></span>
<span class="hljs-string">    import (</span>
<span class="hljs-string">      caddycmd &quot;github.com/caddyserver/caddy/v2/cmd&quot;</span>
<span class="hljs-string"></span>
<span class="hljs-string">      _ &quot;github.com/caddyserver/caddy/v2/modules/standard&quot;</span>
<mark><span class="hljs-string"><span class="hljs-subst">$&#123;imports&#125;</span></span></mark>
<span class="hljs-string">    )</span>
<span class="hljs-string"></span>
<span class="hljs-string">    func main() &#123;</span>
<span class="hljs-string">      caddycmd.Main()</span>
<span class="hljs-string">    &#125;</span>
<span class="hljs-string">  &#x27;&#x27;</span>;

<span class="hljs-keyword">in</span> buildGoModule <span class="hljs-keyword">rec</span> &#123;
  <span class="hljs-attr">pname</span> = <span class="hljs-string">&quot;caddy&quot;</span>;
  <span class="hljs-attr">version</span> = <span class="hljs-string">&quot;2.4.6&quot;</span>;

  <span class="hljs-attr">subPackages</span> = [ <span class="hljs-string">&quot;cmd/caddy&quot;</span> ];

  <span class="hljs-attr">src</span> = fetchFromGitHub &#123;
    <span class="hljs-attr">owner</span> = <span class="hljs-string">&quot;caddyserver&quot;</span>;
    <span class="hljs-attr">repo</span> = pname;
    <span class="hljs-comment"># https://github.com/NixOS/nixpkgs/blob/nixos-21.11/pkgs/servers/caddy/default.nix</span>
    <span class="hljs-attr">rev</span> = <span class="hljs-string">&quot;v<span class="hljs-subst">$&#123;version&#125;</span>&quot;</span>;
    <span class="hljs-attr">sha256</span> = <span class="hljs-string">&quot;sha256-xNCxzoNpXkj8WF9+kYJfO18ux8/OhxygkGjA49+Q4vY=&quot;</span>;
  &#125;;

  <span class="hljs-keyword">inherit</span> vendorSha256;

  <span class="hljs-attr">overrideModAttrs</span> = (_: &#123;
    <span class="hljs-attr">preBuild</span>    = <span class="hljs-string">&quot;echo &#x27;<span class="hljs-subst">$&#123;main&#125;</span>&#x27; &gt; cmd/caddy/main.go&quot;</span>;
    <span class="hljs-attr">postInstall</span> = <span class="hljs-string">&quot;cp go.sum go.mod $out/ &amp;&amp; ls $out/&quot;</span>;
  &#125;);

  <span class="hljs-attr">postPatch</span> = <span class="hljs-string">&#x27;&#x27;</span>
<span class="hljs-string">    echo &#x27;<span class="hljs-subst">$&#123;main&#125;</span>&#x27; &gt; cmd/caddy/main.go</span>
<span class="hljs-string">    cat cmd/caddy/main.go</span>
<span class="hljs-string">  &#x27;&#x27;</span>;

  <span class="hljs-attr">postConfigure</span> = <span class="hljs-string">&#x27;&#x27;</span>
<span class="hljs-string">    cp vendor/go.sum ./</span>
<span class="hljs-string">    cp vendor/go.mod ./</span>
<span class="hljs-string">  &#x27;&#x27;</span>;

  <span class="hljs-attr">meta</span> = <span class="hljs-keyword">with</span> lib; &#123;
    <span class="hljs-attr">homepage</span> = https://caddyserver.com;
    <span class="hljs-attr">description</span> = <span class="hljs-string">&quot;Fast, cross-platform HTTP/2 web server with automatic HTTPS&quot;</span>;
    <span class="hljs-attr">license</span> = licenses.asl20;
    <span class="hljs-attr">maintainers</span> = <span class="hljs-keyword">with</span> maintainers; [ rushmorem fpletz zimbatm ];
  &#125;;
&#125;</code><button class="copy-button">Copy</button></pre><h3 id="Install-custom-package">Install custom package <a href="#Install-custom-package" class="headerlink" title="Install custom package">§</a></h3><p>Specify the desired plugins in <code>services.caddy.package.plugins</code>:</p><pre><div class="caption"><span>/etc/nixos/configuration.nix</span></div><code class="hljs nix">services.<span class="hljs-attr">caddy</span> = &#123;
  <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">package</span> = (pkgs.callPackage /etc/caddy/custom-package.nix &#123;
    <span class="hljs-attr">plugins</span> = [
      <span class="hljs-string">&quot;github.com/caddyserver/ntlm-transport&quot;</span>
      <span class="hljs-string">&quot;github.com/caddyserver/forwardproxy&quot;</span>
    ];
    <span class="hljs-attr">vendorSha256</span> = <span class="hljs-string">&quot;0000000000000000000000000000000000000000000000000000&quot;</span>;
  &#125;);
&#125;;</code><button class="copy-button">Copy</button></pre><p>The above example will install ntlm-transport and <a href="https://github.com/caddyserver/forwardproxy" rel="noopener external nofollow noreferrer">forwardproxy</a> plugins. The first run of <code>nixos-rebuild</code> will fail due to mismatched <code>vendorSha256</code>, simply replace the “000…” with the expected value and the second run should be ok.</p><h2 id="xcaddy">xcaddy <a href="#xcaddy" class="headerlink" title="xcaddy">§</a></h2><h3 id="Nix-sandbox">Nix sandbox <a href="#Nix-sandbox" class="headerlink" title="Nix sandbox">§</a></h3><p>Since the Nix-way of building custom caddy plugins no longer works in 22.11, I resort to the <em>caddy</em>-way instead, by using <a href="https://github.com/caddyserver/xcaddy" rel="noopener external nofollow noreferrer">xcaddy</a>. The implication of using xcaddy is that Nix sandbox can no longer be enabled because the sandbox does not even allow network access. Nix sandbox is enabled by default in NixOS, to disable:</p><pre><div class="caption"><span>/etc/nixox/configuration.nix</span></div><code class="hljs nix">nix.settings.<span class="hljs-attr">sandbox</span> = <span class="hljs-literal">false</span>;</code><button class="copy-button">Copy</button></pre><p>Then run <code>sudo nixos-rebuild switch</code> to apply the config. Verify the generated config in <code>/etc/nix/nix.conf</code>.</p><p><a href="https://nixos.wiki/wiki/Nix_package_manager#Sandboxing" rel="noopener external nofollow noreferrer">Nix sandbox</a> is not a security feature, rather it is used to provide reproducibility, its fundamental feature. When enabled, each build will run in an isolated environment not affected by the system configuration. This feature is essential when contributing to <a href="https://github.com/NixOS/nixpkgs" rel="noopener external nofollow noreferrer">Nixpkgs</a> to ensure that a successful build does not depend on the contributor’s system configuration. For example, all dependencies should be declared even when the contributor’s system already installed all or some beforehand; a build will fail if there is any undeclared dependency.</p><h3 id="Build-custom-plugins-with-xcaddy">Build custom plugins with xcaddy <a href="#Build-custom-plugins-with-xcaddy" class="headerlink" title="Build custom plugins with xcaddy">§</a></h3><p>The following package will always use the <a href="https://github.com/caddyserver/caddy/releases/latest" rel="noopener external nofollow noreferrer"><code>latest</code></a> caddy release.</p><pre><div class="caption"><span>/etc/caddy/custom-package.nix</span><a href="https://discourse.nixos.org/t/build-caddy-with-modules-in-devenv-shell/25125/4" rel="noopener external nofollow noreferrer">source</a></div><code class="hljs nix">&#123; pkgs, config, plugins, ... &#125;:

<span class="hljs-keyword">with</span> pkgs;

stdenv.mkDerivation <span class="hljs-keyword">rec</span> &#123;
  <span class="hljs-attr">pname</span> = <span class="hljs-string">&quot;caddy&quot;</span>;
<mark>  <span class="hljs-comment"># https://github.com/NixOS/nixpkgs/issues/113520</span></mark>
  <span class="hljs-attr">version</span> = <span class="hljs-string">&quot;latest&quot;</span>;
  <span class="hljs-attr">dontUnpack</span> = <span class="hljs-literal">true</span>;

  <span class="hljs-attr">nativeBuildInputs</span> = [ git go xcaddy ];

  <span class="hljs-attr">configurePhase</span> = <span class="hljs-string">&#x27;&#x27;</span>
<span class="hljs-string">    export GOCACHE=$TMPDIR/go-cache</span>
<span class="hljs-string">    export GOPATH=&quot;$TMPDIR/go&quot;</span>
<span class="hljs-string">  &#x27;&#x27;</span>;

  <span class="hljs-attr">buildPhase</span> = <span class="hljs-keyword">let</span>
    <span class="hljs-attr">pluginArgs</span> = lib.concatMapStringsSep <span class="hljs-string">&quot; &quot;</span> (plugin: <span class="hljs-string">&quot;--with <span class="hljs-subst">$&#123;plugin&#125;</span>&quot;</span>) plugins;
  <span class="hljs-keyword">in</span> <span class="hljs-string">&#x27;&#x27;</span>
<mark><span class="hljs-string">    runHook preBuild</span></mark>
<span class="hljs-string">    <span class="hljs-subst">$&#123;xcaddy&#125;</span>/bin/xcaddy build latest <span class="hljs-subst">$&#123;pluginArgs&#125;</span></span>
<span class="hljs-string">    runHook postBuild</span>
<span class="hljs-string">  &#x27;&#x27;</span>;


  <span class="hljs-attr">installPhase</span> = <span class="hljs-string">&#x27;&#x27;</span>
<span class="hljs-string">    runHook preInstall</span>
<span class="hljs-string">    mkdir -p $out/bin</span>
<span class="hljs-string">    mv caddy $out/bin</span>
<span class="hljs-string">    runHook postInstall</span>
<span class="hljs-string">  &#x27;&#x27;</span>;
&#125;</code><button class="copy-button">Copy</button></pre><p>If you prefer to specify a version, modify the following lines:</p><pre><code class="hljs nix"><span class="hljs-comment"># line 7</span>
<span class="hljs-attr">version</span> = <span class="hljs-string">&quot;2.6.4&quot;</span>;
<span class="hljs-comment"># line 12</span>
$&#123;xcaddy&#125;/bin/xcaddy build <span class="hljs-string">&quot;v<span class="hljs-subst">$&#123;version&#125;</span>&quot;</span> $&#123;pluginArgs&#125;</code><button class="copy-button">Copy</button></pre><p>To install the above package, use the same config shown in the <a href="#Install-custom-package">Install custom package</a> but remove the <code>vendorSha256</code> line. Remember to <code>nixos-rebuild</code> again.</p></div><footer class="article-footer"><ul class="article-meta"><li><span class="label">Last Updated:</span> <time class="dt-updated" datetime="2023-02-26T00:00:00.000Z" itemprop="dateModified">26 Feb 2023</time></li><li><span class="label">Published Date:</span> <time class="dt-published" datetime="2021-12-27T00:00:00.000Z" itemprop="datePublished">27 <a href="/blog/2021/12/" title="See December 2021's posts">Dec</a> <a href="/blog/2021/" title="See 2021's posts">2021</a></time></li><li><span class="label">Tag:</span><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/caddy/" rel="tag">Caddy</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nixos/" rel="tag">Nixos</a></li></ul></li><li><span class="label">Source:</span> <a href="https://gitlab.com/curben/blog/-/blob/master/source/_posts/caddy-plugins-nixos.md" rel="noopener external nofollow noreferrer">caddy-plugins-nixos.md</a></li><hr></ul></footer></div><nav id="article-nav" class="article-nav"><span class="article-nav-link-wrap newer"><strong>Newer</strong> <a href="/blog/2022/08/09/remove-gitlab-artifacts/"><div class="article-nav-title">Bulk remove old GitLab CI job artifacts</div></a></span><span class="article-nav-link-wrap older"><strong>Older</strong> <a href="/blog/2021/12/25/nginx-splunk-field-extractor/"><div class="article-nav-title">Parsing NGINX log in Splunk</div></a></span></nav></article></div><footer id="footer" class="post-footer footer"><hr><div id="copyright" class="copyright">&copy; 2018-2024 Ming Di Leom. <a href="https://gitlab.com/curben/blog" rel="noopener external nofollow noreferrer">Powered by </a><a href="https://hexo.io/" rel="noopener external nofollow noreferrer">Hexo</a> with <a href="https://gitlab.com/curben/blog/tree/master/themes/chameleon" rel="noopener external nofollow noreferrer">Chameleon</a> theme.<br>Content is available under <a href="https://creativecommons.org/licenses/by-sa/4.0/" rel="noopener external nofollow noreferrer license" itemprop="license">CC-BY-SA 4.0</a>, unless indicated otherwise.<br><a class="main-nav-link" href="/disclaimer/">Disclaimer</a> <a class="main-nav-link" href="https://stats.uptimerobot.com/1394zup2LQ" rel="noopener external nofollow noreferrer">Status</a> <a class="main-nav-link" href="https://xw226dvxac7jzcpsf4xb64r4epr6o5hgn46dxlqk7gnjptakik6xnzqd.onion/" rel="noopener external nofollow noreferrer">Onion</a> <a class="main-nav-link" href="https://gitlab.com/curben/blog#mirrors" rel="noopener external nofollow noreferrer">Eepsite</a></div></footer><script src="/libs/clipboard-2.0.6.min.js" defer></script><script src="/js/copy-button.js"></script><script src="/js/chameleon.js"></script></body></html>