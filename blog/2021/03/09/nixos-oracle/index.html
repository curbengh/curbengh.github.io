<!DOCTYPE html><html lang="en-GB"><head><meta charset="utf-8"><title>Install NixOS on Oracle Cloud | Ming Di Leom&#39;s Blog</title><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="canonical" href="https://mdleom.com/blog/2021/03/09/nixos-oracle/"><meta name="description" content="Two always free bare minimum VM with 20TB bandwidth"><meta property="article:author" content="Ming Di Leom"><meta property="article:tag" content="linux"><meta property="article:tag" content="nixos"><meta property="article:tag" content="oci"><meta property="og:type" content="article"><meta property="og:title" content="Install NixOS on Oracle Cloud"><meta property="og:url" content="https://mdleom.com/blog/2021/03/09/nixos-oracle/"><meta property="og:site_name" content="Ming Di Leom&#39;s Blog"><meta property="og:description" content="Two always free bare minimum VM with 20TB bandwidth"><meta property="og:locale" content="en_GB"><meta property="og:image" content="https://mdleom.com/screenshot/blog/2021/03/09/nixos-oracle/"><meta property="article:published_time" content="2021-03-09T00:00:00.000Z"><link rel="alternate" href="/atom.xml" title="Ming Di Leom's Blog" type="application/atom+xml"><link rel="icon" href="/favicon.ico"><link rel="icon" href="/svg/favicon.svg" type="image/svg+xml" sizes="any"><link rel="apple-touch-icon" href="/apple-touch-icon-180x180.png"><link rel="manifest" href="/site.webmanifest"><link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml"><link rel="stylesheet" href="/css/chameleon.css"><meta name="yandex-verification" content="e026a03a5dd06730"><meta name="generator" content="Hexo 7.1.1"></head><body><div id="container" class="container"><article id="post-nixos-oracle" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting"><header id="header" class="header"><nav class="main-nav"><a class="main-nav-link" href="/">Home</a> <a class="main-nav-link" href="/blog/">Blog</a> <a class="main-nav-link" href="/about/">About</a> <a class="main-nav-link" href="/atom.xml">Feed</a> <a class="main-nav-link" href="https://gitlab.com/curben/blog" rel="noopener external nofollow noreferrer">GitLab</a><div class="search-container"><form id="searchForm" method="post" action="https://duckduckgo.com/" rel="noopener external nofollow noreferrer" role="search"><input type="search" name="q" class="search-box" placeholder="Search..." title="Powered by DuckDuckGo" enterkeyhint="search"> <input type="hidden" name="sites" value="mdleom.com"> <input type="hidden" name="kd" value="-1"> <input type="hidden" name="kg" value="p"> <input type="hidden" name="kae" value="#000"> <a class="search-button" id="search-click"><img src="/svg/search.svg"></a></form></div></nav><nav class="mobile-nav"><a class="site-title" href="/">mdleom.com</a><ul class="mobile-nav-menu"><label for="mobile-menu-toggle"><a class="no-underline" id="menu-button">&#9776;</a></label> <input id="mobile-menu-toggle" type="checkbox"><ul id="mobile-nav-link"><div class="search-container"><form id="searchFormMob" method="post" action="https://duckduckgo.com/" rel="noopener external nofollow noreferrer" role="search"><input type="search" name="q" class="search-box" placeholder="Search..." title="Powered by DuckDuckGo" enterkeyhint="search"> <input type="hidden" name="sites" value="mdleom.com"> <input type="hidden" name="kd" value="-1"> <input type="hidden" name="kg" value="p"> <input type="hidden" name="kae" value="#000"> <a class="search-button" id="search-click-mobile"><img src="/svg/search.svg"></a></form></div><i>Powered by DuckDuckGo</i> <a class="mobile-nav-link-a" href="/">Home</a> <a class="mobile-nav-link-a" href="/blog/">Blog</a> <a class="mobile-nav-link-a" href="/about/">About</a> <a class="mobile-nav-link-a" href="/atom.xml">Feed</a> <a class="mobile-nav-link-a" href="https://gitlab.com/curben/blog" rel="noopener external nofollow noreferrer">GitLab</a></ul></ul></nav></header><hr class="header-hr"><div class="article-inner"><header class="article-header"><h1 class="p-name entry-title article-title" itemprop="headline name">Install NixOS on Oracle Cloud <a id="btnshare"><img src="/svg/share.svg"></a></h1></header><p class="p-summary">Two always free bare minimum VM with 20TB bandwidth</p><div class="e-content article-entry" itemprop="articleBody"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Build-a-kexec-tarball"><span class="toc-text">Build a kexec tarball</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Create-IAM-policy"><span class="toc-text">Create IAM policy</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Create-a-new-VCN"><span class="toc-text">Create a new VCN</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Launch-an-Ubuntu-instance"><span class="toc-text">Launch an Ubuntu instance</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Upload-kexec-tarball"><span class="toc-text">Upload kexec tarball</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Upload-to-Object-storage"><span class="toc-text">Upload to Object storage</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Execute-kexec-iamge"><span class="toc-text">Execute kexec iamge</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Installation"><span class="toc-text">Installation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Partition"><span class="toc-text">Partition</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Format-partitions"><span class="toc-text">Format partitions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Mount-partitions"><span class="toc-text">Mount partitions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Configure-and-install"><span class="toc-text">Configure and install</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Launch-a-redundant-instance"><span class="toc-text">Launch a redundant instance</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Conclusion"><span class="toc-text">Conclusion</span></a></li></ol><blockquote><p>Skip to <a href="#Build-a-kexec-tarball">first step</a></p></blockquote><p>A few weeks ago, there was an active discussion on <a href="http://news.ycombinator.com/item?id=26239711" rel="noopener external nofollow noreferrer">HN</a> about the <a href="https://free-for.dev/" rel="noopener external nofollow noreferrer">Free For Dev</a> page which compile a list of free tier (or at least free <em>trial</em>) resources that are useful for developers. The page mentioned Oracle Cloud provides two <em>always free</em> VMs (<a href="https://docs.oracle.com/en-us/iaas/Content/FreeTier/resourceref.htm#ariaid-title2" rel="noopener external nofollow noreferrer">specification</a>), whereas big three only offer one VM for a year. While I knew about this offering for a while, but I’ve always been sceptical about it.</p><p>I decided to give it a try after a few comments mentioned the offering is genuine. Besides, I always felt a bit uneasy about my <em>single</em> reverse proxy setup. The sign up process was slightly bumpy because the payment processing page (shop.oracle.com) requires <code>Referer</code> header that I blocked using <a href="https://github.com/cowlicks/privacypossum" rel="noopener external nofollow noreferrer">Privacy Possum</a>; I managed to complete the sign up after disabling the addon on the page.</p><p>For cloud image, NixOS only officially supports AWS EC2, so I expected the installation to be manual. I searched Oracle’s official documentation and found these two articles (<a href="https://blogs.oracle.com/cloud-infrastructure/importing-virtualbox-virtual-machines-into-oracle-cloud-infrastructure" rel="noopener external nofollow noreferrer">1</a>, <a href="https://docs.oracle.com/en-us/iaas/Content/Compute/Tasks/importingcustomimagelinux.htm" rel="noopener external nofollow noreferrer">2</a>). The first article mentioned custom image can be created with VirtualBox, with notable requirements that the disk image is in KVM-compatible VMDK&#x2F;QCOW format and the bootloader is in BIOS (not UEFI) mode. Long story short, that didn’t work. I made sure Qemu guest agent and <code>virtio</code> kernel module are installed, but to no avail. Maybe I forgot to set the interface name to <code>ens3</code>?</p><pre><code class="hljs nix">networking.<span class="hljs-attr">useDHCP</span> = <span class="hljs-literal">false</span>;
networking.interfaces.ens3.<span class="hljs-attr">useDHCP</span> = <span class="hljs-literal">true</span>;</code><button class="copy-button">Copy</button></pre><p>Undeterred by this initial setback, I searched for “nixos oracle cloud” and found this <a href="https://gist.github.com/misuzu/89fb064a2cc09c6a75dc9833bb3995bf" rel="noopener external nofollow noreferrer">gist</a>. It offered two approaches, the first one is installing Nix package manager on an Ubuntu VM (provisioned using an official image) and <em>partially</em> replace the OS by overwriting the bootloader so it boots NixOS instead. But that didn’t work too, so I tried the second one instead, which <em>worked</em>. So, let’s get started.</p><p>Edit (15 Mar 2021): I stumbled upon <a href="https://github.com/elitak/nixos-infect" rel="noopener external nofollow noreferrer">NixOS-Infect</a>, an installation script similar to the first approach of that gist. The script seems popular and may work better, although no one has tried it on Oracle Cloud yet.</p><h2 id="Build-a-kexec-tarball">Build a kexec tarball <a href="#Build-a-kexec-tarball" class="headerlink" title="Build a kexec tarball">§</a></h2><p>The working approach involved building a <a href="https://en.wikipedia.org/wiki/Kexec" rel="noopener external nofollow noreferrer">kexec</a> image using Nix&#x2F;NixOS. If you’re not using NixOS, the NixOS’ <a href="https://nixos.org/download.html#nixos-virtualbox" rel="noopener external nofollow noreferrer">VirtualBox image</a> works too. If you’re building inside a VM (of your local workstation, not Oracle Cloud), I recommend provisioning at least two CPUs as the operation is quite intensive.</p><p>Create the following *.nix file and <em>only</em> add your SSH key, do not modify other lines (especially <code>environment.systemPackages</code>) or it may not boot.</p><pre><div class="caption"><span>kexec.nix</span><a href="https://gist.github.com/misuzu/89fb064a2cc09c6a75dc9833bb3995bf#repartitioning-target-system-from-kexec-image" rel="noopener external nofollow noreferrer">source</a></div><code class="hljs nix">&#123; config, pkgs, ... &#125;:
&#123;
  <span class="hljs-attr">imports</span> = [
    <span class="hljs-comment"># this will work only under qemu, uncomment next line for full image</span>
    <span class="hljs-comment"># &lt;nixpkgs/nixos/modules/installer/netboot/netboot-minimal.nix&gt;</span>
    &lt;nixpkgs/nixos/modules/installer/netboot/netboot.nix&gt;
    &lt;nixpkgs/nixos/modules/profiles/qemu-guest.nix&gt;
  ];

  <span class="hljs-comment"># stripped down version of https://github.com/cleverca22/nix-tests/tree/master/kexec</span>
  system.<span class="hljs-attr">build</span> = <span class="hljs-keyword">rec</span> &#123;
    <span class="hljs-attr">image</span> = pkgs.runCommand <span class="hljs-string">&quot;image&quot;</span> &#123; <span class="hljs-attr">buildInputs</span> = [ pkgs.nukeReferences ]; &#125; <span class="hljs-string">&#x27;&#x27;</span>
<span class="hljs-string">      mkdir $out</span>
<span class="hljs-string">      cp <span class="hljs-subst">$&#123;config.system.build.kernel&#125;</span>/bzImage $out/kernel</span>
<span class="hljs-string">      cp <span class="hljs-subst">$&#123;config.system.build.netbootRamdisk&#125;</span>/initrd $out/initrd</span>
<span class="hljs-string">      nuke-refs $out/kernel</span>
<span class="hljs-string">    &#x27;&#x27;</span>;
    <span class="hljs-attr">kexec_script</span> = pkgs.writeTextFile &#123;
      <span class="hljs-attr">executable</span> = <span class="hljs-literal">true</span>;
      <span class="hljs-attr">name</span> = <span class="hljs-string">&quot;kexec-nixos&quot;</span>;
      <span class="hljs-attr">text</span> = <span class="hljs-string">&#x27;&#x27;</span>
<span class="hljs-string">        #!<span class="hljs-subst">$&#123;pkgs.stdenv.shell&#125;</span></span>
<span class="hljs-string">        set -e</span>
<span class="hljs-string">        <span class="hljs-subst">$&#123;pkgs.kexectools&#125;</span>/bin/kexec -l <span class="hljs-subst">$&#123;image&#125;</span>/kernel --initrd=<span class="hljs-subst">$&#123;image&#125;</span>/initrd --append=&quot;init=<span class="hljs-subst">$&#123;<span class="hljs-built_in">builtins</span>.unsafeDiscardStringContext config.system.build.toplevel&#125;</span>/init <span class="hljs-subst">$&#123;<span class="hljs-built_in">toString</span> config.boot.kernelParams&#125;</span>&quot;</span>
<span class="hljs-string">        sync</span>
<span class="hljs-string">        echo &quot;executing kernel, filesystems will be improperly umounted&quot;</span>
<span class="hljs-string">        <span class="hljs-subst">$&#123;pkgs.kexectools&#125;</span>/bin/kexec -e</span>
<span class="hljs-string">      &#x27;&#x27;</span>;
    &#125;;
    <span class="hljs-attr">kexec_tarball</span> = pkgs.callPackage &lt;nixpkgs/nixos/lib/make-system-tarball.nix&gt; &#123;
      <span class="hljs-attr">storeContents</span> = [
        &#123;
          <span class="hljs-attr">object</span> = config.system.build.kexec_script;
          <span class="hljs-attr">symlink</span> = <span class="hljs-string">&quot;/kexec_nixos&quot;</span>;
        &#125;
      ];
      <span class="hljs-attr">contents</span> = [ ];
    &#125;;
  &#125;;

  boot.initrd.<span class="hljs-attr">availableKernelModules</span> = [ <span class="hljs-string">&quot;ata_piix&quot;</span> <span class="hljs-string">&quot;uhci_hcd&quot;</span> ];
  boot.<span class="hljs-attr">kernelParams</span> = [
    <span class="hljs-string">&quot;panic=30&quot;</span> <span class="hljs-string">&quot;boot.panic_on_fail&quot;</span> <span class="hljs-comment"># reboot the machine upon fatal boot issues</span>
    <span class="hljs-string">&quot;console=ttyS0&quot;</span> <span class="hljs-comment"># enable serial console</span>
    <span class="hljs-string">&quot;console=tty1&quot;</span>
  ];
  boot.kernel.sysctl.<span class="hljs-string">&quot;vm.overcommit_memory&quot;</span> = <span class="hljs-string">&quot;1&quot;</span>;

  environment.<span class="hljs-attr">systemPackages</span> = <span class="hljs-keyword">with</span> pkgs; [ cryptsetup ];
  environment.variables.<span class="hljs-attr">GC_INITIAL_HEAP_SIZE</span> = <span class="hljs-string">&quot;1M&quot;</span>;

  networking.<span class="hljs-attr">hostName</span> = <span class="hljs-string">&quot;kexec&quot;</span>;

  services.mingetty.<span class="hljs-attr">autologinUser</span> = <span class="hljs-string">&quot;root&quot;</span>;
  services.<span class="hljs-attr">openssh</span> = &#123;
    <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-attr">challengeResponseAuthentication</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-attr">passwordAuthentication</span> = <span class="hljs-literal">false</span>;
  &#125;;

  users.users.root.openssh.authorizedKeys.<span class="hljs-attr">keys</span> = [
    <span class="hljs-comment"># add your ssh key here</span>
<mark>    <span class="hljs-string">&quot;ssh-ed25519 ....&quot;</span></mark>
  ];
&#125;</code><button class="copy-button">Copy</button></pre><p>Build the image:</p><pre><code class="hljs plaintext">nix-build &#x27;&lt;nixpkgs/nixos&gt;&#x27; -A config.system.build.kexec_tarball -I nixos-config=./kexec.nix</code><button class="copy-button">Copy</button></pre><p>The build will create <code>result/tarball/nixos-system-x86_64-linux.tar.xz</code> compressed kexec tarball. It took around 15 minutes for me. While waiting for the build to complete, let’s create an Ubuntu instance.</p><h2 id="Create-IAM-policy">Create IAM policy <a href="#Create-IAM-policy" class="headerlink" title="Create IAM policy">§</a></h2><blockquote><p>Skip this step if you prefer to use admin account</p></blockquote><p>I created a separate user with just enough permission to manage instances, VCN and boot volume backup.</p><pre><code class="hljs plaintext">Allow group InstanceLaunchers to manage instance-family in compartment ABC
Allow group InstanceLaunchers to read app-catalog-listing in compartment ABC
Allow group InstanceLaunchers to manage volume-family in compartment ABC
Allow group InstanceLaunchers to manage virtual-network-family in compartment ABC</code><button class="copy-button">Copy</button></pre><h2 id="Create-a-new-VCN">Create a new VCN <a href="#Create-a-new-VCN" class="headerlink" title="Create a new VCN">§</a></h2><blockquote><p>Skip this step if you’re not going to use custom SSH port nor Mosh</p></blockquote><p>Prior to launching a new instance, I created a VCN using VCN Wizard with a public and a private subnets. I created a security list (equivalent to NACL in AWS) and a network security group (equivalent to security group in AWS) to allow ingress&#x2F;incoming custom SSH port and <a href="https://mosh.org/" rel="noopener external nofollow noreferrer">Mosh</a> (UDP 60000-61000), detached the default security list from the public subnet and attached the newly created one. I also created a reserved IP.</p><h2 id="Launch-an-Ubuntu-instance">Launch an Ubuntu instance <a href="#Launch-an-Ubuntu-instance" class="headerlink" title="Launch an Ubuntu instance">§</a></h2><p>Launch a new instance with the following properties:</p><ul><li>Image: Ubuntu 20.04.1 minimal (any version &gt;&#x3D; 18.04 is fine)</li><li>Shape: Micro.VM</li><li>VCN: Create new or choose the VCN created in previous section<ul><li>Subnet: Public</li><li>Network security group: <em>optional, depends on your VCN</em></li><li>Public IP: none (we’ll assign the reserved IP later)</li></ul></li><li>SSH: Upload&#x2F;paste your SSH public key here</li></ul><p><code>iptables</code> is enabled by default in Oracle-provided image which only allow incoming SSH (TCP 22). If you prefer to use custom SSH port or want to use Mosh, you need to open the ports using cloud-init script (under Advanced Settings).</p><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/sh</span>

iptables -I INPUT 1 -p tcp --dport 1234 -j ACCEPT
sed -i <span class="hljs-string">&#x27;s/^#Port 22$/Port 1234/&#x27;</span> <span class="hljs-string">&quot;/etc/ssh/sshd_config&quot;</span>
systemctl restart ssh

<span class="hljs-comment"># Optional</span>
apt update
apt install -y mosh
iptables -I INPUT 1 -p udp --dport 60000:61000 -j ACCEPT</code><button class="copy-button">Copy</button></pre><p>While the instance is provisioning, navigate to its VNIC and edit its setting (3-dot to the right). Attach the previously reserved IP.</p><h2 id="Upload-kexec-tarball">Upload kexec tarball <a href="#Upload-kexec-tarball" class="headerlink" title="Upload kexec tarball">§</a></h2><p>Once the kexec is built, upload to the instance.</p><pre><code class="hljs plaintext">scp result/tarball/nixos-system-x86_64-linux.tar.xz ubuntu@somehost:/tmp/</code><button class="copy-button">Copy</button></pre><h3 id="Upload-to-Object-storage">Upload to Object storage <a href="#Upload-to-Object-storage" class="headerlink" title="Upload to Object storage">§</a></h3><p>Alternatively, you could also upload it to the Object Storage and then download it from the instance using Pre-Authenticated Request or Dynamic Groups IAM policy. The image is 300MB and it’s more reliable to upload using OCI CLI. OCI CLI splits large file into 100MB chunks (adjustable) for more reliable upload.</p><p>Note that multipart upload requires <code>OBJECT_OVERWRITE</code> permission which is not included in the <a href="https://docs.oracle.com/en-us/iaas/Content/Identity/Concepts/commonpolicies.htm#ariaid-title25" rel="noopener external nofollow noreferrer">Common Policy</a> example. IAM policy below enables multipart upload.</p><pre><code class="hljs plaintext">Allow group ObjectWriters to read buckets in compartment ABC

Allow group ObjectWriters to manage objects in compartment ABC where all &#123;target.bucket.name=&#x27;BucketA&#x27;, any &#123;request.permission=&#x27;OBJECT_READ&#x27;, request.permission=&#x27;OBJECT_CREATE&#x27;, request.permission=&#x27;OBJECT_INSPECT&#x27;, request.permission=&#x27;OBJECT_OVERWRITE&#x27;&#125;&#125;</code><button class="copy-button">Copy</button></pre><p>The above permission doesn’t include permission to create bucket, I’m assuming the bucket already created beforehand. <code>PAR_MANAGE</code> permission is required on both bucket and objects if you want to create pre-authenticated request. Once the policy is in place, upload using OCI CLI:</p><pre><code class="hljs plaintext">VM_DIR=&quot;/home/&lt;username&gt;/result/tarball&quot;
VM_FILE=&quot;nixos-system-x86_64-linux.tar.xz&quot;
# Namespace value is available on bucket details
NAMESPACE=&quot;xxx&quot;
BUCKET_NAME=&quot;BucketA&quot;

oci os object put -ns &quot;$&#123;NAMESPACE&#125;&quot; -bn &quot;$&#123;BUCKET_NAME&#125;&quot; --file &quot;&#123;VM_DIR&#125;/$&#123;VM_FILE&#125;&quot;</code><button class="copy-button">Copy</button></pre><h2 id="Execute-kexec-iamge">Execute kexec iamge <a href="#Execute-kexec-iamge" class="headerlink" title="Execute kexec iamge">§</a></h2><p>Once the instance has the kexec tarball, uncompress and execute it:</p><pre><code class="hljs plaintext">cd / &amp;&amp; sudo tar xf /tmp/nixos-system-x86_64-linux.tar.xz &amp;&amp; sudo /kexec_nixos
# wait until &quot;executing kernel, filesystems will be improperly umounted&quot; message is shown</code><button class="copy-button">Copy</button></pre><p>This launches a separate root shell. In your local machine, launch another shell and ssh into the kexec:</p><pre><code class="hljs plaintext">ssh root@somehost</code><button class="copy-button">Copy</button></pre><h2 id="Installation">Installation <a href="#Installation" class="headerlink" title="Installation">§</a></h2><p>This installation is slightly different from the <a href="/blog/2020/02/23/caddy-nixos-part-1/#Installation">usual steps</a>.</p><h3 id="Partition">Partition <a href="#Partition" class="headerlink" title="Partition">§</a></h3><p>The kexec tarball doesn’t include <code>parted</code> binary, so you have to make do with <code>fdisk</code>.</p><pre><code class="hljs plaintext">fdisk /dev/sda
Command: g
Created a new GPT disklabel (GUID: xxx).

# 512MB ESP
Command: n
Partition: 1
First sector: &lt;press Enter&gt;
Last sector: +512M

# root partition, leaving 1GB for swap
Command: n
Partition: 2
First sector: &lt;press Enter&gt;
Last sector: -1G

# 1GB swap
Command: n
Partition: 3
First sector: &lt;press Enter&gt;
Last sector: &lt;press Enter&gt;

# Mark first partition as ESP
Command: t
Partition: 1
Type: uefi

# Verify
Command: p
Disk /dev/sda: 46.58 GiB, 50010783744 bytes, 97677312 sectors
Disk model: BlockVolume     
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 4096 bytes
I/O size (minimum/optimal): 4096 bytes / 1048576 bytes
Disklabel type: gpt
Disk identifier: xxx

Device        Start      End  Sectors  Size Type
/dev/sda1      2048  1050623  1048576  512M EFI System
/dev/sda2   1050624 95580159 94529536 45.1G Linux filesystem
/dev/sda3  95580160 97677278  2097119 1024M Linux filesystem

# Write partition table
Command: w</code><button class="copy-button">Copy</button></pre><h3 id="Format-partitions">Format partitions <a href="#Format-partitions" class="headerlink" title="Format partitions">§</a></h3><pre><code class="hljs plaintext"># Format first partition as FAT32
mkfs.fat -F 32 -n boot /dev/sda1

# Format second partition as ext4 (can be xfs or btrfs) and label it as &#x27;nixos&#x27; (any label is fine)
mkfs.ext4 -L nixos /dev/sda2

# Swap partition
mkswap -L swap /dev/sda3</code><button class="copy-button">Copy</button></pre><h3 id="Mount-partitions">Mount partitions <a href="#Mount-partitions" class="headerlink" title="Mount partitions">§</a></h3><pre><code class="hljs plaintext">mkdir -p /mnt
mount /dev/disk/by-label/nixos /mnt
mkdir -p /mnt/boot
mount /dev/disk/by-label/boot /mnt/boot
swapon /dev/sda3</code><button class="copy-button">Copy</button></pre><h3 id="Configure-and-install">Configure and install <a href="#Configure-and-install" class="headerlink" title="Configure and install">§</a></h3><p>kexec doesn’t include a Nix channel (unlike the ISO), so you need to add it.</p><pre><code class="hljs plaintext"># Use newer channel if available
nix-channel --add https://nixos.org/channels/nixos-20.09 nixpkgs
nix-channel --update

nixos-generate-config --root /mnt
# set hostname, add users and ssh-keys, enable openssh/mosh
nano /mnt/etc/nixos/configuration.nix
nixos-install --no-root-passwd

shutdown -r now</code><button class="copy-button">Copy</button></pre><h3 id="Launch-a-redundant-instance">Launch a redundant instance <a href="#Launch-a-redundant-instance" class="headerlink" title="Launch a redundant instance">§</a></h3><p>Since Oracle offers two VMs, might as well take it. The second instance can be in the same VCN and subnet, but I put it in another VCN for network isolation (or just because I <em>can</em>). I also created another reserved IP for the second instance.</p><p>Launching a second redundant instance is easy:</p><ol><li>Create a boot volume backup of the first instance</li><li>Create a new boot volume from the backup<ul><li>(Update 5 April 2021): Boot volume created from backup somehow is not free, it charges <a href="https://www.oracle.com/cloud/price-list.html#storage" rel="noopener external nofollow noreferrer"><em>performance units</em></a>; you may be able to avoid this cost by cloning the boot volume instead. Alternatively, you can always create the volume from scratch.</li></ul></li><li>Launch a new instance using the second boot volume</li><li>Attach reserved IP to the instance</li></ol><blockquote><p>It’s recommended to launch instances in a separate fault domains to isolate server rack failure.</p></blockquote><p>Add the second instance’s IP to your DNS record, you now have <a href="https://en.wikipedia.org/wiki/Round-robin_DNS" rel="noopener external nofollow noreferrer">round-robin DNS</a> redundancy.</p><h2 id="Conclusion">Conclusion <a href="#Conclusion" class="headerlink" title="Conclusion">§</a></h2><p>The overall process was similar to mounting an ISO on a cloud instance and install from there, which I did in my previous VPS host. Although I would’ve preferred using the <em>official</em> method of importing a KVM image, but that involves uploading 2GB disk image. The kexec tarball approach only requires uploading a 300MB file. Maybe I’ll try creating a <a href="https://github.com/nix-community/nixos-generators/blob/master/formats/qcow.nix" rel="noopener external nofollow noreferrer">QCOW image</a> next time.</p><p>Summary of Oracle Cloud always free resource:</p><p>Pros:</p><ul><li>2 VMs</li><li>20TB egress</li><li>50GB volume&#x2F;instance</li></ul><p>Limitations:</p><ul><li>50Mbps Internet</li><li>One region (though you can choose any region during sign up)</li></ul></div><footer class="article-footer"><ul class="article-meta"><li><span class="label">Published Date:</span> <time class="dt-published" datetime="2021-03-09T00:00:00.000Z" itemprop="datePublished">9 <a href="/blog/2021/03/" title="See March 2021's posts">Mar</a> <a href="/blog/2021/" title="See 2021's posts">2021</a></time></li><li><span class="label">Tag:</span><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/" rel="tag">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nixos/" rel="tag">Nixos</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/oci/" rel="tag">Oci</a></li></ul></li><li><span class="label">Source:</span> <a href="https://gitlab.com/curben/blog/-/blob/master/source/_posts/nixos-oracle.md" rel="noopener external nofollow noreferrer">nixos-oracle.md</a></li><hr></ul></footer></div><nav id="article-nav" class="article-nav"><span class="article-nav-link-wrap newer"><strong>Newer</strong> <a href="/blog/2021/03/15/rsync-setup-nixos/"><div class="article-nav-title">rsync is surprisingly simple to setup</div></a></span><span class="article-nav-link-wrap older"><strong>Older</strong> <a href="/blog/2021/02/15/cloudflare-pages/"><div class="article-nav-title">Deploy Hexo to Cloudflare Pages</div></a></span></nav></article></div><footer id="footer" class="post-footer footer"><hr><div id="copyright" class="copyright">&copy; 2018-2024 Ming Di Leom. <a href="https://gitlab.com/curben/blog" rel="noopener external nofollow noreferrer">Powered by </a><a href="https://hexo.io/" rel="noopener external nofollow noreferrer">Hexo</a> with <a href="https://gitlab.com/curben/blog/tree/master/themes/chameleon" rel="noopener external nofollow noreferrer">Chameleon</a> theme.<br>Content is available under <a href="https://creativecommons.org/licenses/by-sa/4.0/" rel="noopener external nofollow noreferrer license" itemprop="license">CC-BY-SA 4.0</a>, unless indicated otherwise.<br><a class="main-nav-link" href="/disclaimer/">Disclaimer</a> <a class="main-nav-link" href="https://stats.uptimerobot.com/1394zup2LQ" rel="noopener external nofollow noreferrer">Status</a> <a class="main-nav-link" href="https://xw226dvxac7jzcpsf4xb64r4epr6o5hgn46dxlqk7gnjptakik6xnzqd.onion/" rel="noopener external nofollow noreferrer">Onion</a> <a class="main-nav-link" href="https://gitlab.com/curben/blog#mirrors" rel="noopener external nofollow noreferrer">Eepsite</a></div></footer><script src="/libs/clipboard-2.0.6.min.js" defer></script><script src="/js/copy-button.js"></script><script src="/js/chameleon.js"></script></body></html>