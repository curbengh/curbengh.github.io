<!DOCTYPE html><html lang="en-GB"><head><meta charset="utf-8"><title>Setup Cloudflare Argo Tunnel in NixOS | Ming Di Leom&#39;s Blog</title><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="canonical" href="https://mdleom.com/blog/2021/06/15/cloudflare-argo-nixos/"><meta name="description" content="No inbound port required"><meta property="article:author" content="Ming Di Leom"><meta property="article:tag" content="linux"><meta property="article:tag" content="server"><meta property="article:tag" content="caddy"><meta property="article:tag" content="nixos"><meta property="article:tag" content="cloudflare"><meta property="og:type" content="article"><meta property="og:title" content="Setup Cloudflare Argo Tunnel in NixOS"><meta property="og:url" content="https://mdleom.com/blog/2021/06/15/cloudflare-argo-nixos/"><meta property="og:site_name" content="Ming Di Leom&#39;s Blog"><meta property="og:description" content="No inbound port required"><meta property="og:locale" content="en_GB"><meta property="og:image" content="https://mdleom.com/screenshot/blog/2021/06/15/cloudflare-argo-nixos/"><meta property="article:published_time" content="2021-06-15T00:00:00.000Z"><link rel="alternate" href="/atom.xml" title="Ming Di Leom's Blog" type="application/atom+xml"><link rel="icon" href="/favicon.ico"><link rel="icon" href="/svg/favicon.svg" type="image/svg+xml" sizes="any"><link rel="apple-touch-icon" href="/apple-touch-icon-180x180.png"><link rel="manifest" href="/site.webmanifest"><link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml"><link rel="stylesheet" href="/css/chameleon.css"><meta name="yandex-verification" content="e026a03a5dd06730"><meta name="generator" content="Hexo 7.1.1"></head><body><div id="container" class="container"><article id="post-cloudflare-argo-nixos" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting"><header id="header" class="header"><nav class="main-nav"><a class="main-nav-link" href="/">Home</a> <a class="main-nav-link" href="/blog/">Blog</a> <a class="main-nav-link" href="/about/">About</a> <a class="main-nav-link" href="/atom.xml">Feed</a> <a class="main-nav-link" href="https://gitlab.com/curben/blog" rel="noopener external nofollow noreferrer">GitLab</a><div class="search-container"><form id="searchForm" method="post" action="https://duckduckgo.com/" rel="noopener external nofollow noreferrer" role="search"><input type="search" name="q" class="search-box" placeholder="Search..." title="Powered by DuckDuckGo" enterkeyhint="search"> <input type="hidden" name="sites" value="mdleom.com"> <input type="hidden" name="kd" value="-1"> <input type="hidden" name="kg" value="p"> <input type="hidden" name="kae" value="#000"> <a class="search-button" id="search-click"><img src="/svg/search.svg"></a></form></div></nav><nav class="mobile-nav"><a class="site-title" href="/">mdleom.com</a><ul class="mobile-nav-menu"><label for="mobile-menu-toggle"><a class="no-underline" id="menu-button">&#9776;</a></label> <input id="mobile-menu-toggle" type="checkbox"><ul id="mobile-nav-link"><div class="search-container"><form id="searchFormMob" method="post" action="https://duckduckgo.com/" rel="noopener external nofollow noreferrer" role="search"><input type="search" name="q" class="search-box" placeholder="Search..." title="Powered by DuckDuckGo" enterkeyhint="search"> <input type="hidden" name="sites" value="mdleom.com"> <input type="hidden" name="kd" value="-1"> <input type="hidden" name="kg" value="p"> <input type="hidden" name="kae" value="#000"> <a class="search-button" id="search-click-mobile"><img src="/svg/search.svg"></a></form></div><i>Powered by DuckDuckGo</i> <a class="mobile-nav-link-a" href="/">Home</a> <a class="mobile-nav-link-a" href="/blog/">Blog</a> <a class="mobile-nav-link-a" href="/about/">About</a> <a class="mobile-nav-link-a" href="/atom.xml">Feed</a> <a class="mobile-nav-link-a" href="https://gitlab.com/curben/blog" rel="noopener external nofollow noreferrer">GitLab</a></ul></ul></nav></header><hr class="header-hr"><div class="article-inner"><header class="article-header"><h1 class="p-name entry-title article-title" itemprop="headline name">Setup Cloudflare Argo Tunnel in NixOS <a id="btnshare"><img src="/svg/share.svg"></a></h1></header><p class="p-summary">No inbound port required</p><div class="e-content article-entry" itemprop="articleBody"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Setup"><span class="toc-text">Setup</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Create-a-new-tunnel"><span class="toc-text">Create a new tunnel</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Configure-the-tunnel"><span class="toc-text">Configure the tunnel</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Configure-NixOS"><span class="toc-text">Configure NixOS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Configure-Caddy"><span class="toc-text">Configure Caddy</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Custom-package-optional"><span class="toc-text">Custom package (optional)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Start-cloudflared"><span class="toc-text">Start cloudflared</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Create-a-CNAME-record"><span class="toc-text">Create a CNAME record</span></a></li></ol><p>Cloudflare Argo Tunnel enables a web server to serve websites over the public internet without opening an inbound port. With its built-in NAT traversal, a web server can even operate behind a NAT without resorting to port forwarding. The NAT traversal feature reminds me of Tor onion and I2P Eepsite, though the underlying connection is totally different.</p><p>It operates through a Cloudflare daemon (<a href="https://github.com/cloudflare/cloudflared" rel="noopener external nofollow noreferrer">cloudflared</a>) that a user installs in a server. The daemon creates outbound tunnel(s) to the CDN and forward incoming request to the local web server. It is available for free since April 2021. However, the latest NixOS at that time was 20.09 and it shipped an older version of the daemon that didn’t support static tunnel.</p><p><a href="https://blog.cloudflare.com/argo-tunnels-that-live-forever/" rel="noopener external nofollow noreferrer">Static tunnel</a> is a feature introduced in v2020.9.3 that associate a tunnel with a static subdomain (UUID.cfargotunnel.com) that a user can CNAME a website to; without this feature, cloudflared had to recreate DNS record every time a tunnel reconnects.</p><p>I can now use the newer daemon after my recent upgrade to <a href="/blog/2021/06/13/upgrade-note-nixos-21-05/" title="My upgrade note of NixOS 21.05">NixOS 21.05</a>.</p><h2 id="Setup">Setup <a href="#Setup" class="headerlink" title="Setup">§</a></h2><p>Generate a new cert.pem from <a href="https://dash.cloudflare.com/argotunnel" rel="noopener external nofollow noreferrer">dashboard</a>. This is only required to create a new tunnel. When creating a new tunnel, cloudflared also generate a credentials file (UUID.json) that you use to <em>run</em> a tunnel, so you don’t have upload the cert.pem to your server. Since tunnel can be created anywhere, you can do it from your workstation.</p><p>Grab the cloudflared binary from <a href="https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/installation" rel="noopener external nofollow noreferrer">Cloudflare</a> and make it executable without installing it to “&#x2F;usr&#x2F;bin”.</p><h2 id="Create-a-new-tunnel">Create a new tunnel <a href="#Create-a-new-tunnel" class="headerlink" title="Create a new tunnel">§</a></h2><p>This step can be done on your local machine, the actual installation on a server comes later. Once cloudflared binary and cert.pem are downloaded, proceed to creating a new tunnel.</p><pre><code class="hljs plaintext">./cloudflared tunnel --origincert cert.pem create mytunnel</code><button class="copy-button">Copy</button></pre><p>A new <em>UUID</em>.json will be generated in the current folder.</p><h2 id="Configure-the-tunnel">Configure the tunnel <a href="#Configure-the-tunnel" class="headerlink" title="Configure the tunnel">§</a></h2><p>Create a new yml file.</p><pre><code class="hljs yml"><span class="hljs-attr">tunnel:</span> <span class="hljs-string">mytunnel</span>
<span class="hljs-attr">credentials-file:</span> <span class="hljs-string">/var/lib/argoWeb/uuid.json</span>

<span class="hljs-comment"># Optional</span>
<span class="hljs-comment"># loglevel: warn</span>

<span class="hljs-attr">ingress:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">hostname:</span> <span class="hljs-string">mdleom.com</span>
    <span class="hljs-attr">service:</span> <span class="hljs-string">http://localhost:4430</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">hostname:</span> <span class="hljs-string">www.mdleom.com</span>
    <span class="hljs-attr">service:</span> <span class="hljs-string">http://localhost:4430</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">service:</span> <span class="hljs-string">http_status:404</span></code><button class="copy-button">Copy</button></pre><p>The last entry is intentionally left without a <code>hostname</code> key as required by cloudflared. Usually, it’s configured with <code>http_status:404</code> so cloudflared returns that status if there is no matching destination hostname for an incoming request. This can happen when say you have a foo.example.com DNS record that points to the daemon, so incoming request does reach the daemon, but either you forgot to configure the daemon to route the traffic to the actual foo.example.com web server or the web server is not running at all. In that case, the daemon will return a HTTP 404 status.</p><h2 id="Configure-NixOS">Configure NixOS <a href="#Configure-NixOS" class="headerlink" title="Configure NixOS">§</a></h2><p>Create a new user and group named “argoWeb” in the server.</p><pre><code class="hljs nix"><span class="hljs-attr">users</span> = &#123;
  <span class="hljs-attr">users</span> = &#123;
    <span class="hljs-attr">argoWeb</span> = &#123;
      <span class="hljs-attr">home</span> = <span class="hljs-string">&quot;/var/lib/argoWeb&quot;</span>;
      <span class="hljs-attr">createHome</span> = <span class="hljs-literal">true</span>;
      <span class="hljs-attr">isSystemUser</span> = <span class="hljs-literal">true</span>;
      <span class="hljs-attr">group</span> = <span class="hljs-string">&quot;argoWeb&quot;</span>;
    &#125;;
  &#125;;

  <span class="hljs-attr">groups</span> = &#123;
    caddyProxy.<span class="hljs-attr">members</span> = [ <span class="hljs-string">&quot;argoWeb&quot;</span> ];
  &#125;;
&#125;;</code><button class="copy-button">Copy</button></pre><p>Once <code>argoWeb</code> is created via nixos-rebuild, upload and move the json file to “&#x2F;var&#x2F;lib&#x2F;argoWeb” folder. <code>chown argoWeb:argoWeb</code> and <code>chmod 600</code> that file.</p><p>Then, Create a new nix file; in this case, I’m using “&#x2F;etc&#x2F;caddy&#x2F;“ folder (where I put other *.nix files):</p><pre><div class="caption"><span>/etc/caddy/argoWeb.nix</span></div><code class="hljs nix">&#123; config, lib, pkgs, ... &#125;:

<span class="hljs-keyword">with</span> lib;

<span class="hljs-keyword">let</span>
  <span class="hljs-attr">cfg</span> = config.services.argoWeb;
<span class="hljs-keyword">in</span> &#123;
  options.services.<span class="hljs-attr">argoWeb</span> = &#123;
    <span class="hljs-attr">enable</span> = mkEnableOption <span class="hljs-string">&quot;Cloudflare Argo Tunnel&quot;</span>;

    <span class="hljs-attr">config</span> = mkOption &#123;
      <span class="hljs-attr">default</span> = <span class="hljs-string">&quot;/etc/caddy/argoWeb.yml&quot;</span>;
      <span class="hljs-attr">type</span> = types.str;
      <span class="hljs-attr">description</span> = <span class="hljs-string">&quot;Path to cloudflared config&quot;</span>;
    &#125;;

    <span class="hljs-attr">dataDir</span> = mkOption &#123;
      <span class="hljs-attr">default</span> = <span class="hljs-string">&quot;/var/lib/argoWeb&quot;</span>;
      <span class="hljs-attr">type</span> = types.path;
      <span class="hljs-attr">description</span> = <span class="hljs-string">&#x27;&#x27;</span>
<span class="hljs-string">        The data directory, for storing credentials.</span>
<span class="hljs-string">      &#x27;&#x27;</span>;
    &#125;;

    <span class="hljs-attr">package</span> = mkOption &#123;
      <span class="hljs-attr">default</span> = pkgs.cloudflared;
      <span class="hljs-attr">defaultText</span> = <span class="hljs-string">&quot;pkgs.cloudflared&quot;</span>;
      <span class="hljs-attr">type</span> = types.package;
      <span class="hljs-attr">description</span> = <span class="hljs-string">&quot;cloudflared package to use.&quot;</span>;
    &#125;;
  &#125;;

  <span class="hljs-attr">config</span> = mkIf cfg.enable &#123;
    systemd.services.<span class="hljs-attr">argoWeb</span> = &#123;
      <span class="hljs-attr">description</span> = <span class="hljs-string">&quot;Cloudflare Argo Tunnel&quot;</span>;
      <span class="hljs-attr">after</span> = [ <span class="hljs-string">&quot;network-online.target&quot;</span> ];
      <span class="hljs-attr">wants</span> = [ <span class="hljs-string">&quot;network-online.target&quot;</span> ]; <span class="hljs-comment"># systemd-networkd-wait-online.service</span>
      <span class="hljs-attr">wantedBy</span> = [ <span class="hljs-string">&quot;multi-user.target&quot;</span> ];
      <span class="hljs-attr">serviceConfig</span> = &#123;
        <span class="hljs-attr">ExecStart</span> = <span class="hljs-string">&quot;<span class="hljs-subst">$&#123;cfg.package&#125;</span>/bin/cloudflared --config <span class="hljs-subst">$&#123;cfg.config&#125;</span> --no-autoupdate tunnel run&quot;</span>;
        <span class="hljs-attr">Type</span> = <span class="hljs-string">&quot;simple&quot;</span>;
        <span class="hljs-attr">User</span> = <span class="hljs-string">&quot;argoWeb&quot;</span>;
        <span class="hljs-attr">Group</span> = <span class="hljs-string">&quot;argoWeb&quot;</span>;
        <span class="hljs-attr">Restart</span> = <span class="hljs-string">&quot;on-failure&quot;</span>;
        <span class="hljs-attr">RestartSec</span> = <span class="hljs-string">&quot;5s&quot;</span>;
        <span class="hljs-attr">NoNewPrivileges</span> = <span class="hljs-literal">true</span>;
        <span class="hljs-attr">LimitNPROC</span> = <span class="hljs-number">512</span>;
        <span class="hljs-attr">LimitNOFILE</span> = <span class="hljs-number">1048576</span>;
        <span class="hljs-attr">PrivateTmp</span> = <span class="hljs-literal">true</span>;
        <span class="hljs-attr">PrivateDevices</span> = <span class="hljs-literal">true</span>;
        <span class="hljs-attr">ProtectHome</span> = <span class="hljs-literal">true</span>;
        <span class="hljs-attr">ProtectSystem</span> = <span class="hljs-string">&quot;full&quot;</span>;
        <span class="hljs-attr">ReadWriteDirectories</span> = cfg.dataDir;
      &#125;;
    &#125;;
  &#125;;
&#125;</code><button class="copy-button">Copy</button></pre><p>Move the yml file to “&#x2F;etc&#x2F;caddy&#x2F;“ and set both yml and nix files to be <code>chown root:root</code> and <code>chmod 644</code>.</p><h2 id="Configure-Caddy">Configure Caddy <a href="#Configure-Caddy" class="headerlink" title="Configure Caddy">§</a></h2><p>Bind the web server to localhost (“127.0.0.1” or “::1”) and <em>optionally</em> disable the tls. If Cloudflare’s authenticated origin pull (client authentication) is configured, that should still work if you prefer to leave tls on, though I haven’t test it. You don’t have to bind it to localhost if you insist so, but it defeats the security purpose of Argo.</p><pre><code class="hljs Caddyfile">mdleom.com:4430 www.mdleom.com:4430 &#123;
  bind 127.0.0.1

  tls /var/lib/caddyProxy/mdleom.com.pem /var/lib/caddyProxy/mdleom.com.key &#123;
    protocols tls1.3
    client_auth &#123;
      mode require_and_verify
      trusted_ca_cert_file /var/lib/caddyProxy/origin-pull-ca.pem
    &#125;
  &#125;
&#125;</code><button class="copy-button">Copy</button></pre><p>Restart&#x2F;reload Caddy for the changed config to take effect.</p><h2 id="Custom-package-optional">Custom package (optional) <a href="#Custom-package-optional" class="headerlink" title="Custom package (optional)">§</a></h2><p>If your NixOS instance is IPv6-only, you may want to use a <a href="/blog/2021/07/02/custom-package-nixos-module/" title="Using custom package in a NixOS module">custom package</a>. <a href="https://search.nixos.org/packages?channel=21.11&from=0&size=50&sort=relevance&type=packages&query=cloudflared" rel="noopener external nofollow noreferrer"><code>pkgs.cloudflared</code></a> is installed by compiling the source from the <a href="https://github.com/cloudflare/cloudflared" rel="noopener external nofollow noreferrer">GitHub repo</a>, instead of using a cached binary from Nix repo. cloudflared’s license restricts the distribution of binary, hence the need of source compilation. However, GitHub doesn’t support IPv6 yet, so we need to clone its repo to other Git repo that supports IPv6 and then download it from there.</p><h2 id="Start-cloudflared">Start cloudflared <a href="#Start-cloudflared" class="headerlink" title="Start cloudflared">§</a></h2><pre><code class="hljs nix"><span class="hljs-attr">require</span> = [
  /etc/caddy/argoWeb.nix
];
<span class="hljs-comment"># cloudflared is not distributed via a free software license</span>
nixpkgs.config.<span class="hljs-attr">allowUnfree</span> = <span class="hljs-literal">true</span>;
services.<span class="hljs-attr">argoWeb</span> = &#123;
  <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">config</span> = <span class="hljs-string">&quot;/etc/caddy/argoWeb.yml&quot;</span>;
  <span class="hljs-comment"># custom package</span>
  <span class="hljs-comment"># package = pkgs.callPackage (import /etc/caddy/cloudflared-custom.nix) &#123; &#125;;</span>
&#125;;</code><button class="copy-button">Copy</button></pre><h2 id="Create-a-CNAME-record">Create a CNAME record <a href="#Create-a-CNAME-record" class="headerlink" title="Create a CNAME record">§</a></h2><p>The last step is to create a new DNS record to CNAME the relevant hostname to <em>UUID</em>.cfargotunnel.com . Existing A&#x2F;CNAME must be removed beforehand since a hostname cannot have both A and CNAME records at the same time, nor having two similar CNAMEs.</p></div><footer class="article-footer"><ul class="article-meta"><li><span class="label">Published Date:</span> <time class="dt-published" datetime="2021-06-15T00:00:00.000Z" itemprop="datePublished">15 <a href="/blog/2021/06/" title="See June 2021's posts">Jun</a> <a href="/blog/2021/" title="See 2021's posts">2021</a></time></li><li><span class="label">Tag:</span><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/caddy/" rel="tag">Caddy</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cloudflare/" rel="tag">Cloudflare</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/" rel="tag">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nixos/" rel="tag">Nixos</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/server/" rel="tag">Server</a></li></ul></li><li><span class="label">Source:</span> <a href="https://gitlab.com/curben/blog/-/blob/master/source/_posts/cloudflare-argo-nixos.md" rel="noopener external nofollow noreferrer">cloudflare-argo-nixos.md</a></li><hr></ul></footer></div><nav id="article-nav" class="article-nav"><span class="article-nav-link-wrap newer"><strong>Newer</strong> <a href="/blog/2021/06/27/aws-waf/"><div class="article-nav-title">Convert AWS WAF ACLs to human-readable format</div></a></span><span class="article-nav-link-wrap older"><strong>Older</strong> <a href="/blog/2021/06/13/upgrade-note-nixos-21-05/"><div class="article-nav-title">My upgrade note of NixOS 21.05</div></a></span></nav></article></div><footer id="footer" class="post-footer footer"><hr><div id="copyright" class="copyright">&copy; 2018-2024 Ming Di Leom. <a href="https://gitlab.com/curben/blog" rel="noopener external nofollow noreferrer">Powered by </a><a href="https://hexo.io/" rel="noopener external nofollow noreferrer">Hexo</a> with <a href="https://gitlab.com/curben/blog/tree/master/themes/chameleon" rel="noopener external nofollow noreferrer">Chameleon</a> theme.<br>Content is available under <a href="https://creativecommons.org/licenses/by-sa/4.0/" rel="noopener external nofollow noreferrer license" itemprop="license">CC-BY-SA 4.0</a>, unless indicated otherwise.<br><a class="main-nav-link" href="/disclaimer/">Disclaimer</a> <a class="main-nav-link" href="https://stats.uptimerobot.com/1394zup2LQ" rel="noopener external nofollow noreferrer">Status</a> <a class="main-nav-link" href="https://xw226dvxac7jzcpsf4xb64r4epr6o5hgn46dxlqk7gnjptakik6xnzqd.onion/" rel="noopener external nofollow noreferrer">Onion</a> <a class="main-nav-link" href="https://gitlab.com/curben/blog#mirrors" rel="noopener external nofollow noreferrer">Eepsite</a></div></footer><script src="/libs/clipboard-2.0.6.min.js" defer></script><script src="/js/copy-button.js"></script><script src="/js/chameleon.js"></script></body></html>