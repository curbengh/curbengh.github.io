<!DOCTYPE html><html lang="en-GB"><head><meta charset="utf-8"><title>Using custom package in a NixOS module | Ming Di Leom&#39;s Blog</title><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="canonical" href="https://mdleom.com/blog/2021/07/02/custom-package-nixos-module/"><meta name="description" content="A workaround for installing GitHub-hosted package in a IPv6-only host"><meta property="article:author" content="Ming Di Leom"><meta property="article:tag" content="nixos"><meta property="og:type" content="article"><meta property="og:title" content="Using custom package in a NixOS module"><meta property="og:url" content="https://mdleom.com/blog/2021/07/02/custom-package-nixos-module/"><meta property="og:site_name" content="Ming Di Leom&#39;s Blog"><meta property="og:description" content="A workaround for installing GitHub-hosted package in a IPv6-only host"><meta property="og:locale" content="en_GB"><meta property="og:image" content="https://mdleom.com/screenshot/blog/2021/07/02/custom-package-nixos-module/"><meta property="article:published_time" content="2021-07-02T00:00:00.000Z"><link rel="alternate" href="/atom.xml" title="Ming Di Leom's Blog" type="application/atom+xml"><link rel="icon" href="/favicon.ico"><link rel="icon" href="/svg/favicon.svg" type="image/svg+xml" sizes="any"><link rel="apple-touch-icon" href="/apple-touch-icon-180x180.png"><link rel="manifest" href="/site.webmanifest"><link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml"><link rel="stylesheet" href="/css/chameleon.css"><meta name="yandex-verification" content="e026a03a5dd06730"><meta name="generator" content="Hexo 7.1.1"></head><body><div id="container" class="container"><article id="post-custom-package-nixos-module" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting"><header id="header" class="header"><nav class="main-nav"><a class="main-nav-link" href="/">Home</a> <a class="main-nav-link" href="/blog/">Blog</a> <a class="main-nav-link" href="/about/">About</a> <a class="main-nav-link" href="/atom.xml">Feed</a> <a class="main-nav-link" href="https://gitlab.com/curben/blog" rel="noopener external nofollow noreferrer">GitLab</a><div class="search-container"><form id="searchForm" method="post" action="https://duckduckgo.com/" rel="noopener external nofollow noreferrer" role="search"><input type="search" name="q" class="search-box" placeholder="Search..." title="Powered by DuckDuckGo" enterkeyhint="search"> <input type="hidden" name="sites" value="mdleom.com"> <input type="hidden" name="kd" value="-1"> <input type="hidden" name="kg" value="p"> <input type="hidden" name="kae" value="#000"> <a class="search-button" id="search-click"><img src="/svg/search.svg"></a></form></div></nav><nav class="mobile-nav"><a class="site-title" href="/">mdleom.com</a><ul class="mobile-nav-menu"><label for="mobile-menu-toggle"><a class="no-underline" id="menu-button">&#9776;</a></label> <input id="mobile-menu-toggle" type="checkbox"><ul id="mobile-nav-link"><div class="search-container"><form id="searchFormMob" method="post" action="https://duckduckgo.com/" rel="noopener external nofollow noreferrer" role="search"><input type="search" name="q" class="search-box" placeholder="Search..." title="Powered by DuckDuckGo" enterkeyhint="search"> <input type="hidden" name="sites" value="mdleom.com"> <input type="hidden" name="kd" value="-1"> <input type="hidden" name="kg" value="p"> <input type="hidden" name="kae" value="#000"> <a class="search-button" id="search-click-mobile"><img src="/svg/search.svg"></a></form></div><i>Powered by DuckDuckGo</i> <a class="mobile-nav-link-a" href="/">Home</a> <a class="mobile-nav-link-a" href="/blog/">Blog</a> <a class="mobile-nav-link-a" href="/about/">About</a> <a class="mobile-nav-link-a" href="/atom.xml">Feed</a> <a class="mobile-nav-link-a" href="https://gitlab.com/curben/blog" rel="noopener external nofollow noreferrer">GitLab</a></ul></ul></nav></header><hr class="header-hr"><div class="article-inner"><header class="article-header"><h1 class="p-name entry-title article-title" itemprop="headline name">Using custom package in a NixOS module <a id="btnshare"><img src="/svg/share.svg"></a></h1></header><p class="p-summary">A workaround for installing GitHub-hosted package in a IPv6-only host</p><div class="e-content article-entry" itemprop="articleBody"><p>I recently setup <a href="/blog/2021/06/15/cloudflare-argo-nixos/" title="Setup Cloudflare Argo Tunnel in NixOS">cloudflared</a> on instances that power this website, while I got it working on most of them, it’s not working on IPv6-only instance. There was installation guide which I managed to resolve later (and what this post is about) and Cloudflare tunnel itself <a href="https://github.com/cloudflare/cloudflared/issues/401" rel="noopener external nofollow noreferrer">doesn’t support</a> IPv6 yet.</p><p>A quick recap on two of the main components of NixOS: module and package. A package is a program that is available on NixOS repository, the repo doesn’t contain the binary, it’s made up of nix files that describe <em>how</em> to compile it. In this case, <a href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/applications/networking/cloudflared/default.nix" rel="noopener external nofollow noreferrer">cloudflared.nix</a> is a script to download the source code from <a href="https://github.com/cloudflare/cloudflared" rel="noopener external nofollow noreferrer">GitHub</a> and compile it as a Go program.</p><p>A module is (usually) used to install a program as a service and make it configurable via <code>configuration.nix</code>. For example, <a href="https://github.com/NixOS/nixpkgs/blob/master/nixos/modules/services/networking/i2pd.nix" rel="noopener external nofollow noreferrer">i2pd.nix</a> module installs i2pd package (<a href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/tools/networking/i2pd/default.nix" rel="noopener external nofollow noreferrer"><code>pkgs.i2pd</code></a>) when <code>services.i2pd.enable</code> is enabled.</p><p>A major issue is that GitHub <a href="https://github.community/t/github-on-the-ipv6-internet/2794/14" rel="noopener external nofollow noreferrer">doesn’t support</a> IPv6 yet, so my IPv6-only instance couldn’t download the source code. A common workaround is to mirror the repo somewhere else that does support IPv6, which is what I did. Then, I created a new custom package nix:</p><pre><div class="caption"><span>cloudflared-custom.nix</span><a href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/applications/networking/cloudflared/default.nix" rel="noopener external nofollow noreferrer">source</a></div><code class="hljs nix">&#123; lib, buildGoModule, fetchgit &#125;:

buildGoModule <span class="hljs-keyword">rec</span> &#123;
  <span class="hljs-attr">pname</span> = <span class="hljs-string">&quot;cloudflared&quot;</span>;
  <span class="hljs-attr">version</span> = <span class="hljs-string">&quot;2021.6.0&quot;</span>;

  <span class="hljs-attr">src</span> = fetchgit &#123;
<mark>    <span class="hljs-attr">url</span>    = <span class="hljs-string">&quot;https://example.com/example/cloudflared-mirror.git&quot;</span>;</mark>
    <span class="hljs-attr">rev</span>    = <span class="hljs-string">&quot;refs/tags/<span class="hljs-subst">$&#123;version&#125;</span>&quot;</span>;
    <span class="hljs-attr">sha256</span> = <span class="hljs-string">&quot;sha256-cX0kdBPDgwjHphxGWrnXohHPp1nzs4SnvCry4AxMtp0=&quot;</span>;
  &#125;;

  <span class="hljs-attr">vendorSha256</span> = <span class="hljs-literal">null</span>;

  <span class="hljs-attr">doCheck</span> = <span class="hljs-literal">false</span>;

  <span class="hljs-attr">buildFlagsArray</span> = <span class="hljs-string">&quot;-ldflags=-X main.Version=<span class="hljs-subst">$&#123;version&#125;</span>&quot;</span>;

  <span class="hljs-attr">meta</span> = <span class="hljs-keyword">with</span> lib; &#123;
    <span class="hljs-attr">description</span> = <span class="hljs-string">&quot;CloudFlare Argo Tunnel daemon (and DNS-over-HTTPS client)&quot;</span>;
    <span class="hljs-attr">homepage</span>    = <span class="hljs-string">&quot;https://www.cloudflare.com/products/argo-tunnel&quot;</span>;
    <span class="hljs-attr">license</span>     = licenses.unfree;
    <span class="hljs-attr">platforms</span>   = platforms.unix;
    <span class="hljs-attr">maintainers</span> = [ maintainers.thoughtpolice maintainers.enorris ];
  &#125;;
&#125;</code><button class="copy-button">Copy</button></pre><p>In my <a href="/blog/2021/06/15/cloudflare-argo-nixos/" title="Setup Cloudflare Argo Tunnel in NixOS">cloudflared module</a>, I updated the following lines:</p><pre><code class="hljs diff">  options.services.argoWeb = &#123;
    enable = mkEnableOption &quot;Cloudflare Argo Tunnel&quot;;

    config = mkOption &#123;
      default = &quot;/etc/caddy/argoWeb.yml&quot;;
      type = types.str;
      description = &quot;Path to cloudflared config&quot;;
    &#125;;

    dataDir = mkOption &#123;
      default = &quot;/var/lib/argoWeb&quot;;
      type = types.path;
      description = &#x27;&#x27;
        The data directory, for storing credentials.
      &#x27;&#x27;;
    &#125;;

<span class="hljs-addition">+    package = mkOption &#123;</span>
<span class="hljs-addition">+      default = pkgs.cloudflared;</span>
<span class="hljs-addition">+      defaultText = &quot;pkgs.cloudflared&quot;;</span>
<span class="hljs-addition">+      type = types.package;</span>
<span class="hljs-addition">+      description = &quot;cloudflared package to use.&quot;;</span>
<span class="hljs-addition">+    &#125;;</span>
  &#125;;

<span class="hljs-deletion">-        ExecStart = &quot;$&#123;pkgs.cloudflared&#125;/bin/cloudflared --config $&#123;cfg.config&#125; --no-autoupdate tunnel run&quot;;</span>
<span class="hljs-addition">+        ExecStart = &quot;$&#123;cfg.package&#125;/bin/cloudflared --config $&#123;cfg.config&#125; --no-autoupdate tunnel run&quot;;</span></code><button class="copy-button">Copy</button></pre><p>Finally, in my <code>configuration.nix</code>, I configured it to use the custom package:</p><pre><code class="hljs diff">  require = [
    /etc/caddy/argoWeb.nix
  ];

  nixpkgs.config.allowUnfree = true;
  services.argoWeb = &#123;
    enable = true;
<span class="hljs-addition">+    package = pkgs.callPackage (import /etc/caddy/cloudflared-custom.nix) &#123; &#125;;</span>
    config = &quot;/etc/caddy/argoWeb.yml&quot;;
  &#125;;</code><button class="copy-button">Copy</button></pre></div><footer class="article-footer"><ul class="article-meta"><li><span class="label">Published Date:</span> <time class="dt-published" datetime="2021-07-02T00:00:00.000Z" itemprop="datePublished">2 <a href="/blog/2021/07/" title="See July 2021's posts">Jul</a> <a href="/blog/2021/" title="See 2021's posts">2021</a></time></li><li><span class="label">Tag:</span><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nixos/" rel="tag">Nixos</a></li></ul></li><li><span class="label">Source:</span> <a href="https://gitlab.com/curben/blog/-/blob/master/source/_posts/custom-package-nixos-module.md" rel="noopener external nofollow noreferrer">custom-package-nixos-module.md</a></li><hr></ul></footer></div><nav id="article-nav" class="article-nav"><span class="article-nav-link-wrap newer"><strong>Newer</strong> <a href="/blog/2021/07/04/ecdsa-tls-tor-caddy/"><div class="article-nav-title">Get a ECDSA TLS certificate for your onion service</div></a></span><span class="article-nav-link-wrap older"><strong>Older</strong> <a href="/blog/2021/06/27/aws-waf/"><div class="article-nav-title">Convert AWS WAF ACLs to human-readable format</div></a></span></nav></article></div><footer id="footer" class="post-footer footer"><hr><div id="copyright" class="copyright">&copy; 2018-2024 Ming Di Leom. <a href="https://gitlab.com/curben/blog" rel="noopener external nofollow noreferrer">Powered by </a><a href="https://hexo.io/" rel="noopener external nofollow noreferrer">Hexo</a> with <a href="https://gitlab.com/curben/blog/tree/master/themes/chameleon" rel="noopener external nofollow noreferrer">Chameleon</a> theme.<br>Content is available under <a href="https://creativecommons.org/licenses/by-sa/4.0/" rel="noopener external nofollow noreferrer license" itemprop="license">CC-BY-SA 4.0</a>, unless indicated otherwise.<br><a class="main-nav-link" href="/disclaimer/">Disclaimer</a> <a class="main-nav-link" href="https://stats.uptimerobot.com/1394zup2LQ" rel="noopener external nofollow noreferrer">Status</a> <a class="main-nav-link" href="https://xw226dvxac7jzcpsf4xb64r4epr6o5hgn46dxlqk7gnjptakik6xnzqd.onion/" rel="noopener external nofollow noreferrer">Onion</a> <a class="main-nav-link" href="https://gitlab.com/curben/blog#mirrors" rel="noopener external nofollow noreferrer">Eepsite</a></div></footer><script src="/libs/clipboard-2.0.6.min.js" defer></script><script src="/js/copy-button.js"></script><script src="/js/chameleon.js"></script></body></html>