<!DOCTYPE html><html lang="en-GB"><head><meta charset="utf-8"><title>Get a ECDSA TLS certificate for your onion service | Ming Di Leom&#39;s Blog</title><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="canonical" href="https://mdleom.com/blog/2021/07/04/ecdsa-tls-tor-caddy/"><meta name="description" content="TLS cert for mere mortal"><meta property="article:author" content="Ming Di Leom"><meta property="article:tag" content="caddy"><meta property="article:tag" content="tor"><meta property="og:type" content="article"><meta property="og:title" content="Get a ECDSA TLS certificate for your onion service"><meta property="og:url" content="https://mdleom.com/blog/2021/07/04/ecdsa-tls-tor-caddy/"><meta property="og:site_name" content="Ming Di Leom&#39;s Blog"><meta property="og:description" content="TLS cert for mere mortal"><meta property="og:locale" content="en_GB"><meta property="og:image" content="https://mdleom.com/screenshot/blog/2021/07/04/ecdsa-tls-tor-caddy/"><meta property="article:published_time" content="2021-07-04T00:00:00.000Z"><link rel="alternate" href="/atom.xml" title="Ming Di Leom's Blog" type="application/atom+xml"><link rel="icon" href="/favicon.ico"><link rel="icon" href="/svg/favicon.svg" type="image/svg+xml" sizes="any"><link rel="apple-touch-icon" href="/apple-touch-icon-180x180.png"><link rel="manifest" href="/site.webmanifest"><link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml"><link rel="stylesheet" href="/css/chameleon.css"><meta name="yandex-verification" content="e026a03a5dd06730"><meta name="generator" content="Hexo 7.1.1"></head><body><div id="container" class="container"><article id="post-ecdsa-tls-tor-caddy" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting"><header id="header" class="header"><nav class="main-nav"><a class="main-nav-link" href="/">Home</a> <a class="main-nav-link" href="/blog/">Blog</a> <a class="main-nav-link" href="/about/">About</a> <a class="main-nav-link" href="/atom.xml">Feed</a> <a class="main-nav-link" href="https://gitlab.com/curben/blog" rel="noopener external nofollow noreferrer">GitLab</a><div class="search-container"><form id="searchForm" method="post" action="https://duckduckgo.com/" rel="noopener external nofollow noreferrer" role="search"><input type="search" name="q" class="search-box" placeholder="Search..." title="Powered by DuckDuckGo" enterkeyhint="search"> <input type="hidden" name="sites" value="mdleom.com"> <input type="hidden" name="kd" value="-1"> <input type="hidden" name="kg" value="p"> <input type="hidden" name="kae" value="#000"> <a class="search-button" id="search-click"><img src="/svg/search.svg"></a></form></div></nav><nav class="mobile-nav"><a class="site-title" href="/">mdleom.com</a><ul class="mobile-nav-menu"><label for="mobile-menu-toggle"><a class="no-underline" id="menu-button">&#9776;</a></label> <input id="mobile-menu-toggle" type="checkbox"><ul id="mobile-nav-link"><div class="search-container"><form id="searchFormMob" method="post" action="https://duckduckgo.com/" rel="noopener external nofollow noreferrer" role="search"><input type="search" name="q" class="search-box" placeholder="Search..." title="Powered by DuckDuckGo" enterkeyhint="search"> <input type="hidden" name="sites" value="mdleom.com"> <input type="hidden" name="kd" value="-1"> <input type="hidden" name="kg" value="p"> <input type="hidden" name="kae" value="#000"> <a class="search-button" id="search-click-mobile"><img src="/svg/search.svg"></a></form></div><i>Powered by DuckDuckGo</i> <a class="mobile-nav-link-a" href="/">Home</a> <a class="mobile-nav-link-a" href="/blog/">Blog</a> <a class="mobile-nav-link-a" href="/about/">About</a> <a class="mobile-nav-link-a" href="/atom.xml">Feed</a> <a class="mobile-nav-link-a" href="https://gitlab.com/curben/blog" rel="noopener external nofollow noreferrer">GitLab</a></ul></ul></nav></header><hr class="header-hr"><div class="article-inner"><header class="article-header"><h1 class="p-name entry-title article-title" itemprop="headline name">Get a ECDSA TLS certificate for your onion service <a id="btnshare"><img src="/svg/share.svg"></a></h1></header><p class="p-summary">TLS cert for mere mortal</p><div class="e-content article-entry" itemprop="articleBody"><p>While reading through Tor blog, there was <a href="https://blog.torproject.org/tls-certificate-for-onion-site" rel="noopener external nofollow noreferrer">a post</a> back in March 2021 to announce HARICA, a root CA operator, has started selling <code>.onion</code> TLS certificate. The cert is of domain validation (DV) type, significantly easier to purchase and cheaper than Digicert’s extended validation (EV) cert, which was previously the only CA that supports .onion.</p><p>The post links to an <a href="https://kushaldas.in/posts/get-a-tls-certificate-for-your-onion-service.html" rel="noopener external nofollow noreferrer">excellent tutorial</a>. Different from the tutorial, I prefer to use ECDSA cert than RSA, just like Cloudflare’s cert. It includes nginx config, whereas I’m using Caddy web server.</p><ol><li>Create a new <a href="https://cm.harica.gr/" rel="noopener external nofollow noreferrer">Cert Manager</a> account in HARICA.</li><li>From the Server Certificate on the left sidebar, create a new request for your onion address.</li><li>HARICA can generate a Certificate Signing Request (CSR) on your behalf, but I prefer to use an OpenSSL-generated CSR, so I generated and uploaded one.</li><li>To generate a CSR using OpenSSL:</li></ol><pre><code class="hljs plaintext"># Generate an elliptic-curve private key
$ openssl ecparam -name prime256v1 -genkey -noout -out myonion.key
# prime256v1 is also used by Cloudflare

# Generate a CSR
$ openssl req -new -key myonion.key -out myonion.csr
# Leave everything blank by entering a dot (.), except for Common Name (CN)
# Enter your onion address in CN field</code><button class="copy-button">Copy</button></pre><ol start="5"><li>DV cert only requires a valid CN field, it’s <em>optional</em> to enter personal details in the CSR.</li><li>Back in Cert Manager, choose “upload a text file to a location on your web server” as the validation option. This option enables you to get wildcard (*.onion.com) cert, necessary if you have subdomain(s) under your onion service.</li><li>Instead of uploading a file to web server, I use <a href="https://caddyserver.com/docs/caddyfile/directives/respond" rel="noopener external nofollow noreferrer"><code>respond</code></a> instead.</li></ol><pre><code class="hljs Caddyfile">http://xw226dvxac7jzcpsf4xb64r4epr6o5hgn46dxlqk7gnjptakik6xnzqd.onion:8080 &#123;
  bind ::1

  # Harica CA domain validation
<mark>  @harica path /.well-known/pki-validation/xxx</mark>
<mark>  respond @harica &quot;yyy&quot;</mark>
&#125;</code><button class="copy-button">Copy</button></pre><ol start="8"><li><p>Restart Caddy and check the path has correct response. &#96;curl <a href="http://localhost:8080/.well-known/pki-validation/xxx" rel="noopener external nofollow noreferrer">http://localhost:8080/.well-known/pki-validation/xxx</a> -H “Host: your-onion.onion”</p></li><li><p>After HARICA verified my onion, I received an email notification that it’s ready for purchase and download.</p></li><li><p>Download the PEM bundle.</p><ul><li>HARICA is <a href="https://news.harica.gr/article/2021_harica_tls_roots/" rel="noopener external nofollow noreferrer">transitioning</a> to new root certs. For compatibility with older browsers that have not include the latest root certs yet, the PEM bundle needs to include a cross-cert.</li><li>To download the cross-cert, heads to <a href="https://repo.harica.gr/rep_dyn.php" rel="noopener external nofollow noreferrer">HARICA repo</a>, select <strong>HARICA TLS RSA Root CA 2021 Cross Certificate from HARICA ECC Root CA 2015, 2021</strong> and download PEM.</li><li>Append the cross-cert to the PEM bundle, <code>$ cat pem-bundle.pem cross-cert.pem &gt; fixed-pem-bundle.pem</code></li><li><a href="https://chris.partridge.tech/2022/untrusted-harica-onion-certificates/" rel="noopener external nofollow noreferrer">More details</a></li></ul></li><li><p>Upload “.pem” and “.key” to the server. <code>chown</code> it to the Caddy system user and <code>chmod 600</code>.</p></li><li><p>Install the cert in Caddy. Site address has to be separated to HTTP and HTTPS blocks due to the use of custom port. When custom port is not used, Caddy listens on port 80 and 443 by default.</p></li></ol><pre><code class="hljs Caddyfile"># HTTP
http://xw226dvxac7jzcpsf4xb64r4epr6o5hgn46dxlqk7gnjptakik6xnzqd.onion:8080 &#123;
  bind ::1

  # Redirect to HTTPS
  redir https://xw226dvxac7jzcpsf4xb64r4epr6o5hgn46dxlqk7gnjptakik6xnzqd.onion&#123;uri&#125; permanent

  # HSTS (optional)
  header Strict-Transport-Security &quot;max-age=31536000; includeSubDomains; preload&quot;
&#125;

# HTTPS
xw226dvxac7jzcpsf4xb64r4epr6o5hgn46dxlqk7gnjptakik6xnzqd.onion:8079 &#123;
  bind ::1

  tls /var/lib/caddy/myonion.pem /var/lib/caddy/myonion.key

  header Strict-Transport-Security &quot;max-age=31536000; includeSubDomains; preload&quot;

  @harica path /.well-known/pki-validation/xxx
  respond @harica &quot;yyy&quot;
&#125;</code><button class="copy-button">Copy</button></pre><ol start="13"><li>Finally, update the Tor config. I configured it via NixOS global config.</li></ol><pre><div class="caption"><span>configuration.nix</span></div><code class="hljs nix">services.<span class="hljs-attr">tor</span> = &#123;
  <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  relay.<span class="hljs-attr">onionServices</span> = &#123;
    <span class="hljs-attr">myonion</span> = &#123;
      <span class="hljs-attr">version</span> = <span class="hljs-number">3</span>;
      <span class="hljs-attr">map</span> = [&#123;
        <span class="hljs-attr">port</span> = <span class="hljs-number">80</span>;
        <span class="hljs-attr">target</span> = &#123;
          <span class="hljs-attr">addr</span> = <span class="hljs-string">&quot;[::1]&quot;</span>;
          <span class="hljs-attr">port</span> = <span class="hljs-number">8080</span>;
        &#125;;
      &#125; &#123;
<mark>        <span class="hljs-attr">port</span> = <span class="hljs-number">443</span>;</mark>
<mark>        <span class="hljs-attr">target</span> = &#123;</mark>
<mark>          <span class="hljs-attr">addr</span> = <span class="hljs-string">&quot;[::1]&quot;</span>;</mark>
<mark>          <span class="hljs-attr">port</span> = <span class="hljs-number">8079</span>;</mark>
<mark>        &#125;;</mark>
      &#125;];
    &#125;;
  &#125;;
&#125;;</code><button class="copy-button">Copy</button></pre></div><footer class="article-footer"><ul class="article-meta"><li><span class="label">Published Date:</span> <time class="dt-published" datetime="2021-07-04T00:00:00.000Z" itemprop="datePublished">4 <a href="/blog/2021/07/" title="See July 2021's posts">Jul</a> <a href="/blog/2021/" title="See 2021's posts">2021</a></time></li><li><span class="label">Tag:</span><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/caddy/" rel="tag">Caddy</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/tor/" rel="tag">Tor</a></li></ul></li><li><span class="label">Source:</span> <a href="https://gitlab.com/curben/blog/-/blob/master/source/_posts/ecdsa-tls-tor-caddy.md" rel="noopener external nofollow noreferrer">ecdsa-tls-tor-caddy.md</a></li><hr></ul></footer></div><nav id="article-nav" class="article-nav"><span class="article-nav-link-wrap newer"><strong>Newer</strong> <a href="/blog/2021/07/23/aws-waf-wcu/"><div class="article-nav-title">Calculate Web ACL Capacity Unit (WCU) in AWS WAF</div></a></span><span class="article-nav-link-wrap older"><strong>Older</strong> <a href="/blog/2021/07/02/custom-package-nixos-module/"><div class="article-nav-title">Using custom package in a NixOS module</div></a></span></nav></article></div><footer id="footer" class="post-footer footer"><hr><div id="copyright" class="copyright">&copy; 2018-2024 Ming Di Leom. <a href="https://gitlab.com/curben/blog" rel="noopener external nofollow noreferrer">Powered by </a><a href="https://hexo.io/" rel="noopener external nofollow noreferrer">Hexo</a> with <a href="https://gitlab.com/curben/blog/tree/master/themes/chameleon" rel="noopener external nofollow noreferrer">Chameleon</a> theme.<br>Content is available under <a href="https://creativecommons.org/licenses/by-sa/4.0/" rel="noopener external nofollow noreferrer license" itemprop="license">CC-BY-SA 4.0</a>, unless indicated otherwise.<br><a class="main-nav-link" href="/disclaimer/">Disclaimer</a> <a class="main-nav-link" href="https://stats.uptimerobot.com/1394zup2LQ" rel="noopener external nofollow noreferrer">Status</a> <a class="main-nav-link" href="https://xw226dvxac7jzcpsf4xb64r4epr6o5hgn46dxlqk7gnjptakik6xnzqd.onion/" rel="noopener external nofollow noreferrer">Onion</a> <a class="main-nav-link" href="https://gitlab.com/curben/blog#mirrors" rel="noopener external nofollow noreferrer">Eepsite</a></div></footer><script src="/libs/clipboard-2.0.6.min.js" defer></script><script src="/js/copy-button.js"></script><script src="/js/chameleon.js"></script></body></html>