<!DOCTYPE html><html lang="en-GB"><head><meta charset="utf-8"><title>Enable LUKS2 and Argon2 support for Grub in Manjaro/Arch | Ming Di Leom&#39;s Blog</title><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="canonical" href="https://mdleom.com/blog/2022/11/27/grub-luks2-argon2/"><meta name="description" content="Convert LUKS1 to LUKS2"><meta property="article:author" content="Ming Di Leom"><meta property="article:tag" content="linux"><meta property="article:tag" content="manjaro"><meta property="article:tag" content="arch"><meta property="article:tag" content="luks"><meta property="og:type" content="article"><meta property="og:title" content="Enable LUKS2 and Argon2 support for Grub in Manjaro&#x2F;Arch"><meta property="og:url" content="https://mdleom.com/blog/2022/11/27/grub-luks2-argon2/"><meta property="og:site_name" content="Ming Di Leom&#39;s Blog"><meta property="og:description" content="Convert LUKS1 to LUKS2"><meta property="og:locale" content="en_GB"><meta property="og:image" content="https://mdleom.com/screenshot/blog/2022/11/27/grub-luks2-argon2/"><meta property="article:published_time" content="2022-11-27T00:00:00.000Z"><link rel="alternate" href="/atom.xml" title="Ming Di Leom's Blog" type="application/atom+xml"><link rel="icon" href="/favicon.ico"><link rel="icon" href="/svg/favicon.svg" type="image/svg+xml" sizes="any"><link rel="apple-touch-icon" href="/apple-touch-icon-180x180.png"><link rel="manifest" href="/site.webmanifest"><link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml"><link rel="stylesheet" href="/css/chameleon.css"><meta name="yandex-verification" content="e026a03a5dd06730"><meta name="generator" content="Hexo 7.1.1"></head><body><div id="container" class="container"><article id="post-grub-luks2-argon2" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting"><header id="header" class="header"><nav class="main-nav"><a class="main-nav-link" href="/">Home</a> <a class="main-nav-link" href="/blog/">Blog</a> <a class="main-nav-link" href="/about/">About</a> <a class="main-nav-link" href="/atom.xml">Feed</a> <a class="main-nav-link" href="https://gitlab.com/curben/blog" rel="noopener external nofollow noreferrer">GitLab</a><div class="search-container"><form id="searchForm" method="post" action="https://duckduckgo.com/" rel="noopener external nofollow noreferrer" role="search"><input type="search" name="q" class="search-box" placeholder="Search..." title="Powered by DuckDuckGo" enterkeyhint="search"> <input type="hidden" name="sites" value="mdleom.com"> <input type="hidden" name="kd" value="-1"> <input type="hidden" name="kg" value="p"> <input type="hidden" name="kae" value="#000"> <a class="search-button" id="search-click"><img src="/svg/search.svg"></a></form></div></nav><nav class="mobile-nav"><a class="site-title" href="/">mdleom.com</a><ul class="mobile-nav-menu"><label for="mobile-menu-toggle"><a class="no-underline" id="menu-button">&#9776;</a></label> <input id="mobile-menu-toggle" type="checkbox"><ul id="mobile-nav-link"><div class="search-container"><form id="searchFormMob" method="post" action="https://duckduckgo.com/" rel="noopener external nofollow noreferrer" role="search"><input type="search" name="q" class="search-box" placeholder="Search..." title="Powered by DuckDuckGo" enterkeyhint="search"> <input type="hidden" name="sites" value="mdleom.com"> <input type="hidden" name="kd" value="-1"> <input type="hidden" name="kg" value="p"> <input type="hidden" name="kae" value="#000"> <a class="search-button" id="search-click-mobile"><img src="/svg/search.svg"></a></form></div><i>Powered by DuckDuckGo</i> <a class="mobile-nav-link-a" href="/">Home</a> <a class="mobile-nav-link-a" href="/blog/">Blog</a> <a class="mobile-nav-link-a" href="/about/">About</a> <a class="mobile-nav-link-a" href="/atom.xml">Feed</a> <a class="mobile-nav-link-a" href="https://gitlab.com/curben/blog" rel="noopener external nofollow noreferrer">GitLab</a></ul></ul></nav></header><hr class="header-hr"><div class="article-inner"><header class="article-header"><h1 class="p-name entry-title article-title" itemprop="headline name">Enable LUKS2 and Argon2 support for Grub in Manjaro/Arch <a id="btnshare"><img src="/svg/share.svg"></a></h1></header><p class="p-summary">Convert LUKS1 to LUKS2</p><div class="e-content article-entry" itemprop="articleBody"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Prerequisite"><span class="toc-text">Prerequisite</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#grub-improved-luks2-git"><span class="toc-text">grub-improved-luks2-git</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Live-USB"><span class="toc-text">Live USB</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LUKS1-to-LUKS2-conversion"><span class="toc-text">LUKS1 to LUKS2 conversion</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Load-LUKS2-Grub-module"><span class="toc-text">Load LUKS2 Grub module</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Verify-LUKS2-unlock"><span class="toc-text">Verify LUKS2 unlock</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PBKDF2-to-Argon2"><span class="toc-text">PBKDF2 to Argon2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Enable-TRIM-and-disable-workqueue-for-SSD-performance-optional"><span class="toc-text">Enable TRIM and disable workqueue for SSD performance (optional)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Faster-unlock-in-Grub"><span class="toc-text">Faster unlock in Grub</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#References"><span class="toc-text">References</span></a></li></ol><p>I recently refreshed my Manjaro installation using the official ISO. My last installation used Manjaro Architect, which is my preferred method. Unfortunately, it was removed from all official ISOs due to lack of maintainer. I tried installing it in Live USB but it couldn’t install some base packages due to keyring issue, same issue with the <a href="https://github.com/manjaro-architect/download/releases" rel="noopener external nofollow noreferrer">nightly ISO</a>. As such, I had to use the GUI installer instead.</p><p>I ticked “Encrypt system” and Manjaro created two partitions in my NVMe drive <em>without</em> LVM. <a href="https://wiki.archlinux.org/title/btrfs#Subvolumes" rel="noopener external nofollow noreferrer">Btrfs subvolume</a> can provide LVM-like functionality.</p><table><thead><tr><th>Partition</th><th>Filesystem</th><th>Mount</th><th>Encrypted</th></tr></thead><tbody><tr><td>&#x2F;dev&#x2F;nvme0n1p1</td><td>FAT32</td><td><code>/boot/efi</code></td><td>No</td></tr><tr><td>&#x2F;dev&#x2F;nvme0n1p2</td><td>Btrfs</td><td><code>/</code></td><td>LUKS1</td></tr></tbody></table><p>The implication of the above layout is that <code>/boot</code> (where the kernel resides) is encrypted, except for <code>/boot/efi</code> (Grub resides here)—p1 is not encrypted, p2 is LUKS-encrypted. So, Grub has to unlock the LUKS partition first (using password), before the rest of <code>/</code> can be unlocked (using keyfile). Keyfile is used in this layout so that password is not <a href="https://leo3418.github.io/collections/gentoo-config-luks2-grub-systemd/auto-unlock.html" rel="noopener external nofollow noreferrer">prompted twice</a>.</p><p>There are two disadvantages of using Grub to unlock LUKS:</p><ol><li>Slow unlocking due to lack of cryptography acceleration</li><li>Limited LUKS2 support, i.e. Argon2 is not supported</li></ol><p>Fortunately, there is an AUR package <a href="https://aur.archlinux.org/packages/grub-improved-luks2-git" rel="noopener external nofollow noreferrer">grub-improved-luks2-git</a> that has been patched for Argon2 support. I will also show how to tune Argon2 parameters for faster unlock (while sacrificing security).</p><h2 id="Prerequisite">Prerequisite <a href="#Prerequisite" class="headerlink" title="Prerequisite">§</a></h2><ul><li>Manjaro&#x2F;Arch live USB&#x2F;CD, for offline (unmounted) LUKS1 to LUKS2 keyslot conversion<ul><li>Keyslot technically can be updated in mounted partition since it is only used to unlock the encryption key, once unlocked, subsequent data encryption&#x2F;decryption uses only the encryption key.</li><li>I just feel uneasy doing this while the partition has active I&#x2F;O, so I opt for live USB instead.</li></ul></li></ul><h2 id="grub-improved-luks2-git">grub-improved-luks2-git <a href="#grub-improved-luks2-git" class="headerlink" title="grub-improved-luks2-git">§</a></h2><p>Use your favourite AUR helper to install <a href="https://aur.archlinux.org/packages/grub-improved-luks2-git" rel="noopener external nofollow noreferrer">grub-improved-luks2-git</a>. This will take a while to compile patched Grub.</p><pre><code class="hljs plaintext">yay -S grub-improved-luks2-git</code><button class="copy-button">Copy</button></pre><p>There should be a confirmation to remove <code>grub</code> to avoid package conflict.</p><h2 id="Live-USB">Live USB <a href="#Live-USB" class="headerlink" title="Live USB">§</a></h2><p>Reboot into live USB. Identify the location of encrypted location using GParted. The partition filesystem should be “[Encrypted] btrfs”. In my case, it is <code>/dev/nvme0n1p2</code>.</p><h2 id="LUKS1-to-LUKS2-conversion">LUKS1 to LUKS2 conversion <a href="#LUKS1-to-LUKS2-conversion" class="headerlink" title="LUKS1 to LUKS2 conversion">§</a></h2><pre><code class="hljs plaintext">sudo cryptsetup convert --type luks2 /dev/nvme0n1p2</code><button class="copy-button">Copy</button></pre><p><em>If you want to revert back to LUKS1,</em></p><pre><code class="hljs plaintext">sudo cryptsetup convert --type luks1 /dev/nvme0n1p2</code><button class="copy-button">Copy</button></pre><p><em>Before reverting back to LUKS1, the keyslot must be using PBKDF2 not Argon2, otherwise you will encounter “Cannot convert to LUKS1 format” error.</em></p><pre><code class="hljs plaintext">sudo cryptsetup luksConvertKey --pbkdf pbkdf2 /dev/nvme0n1p2</code><button class="copy-button">Copy</button></pre><h2 id="Load-LUKS2-Grub-module">Load LUKS2 Grub module <a href="#Load-LUKS2-Grub-module" class="headerlink" title="Load LUKS2 Grub module">§</a></h2><p>At this stage, the Grub bootloader (not the package) cannot unlock the LUKS2 partition yet. It needs to be reinstalled so that it can detect LUKS2 partition and load the relevant module.</p><p>First, unlock the partition and mount it.</p><pre><code class="hljs plaintext">sudo cryptsetup open /dev/nvme0n1p2 root
sudo mount -o subvol=@ /dev/mapper/root /mnt
sudo mount /dev/nvme0n1p1 /mnt/boot/efi</code><button class="copy-button">Copy</button></pre><p>Notice in the “grub.cfg”, it loads <code>luks</code> module instead of <code>luks2</code>, this explains why Grub couldn’t unlock it.</p><pre><code class="hljs plaintext">$ sudo less /mnt/boot/grub/grub.cfg

menuentry &#x27;Manjaro Linux&#x27; &#123;
  insmod luks
&#125;</code><button class="copy-button">Copy</button></pre><p>While you <em>could</em> manually update the config and replace <code>luks</code> with <code>luks2</code>, it is better to automate it using <code>grub-mkconfig</code>.</p><pre><code class="hljs plaintext">sudo manjaro-chroot /mnt /bin/bash
# or `sudo arch-chroot /mnt /bin/bash`
grub-install --target=x86_64-efi --efi-directory=/boot/efi --bootloader-id=manjaro --recheck
grub-mkconfig -o /boot/grub/grub.cfg</code><button class="copy-button">Copy</button></pre><p>Now, inspect “grub.cfg” again while still in chroot, you should see <code>luks2</code> instead.</p><pre><code class="hljs plaintext">$ less /boot/grub/grub.cfg

menuentry &#x27;Manjaro Linux&#x27; &#123;
  insmod luks2
&#125;</code><button class="copy-button">Copy</button></pre><h2 id="Verify-LUKS2-unlock">Verify LUKS2 unlock <a href="#Verify-LUKS2-unlock" class="headerlink" title="Verify LUKS2 unlock">§</a></h2><p>Before proceed to the next step, I recommend reboot into your Manjaro&#x2F;Arch to check whether Grub can unlock LUKS2. Once that is done, reboot again to live USB.</p><h2 id="PBKDF2-to-Argon2">PBKDF2 to Argon2 <a href="#PBKDF2-to-Argon2" class="headerlink" title="PBKDF2 to Argon2">§</a></h2><p><em>This step should be done in live USB</em></p><p>All keyslot parameters are retained during conversion to LUKS2, so the pbkdf algorithm is still PBKDF2 + SHA256. To convert to Argon2 + SHA512,</p><pre><code class="hljs plaintext">sudo cryptsetup luksConvertKey --pbkdf argon2id --hash sha512 /dev/nvme0n1p2</code><button class="copy-button">Copy</button></pre><p>You may notice <code>insmod gcry_sha256</code> line in the “grub.cfg”, this module is not used for LUKS2 unlocking, so there is no need to add <code>insmod gcry_sha512</code>. As long as <code>insmod luks2</code> is there, Grub should be able to unlock LUKS2 regardless of pbkdf or hash algorithm.</p><h2 id="Enable-TRIM-and-disable-workqueue-for-SSD-performance-optional">Enable TRIM and disable workqueue for SSD performance (optional) <a href="#Enable-TRIM-and-disable-workqueue-for-SSD-performance-optional" class="headerlink" title="Enable TRIM and disable workqueue for SSD performance (optional)">§</a></h2><p><em>Still in live USB</em></p><pre><code class="hljs plaintext">sudo cryptsetup --allow-discards --perf-no_read_workqueue --perf-no_write_workqueue --persistent open /dev/nvme0n1p2 root</code><button class="copy-button">Copy</button></pre><p>Verify the flags are set.</p><pre><code class="hljs plaintext">$ sudo cryptsetup luksDump /dev/nvme0n1p2 | grep Flags

Flags:         allow-discards no-read-workqueue no-write-workqueue</code><button class="copy-button">Copy</button></pre><p>More details:</p><ul><li><a href="https://wiki.archlinux.org/title/Dm-crypt/Specialties#Discard/TRIM_support_for_solid_state_drives_(SSD)" rel="noopener external nofollow noreferrer">SSD TRIM</a></li><li><a href="https://wiki.archlinux.org/title/Dm-crypt/Specialties#Disable_workqueue_for_increased_solid_state_drive_(SSD)_performance" rel="noopener external nofollow noreferrer">Workqueue</a></li></ul><h2 id="Faster-unlock-in-Grub">Faster unlock in Grub <a href="#Faster-unlock-in-Grub" class="headerlink" title="Faster unlock in Grub">§</a></h2><p><em>This step can be done while the drive is mounted (as in not in live USB)</em></p><p>Due to lack of cryptography acceleration, Grub takes half a minute to unlock LUKS. For faster unlock, Argon2 parameters can be tuned to <em>less security</em>.</p><p>To start off, have a try with these parameters:</p><ul><li>4 iterations</li><li>256MB memory cost</li></ul><pre><code class="hljs plaintext">sudo cryptsetup luksConvertKey /dev/nvme0n1p2 --pbkdf-force-iterations 4 --pbkdf-memory 262100
sudo cryptsetup luksConvertKey /dev/nvme0n1p2 --pbkdf-force-iterations 4 --pbkdf-memory 262100 --key-file /crypto_keyfile.bin</code><button class="copy-button">Copy</button></pre><p><a href="https://leo3418.github.io/collections/gentoo-config-luks2-grub-systemd/tune-parameters.html#change-the-parameters" rel="noopener external nofollow noreferrer">This page</a> explains why keyfile also needs to be updated.</p><p>Reboot and check how fast is the unlock. Fine tune the <code>--pbkdf-memory</code> option until the unlock speed is satisfactory (not too slow and not too fast). The option takes a value in kilobyte (KB).</p><table><thead><tr><th>MB</th><th>KB</th></tr></thead><tbody><tr><td>128</td><td>131100</td></tr><tr><td>256</td><td>262100</td></tr><tr><td>512</td><td>524300</td></tr><tr><td>1024</td><td>1049000</td></tr></tbody></table><h2 id="References">References <a href="#References" class="headerlink" title="References">§</a></h2><ul><li><a href="https://wiki.archlinux.org/title/Dm-crypt/Encrypting_an_entire_system" rel="noopener external nofollow noreferrer">Dm-crypt&#x2F;Encrypting_an_entire_system</a></li><li><a href="https://leo3418.github.io/collections/gentoo-config-luks2-grub-systemd.html" rel="noopener external nofollow noreferrer">Gentoo Configuration Guide</a></li><li><a href="https://wiki.manjaro.org/index.php/GRUB/Restore_the_GRUB_Bootloader" rel="noopener external nofollow noreferrer">Restore the GRUB Bootloader</a></li></ul></div><footer class="article-footer"><ul class="article-meta"><li><span class="label">Published Date:</span> <time class="dt-published" datetime="2022-11-27T00:00:00.000Z" itemprop="datePublished">27 <a href="/blog/2022/11/" title="See November 2022's posts">Nov</a> <a href="/blog/2022/" title="See 2022's posts">2022</a></time></li><li><span class="label">Tag:</span><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/arch/" rel="tag">Arch</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/" rel="tag">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/luks/" rel="tag">Luks</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/manjaro/" rel="tag">Manjaro</a></li></ul></li><li><span class="label">Source:</span> <a href="https://gitlab.com/curben/blog/-/blob/master/source/_posts/grub-luks2-argon2.md" rel="noopener external nofollow noreferrer">grub-luks2-argon2.md</a></li><hr></ul></footer></div><nav id="article-nav" class="article-nav"><span class="article-nav-link-wrap newer"><strong>Newer</strong> <a href="/blog/2023/02/13/ssh-certificate-cloudflare-tunnel/"><div class="article-nav-title">SSH certificate using Cloudflare Tunnel</div></a></span><span class="article-nav-link-wrap older"><strong>Older</strong> <a href="/blog/2022/08/09/remove-gitlab-artifacts/"><div class="article-nav-title">Bulk remove old GitLab CI job artifacts</div></a></span></nav></article></div><footer id="footer" class="post-footer footer"><hr><div id="copyright" class="copyright">&copy; 2018-2024 Ming Di Leom. <a href="https://gitlab.com/curben/blog" rel="noopener external nofollow noreferrer">Powered by </a><a href="https://hexo.io/" rel="noopener external nofollow noreferrer">Hexo</a> with <a href="https://gitlab.com/curben/blog/tree/master/themes/chameleon" rel="noopener external nofollow noreferrer">Chameleon</a> theme.<br>Content is available under <a href="https://creativecommons.org/licenses/by-sa/4.0/" rel="noopener external nofollow noreferrer license" itemprop="license">CC-BY-SA 4.0</a>, unless indicated otherwise.<br><a class="main-nav-link" href="/disclaimer/">Disclaimer</a> <a class="main-nav-link" href="https://stats.uptimerobot.com/1394zup2LQ" rel="noopener external nofollow noreferrer">Status</a> <a class="main-nav-link" href="https://xw226dvxac7jzcpsf4xb64r4epr6o5hgn46dxlqk7gnjptakik6xnzqd.onion/" rel="noopener external nofollow noreferrer">Onion</a> <a class="main-nav-link" href="https://gitlab.com/curben/blog#mirrors" rel="noopener external nofollow noreferrer">Eepsite</a></div></footer><script src="/libs/clipboard-2.0.6.min.js" defer></script><script src="/js/copy-button.js"></script><script src="/js/chameleon.js"></script></body></html>