<!DOCTYPE html><html lang="en-GB"><head><meta charset="utf-8"><title>Override smartypants in marked.js renderer | Ming Di Leom&#39;s Blog</title><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="canonical" href="https://mdleom.com/blog/2020/08/30/override-smartypants-marked/"><meta name="description" content="marked is a Markdown renderer"><meta property="article:author" content="Ming Di Leom"><meta property="article:tag" content="javascript"><meta property="og:type" content="article"><meta property="og:title" content="Override smartypants in marked.js renderer"><meta property="og:url" content="https://mdleom.com/blog/2020/08/30/override-smartypants-marked/"><meta property="og:site_name" content="Ming Di Leom&#39;s Blog"><meta property="og:description" content="marked is a Markdown renderer"><meta property="og:locale" content="en_GB"><meta property="og:image" content="https://mdleom.com/screenshot/blog/2020/08/30/override-smartypants-marked/"><meta property="article:published_time" content="2020-08-30T00:00:00.000Z"><link rel="alternate" href="/atom.xml" title="Ming Di Leom's Blog" type="application/atom+xml"><link rel="icon" href="/favicon.ico"><link rel="icon" href="/svg/favicon.svg" type="image/svg+xml" sizes="any"><link rel="apple-touch-icon" href="/apple-touch-icon-180x180.png"><link rel="manifest" href="/site.webmanifest"><link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml"><link rel="stylesheet" href="/css/chameleon.css"><meta name="yandex-verification" content="e026a03a5dd06730"><meta name="generator" content="Hexo 7.1.1"></head><body><div id="container" class="container"><article id="post-override-smartypants-marked" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting"><header id="header" class="header"><nav class="main-nav"><a class="main-nav-link" href="/">Home</a> <a class="main-nav-link" href="/blog/">Blog</a> <a class="main-nav-link" href="/about/">About</a> <a class="main-nav-link" href="/atom.xml">Feed</a> <a class="main-nav-link" href="https://gitlab.com/curben/blog" rel="noopener external nofollow noreferrer">GitLab</a><div class="search-container"><form id="searchForm" method="post" action="https://duckduckgo.com/" rel="noopener external nofollow noreferrer" role="search"><input type="search" name="q" class="search-box" placeholder="Search..." title="Powered by DuckDuckGo" enterkeyhint="search"> <input type="hidden" name="sites" value="mdleom.com"> <input type="hidden" name="kd" value="-1"> <input type="hidden" name="kg" value="p"> <input type="hidden" name="kae" value="#000"> <a class="search-button" id="search-click"><img src="/svg/search.svg"></a></form></div></nav><nav class="mobile-nav"><a class="site-title" href="/">mdleom.com</a><ul class="mobile-nav-menu"><label for="mobile-menu-toggle"><a class="no-underline" id="menu-button">&#9776;</a></label> <input id="mobile-menu-toggle" type="checkbox"><ul id="mobile-nav-link"><div class="search-container"><form id="searchFormMob" method="post" action="https://duckduckgo.com/" rel="noopener external nofollow noreferrer" role="search"><input type="search" name="q" class="search-box" placeholder="Search..." title="Powered by DuckDuckGo" enterkeyhint="search"> <input type="hidden" name="sites" value="mdleom.com"> <input type="hidden" name="kd" value="-1"> <input type="hidden" name="kg" value="p"> <input type="hidden" name="kae" value="#000"> <a class="search-button" id="search-click-mobile"><img src="/svg/search.svg"></a></form></div><i>Powered by DuckDuckGo</i> <a class="mobile-nav-link-a" href="/">Home</a> <a class="mobile-nav-link-a" href="/blog/">Blog</a> <a class="mobile-nav-link-a" href="/about/">About</a> <a class="mobile-nav-link-a" href="/atom.xml">Feed</a> <a class="mobile-nav-link-a" href="https://gitlab.com/curben/blog" rel="noopener external nofollow noreferrer">GitLab</a></ul></ul></nav></header><hr class="header-hr"><div class="article-inner"><header class="article-header"><h1 class="p-name entry-title article-title" itemprop="headline name">Override smartypants in marked.js renderer <a id="btnshare"><img src="/svg/share.svg"></a></h1></header><p class="p-summary">marked is a Markdown renderer</p><div class="e-content article-entry" itemprop="articleBody"><pre><code class="hljs js"><span class="hljs-keyword">const</span> marked = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;marked&#x27;</span>)
<span class="hljs-keyword">const</span> &#123; <span class="hljs-built_in">escape</span> &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;marked/src/helpers&#x27;</span>)
<span class="hljs-keyword">const</span> &#123; <span class="hljs-title class_">Tokenizer</span>: <span class="hljs-title class_">MarkedTokenizer</span> &#125; = marked

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Tokenizer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">MarkedTokenizer</span> &#123;
  <span class="hljs-comment">// Override smartypants</span>
  inlineText (src, inRawBlock) &#123;
    <span class="hljs-keyword">const</span> &#123; options, rules &#125; = <span class="hljs-variable language_">this</span>
    <span class="hljs-keyword">const</span> &#123; <span class="hljs-attr">smartypants</span>: smartypantsCfg &#125; = options

    <span class="hljs-comment">// https://github.com/markedjs/marked/blob/b6773fca412c339e0cedd56b63f9fa1583cfd372/src/Lexer.js#L8-L24</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">smartypants</span> = str =&gt; &#123;
      <span class="hljs-keyword">return</span> str
        <span class="hljs-comment">// em-dashes</span>
        .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/---/g</span>, <span class="hljs-string">&#x27;\u2014&#x27;</span>)
        <span class="hljs-comment">// en-dashes</span>
        .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/--/g</span>, <span class="hljs-string">&#x27;\u2013&#x27;</span>)
        <span class="hljs-comment">// opening singles</span>
        .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/(^|[-\u2014/([&#123;&quot;\s])&#x27;/g</span>, <span class="hljs-string">&#x27;$1\u2018&#x27;</span>)
        <span class="hljs-comment">// closing singles &amp; apostrophes</span>
        .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/&#x27;/g</span>, <span class="hljs-string">&#x27;\u2019&#x27;</span>)
        <span class="hljs-comment">// opening doubles</span>
        .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/(^|[-\u2014/([&#123;\u2018\s])&quot;/g</span>, <span class="hljs-string">&#x27;$1\u201c&#x27;</span>)
        <span class="hljs-comment">// closing doubles</span>
        .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/&quot;/g</span>, <span class="hljs-string">&#x27;\u201d&#x27;</span>)
        <span class="hljs-comment">// ellipses</span>
        .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\.&#123;3&#125;/g</span>, <span class="hljs-string">&#x27;\u2026&#x27;</span>)
    &#125;

    <span class="hljs-comment">// https://github.com/markedjs/marked/blob/b6773fca412c339e0cedd56b63f9fa1583cfd372/src/Tokenizer.js#L643-L658</span>
    <span class="hljs-keyword">const</span> cap = rules.<span class="hljs-property">inline</span>.<span class="hljs-property">text</span>.<span class="hljs-title function_">exec</span>(src)
    <span class="hljs-keyword">if</span> (cap) &#123;
      <span class="hljs-keyword">let</span> text
      <span class="hljs-keyword">if</span> (inRawBlock) &#123;
        text = cap[<span class="hljs-number">0</span>]
      &#125; <span class="hljs-keyword">else</span> &#123;
        text = <span class="hljs-built_in">escape</span>(smartypantsCfg ? <span class="hljs-title function_">smartypants</span>(cap[<span class="hljs-number">0</span>]) : cap[<span class="hljs-number">0</span>])
      &#125;
      <span class="hljs-keyword">return</span> &#123;
        <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;text&#x27;</span>,
        <span class="hljs-attr">raw</span>: cap[<span class="hljs-number">0</span>],
        text
      &#125;
    &#125;
  &#125;
&#125;

marked.<span class="hljs-title function_">setOptions</span>(&#123;
  <span class="hljs-attr">smartypants</span>: <span class="hljs-literal">true</span>
&#125;)

<span class="hljs-keyword">const</span> tokenizer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Tokenizer</span>()

<span class="hljs-title function_">marked</span>(<span class="hljs-string">&#x27;input&#x27;</span>, &#123; tokenizer &#125;)</code><button class="copy-button">Copy</button></pre><p>A year ago, a user requested an option to override the behaviour of marked’s smartypants, particularly the user wondered if it is possible to replace <code>&quot;</code> with <code>«»</code> instead of <code>“”</code>. Another Markdown renderer, markdown-it (utilised by hexo-renderer-markdown-it), also offers smartypants feature and you can easily customise the quotes substitution using “quotes:” option. But marked doesn’t offer that option and I was not familiar with marked API, I couldn’t implement the user’s request.</p><p>Recently after working on <a href="https://github.com/hexojs/hexo-renderer-marked/pull/159" rel="noopener external nofollow noreferrer">hexojs&#x2F;hexo-renderer-marked#159</a>, I became (slightly) more familiar with <a href="https://marked.js.org/" rel="noopener external nofollow noreferrer">marked</a>, particularly in overriding its rendering methods. I noticed <a href="https://marked.js.org/#/USING_PRO.md#inline-level-tokenizer-methods" rel="noopener external nofollow noreferrer"><code>inlineText</code></a> tokenizer passes smartypants function in one of its arguments:</p><blockquote><ul><li>inlineText(<em>string</em> src, <em>bool</em> inRawBlock, <em>function</em> smartypants)</li></ul></blockquote><p>It seemed it is possible to bring-your-own smartypants function. Indeed after a few trial-and-error (there was no clear example), I finally figured it out and add a new <code>quotes:</code> option in hexo-renderer-marked (<a href="https://github.com/hexojs/hexo-renderer-marked/pull/161" rel="noopener external nofollow noreferrer">hexojs&#x2F;hexo-renderer-marked#161</a>). I attached a sample code at the beginning of this post. If you are already using marked, that code should be quite easy to understand and you just need to modify the <code>smartypants()</code> function. Otherwise, here is my explanation.</p><pre><code class="hljs js"><span class="hljs-keyword">const</span> &#123; <span class="hljs-built_in">escape</span> &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;marked/src/helpers&#x27;</span>)</code><button class="copy-button">Copy</button></pre><p>marked uses this function to escape unsafe content related to HTML tag (e.g. <code>&lt;</code> to <a href="https://github.com/markedjs/marked/blob/b6773fca412c339e0cedd56b63f9fa1583cfd372/src/helpers.js#L10" rel="noopener external nofollow noreferrer"><code>&amp;lt;</code></a>. I initially wanted to hexo-util’s <a href="https://github.com/hexojs/hexo-util#escapehtmlstr" rel="noopener external nofollow noreferrer"><code>escapeHTML()</code></a> since they seem to serve similar purpose and <code>escapeHTML()</code> does escape more potentially unsafe character. But then I noticed the regex search pattern is slightly different, so I retain marked’s <code>escape()</code> to avoid any undesired rendering change.</p><pre><code class="hljs js"><span class="hljs-comment">// https://github.com/markedjs/marked/blob/b6773fca412c339e0cedd56b63f9fa1583cfd372/src/Lexer.js#L8-L24</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">smartypants</span> = str =&gt; &#123;
  <span class="hljs-keyword">return</span> str
    <span class="hljs-comment">// em-dashes</span>
    .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/---/g</span>, <span class="hljs-string">&#x27;\u2014&#x27;</span>)
    <span class="hljs-comment">// en-dashes</span>
    .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/--/g</span>, <span class="hljs-string">&#x27;\u2013&#x27;</span>)
    <span class="hljs-comment">// opening singles</span>
    .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/(^|[-\u2014/([&#123;&quot;\s])&#x27;/g</span>, <span class="hljs-string">&#x27;$1\u2018&#x27;</span>)
    <span class="hljs-comment">// closing singles &amp; apostrophes</span>
    .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/&#x27;/g</span>, <span class="hljs-string">&#x27;\u2019&#x27;</span>)
    <span class="hljs-comment">// opening doubles</span>
    .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/(^|[-\u2014/([&#123;\u2018\s])&quot;/g</span>, <span class="hljs-string">&#x27;$1\u201c&#x27;</span>)
    <span class="hljs-comment">// closing doubles</span>
    .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/&quot;/g</span>, <span class="hljs-string">&#x27;\u201d&#x27;</span>)
    <span class="hljs-comment">// ellipses</span>
    .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\.&#123;3&#125;/g</span>, <span class="hljs-string">&#x27;\u2026&#x27;</span>)
&#125;</code><button class="copy-button">Copy</button></pre><p>This is smartypants function as implemented by marked, just comment out any <code>.replace()</code> line that you don’t want. Note the ordering of the replace function, you may need to comment out other related replacement; if you remove em-dash replace but still retain en-dash, any triple-dash “—“ will become en-dash + dash “–-“. It’s also possible to add <em>more</em> substitutions, like “&#x3D;&gt;” becomes “⇒”.</p><pre><code class="hljs js"><span class="hljs-keyword">if</span> (inRawBlock) &#123;
  text = cap[<span class="hljs-number">0</span>]
&#125;</code><button class="copy-button">Copy</button></pre><p><code>inRawBlock</code> will be true whenever marked encounters (safe) raw HTML element like <code>&lt;kbd&gt;lorem ipsum&lt;/kbd&gt;</code> in the markdown content; in this case, there is no need to escape and it will be retained as is.</p><pre><code class="hljs js"><span class="hljs-keyword">return</span> &#123;
  <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;text&#x27;</span>,
  <span class="hljs-attr">raw</span>: cap[<span class="hljs-number">0</span>],
  text
&#125;</code><button class="copy-button">Copy</button></pre><p>This is what I initially struggled the most to understand, I didn’t know which <code>type:</code> should I return. At first, I thought the type should be itself (<code>inlineText</code>) since that was the <code>codespan</code> <a href="https://marked.js.org/#/USING_PRO.md#tokenizer" rel="noopener external nofollow noreferrer">example</a> showed, but that didn’t work (it didn’t make sense anyway, since the function shouldn’t need to identify itself).</p><p>It turned out to be one of the <a href="https://marked.js.org/#/USING_PRO.md#inline-level-renderer-methods" rel="noopener external nofollow noreferrer">inline renderer</a> methods, in this case, it should be <code>text</code>.</p><pre><code class="hljs js">marked.<span class="hljs-title function_">setOptions</span>(&#123;
  <span class="hljs-attr">smartypants</span>: <span class="hljs-literal">true</span>
&#125;)</code><button class="copy-button">Copy</button></pre><p>This option is available as <code>this.options.smartypants</code> property in the method.</p></div><footer class="article-footer"><ul class="article-meta"><li><span class="label">Published Date:</span> <time class="dt-published" datetime="2020-08-30T00:00:00.000Z" itemprop="datePublished">30 <a href="/blog/2020/08/" title="See August 2020's posts">Aug</a> <a href="/blog/2020/" title="See 2020's posts">2020</a></time></li><li><span class="label">Tag:</span><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/" rel="tag">Javascript</a></li></ul></li><li><span class="label">Source:</span> <a href="https://gitlab.com/curben/blog/-/blob/master/source/_posts/override-smartypants-marked.md" rel="noopener external nofollow noreferrer">override-smartypants-marked.md</a></li><hr></ul></footer></div><nav id="article-nav" class="article-nav"><span class="article-nav-link-wrap newer"><strong>Newer</strong> <a href="/blog/2020/10/21/busybox-httpd-aws/"><div class="article-nav-title">Using BusyBox httpd in AWS EC2 for testing</div></a></span><span class="article-nav-link-wrap older"><strong>Older</strong> <a href="/blog/2020/08/19/snap-node-spawn/"><div class="article-nav-title">Snap-installed Node.js cannot spawn() a Node.js app</div></a></span></nav></article></div><footer id="footer" class="post-footer footer"><hr><div id="copyright" class="copyright">&copy; 2018-2024 Ming Di Leom. <a href="https://gitlab.com/curben/blog" rel="noopener external nofollow noreferrer">Powered by </a><a href="https://hexo.io/" rel="noopener external nofollow noreferrer">Hexo</a> with <a href="https://gitlab.com/curben/blog/tree/master/themes/chameleon" rel="noopener external nofollow noreferrer">Chameleon</a> theme.<br>Content is available under <a href="https://creativecommons.org/licenses/by-sa/4.0/" rel="noopener external nofollow noreferrer license" itemprop="license">CC-BY-SA 4.0</a>, unless indicated otherwise.<br><a class="main-nav-link" href="/disclaimer/">Disclaimer</a> <a class="main-nav-link" href="https://stats.uptimerobot.com/1394zup2LQ" rel="noopener external nofollow noreferrer">Status</a> <a class="main-nav-link" href="https://xw226dvxac7jzcpsf4xb64r4epr6o5hgn46dxlqk7gnjptakik6xnzqd.onion/" rel="noopener external nofollow noreferrer">Onion</a> <a class="main-nav-link" href="https://gitlab.com/curben/blog#mirrors" rel="noopener external nofollow noreferrer">Eepsite</a></div></footer><script src="/libs/clipboard-2.0.6.min.js" defer></script><script src="/js/copy-button.js"></script><script src="/js/chameleon.js"></script></body></html>