<!DOCTYPE html><html lang="en-GB"><head><meta charset="utf-8"><title>Setup Caddy as a reverse proxy on NixOS (Part 1: Installation) | Ming Di Leom&#39;s Blog</title><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="canonical" href="https://mdleom.com/blog/2020/02/23/caddy-nixos-part-1/"><meta name="description" content="Part 1: Installing NixOS"><meta property="article:author" content="Ming Di Leom"><meta property="article:tag" content="linux"><meta property="article:tag" content="server"><meta property="article:tag" content="caddy"><meta property="article:tag" content="nixos"><meta property="og:type" content="article"><meta property="og:title" content="Setup Caddy as a reverse proxy on NixOS (Part 1: Installation)"><meta property="og:url" content="https://mdleom.com/blog/2020/02/23/caddy-nixos-part-1/"><meta property="og:site_name" content="Ming Di Leom&#39;s Blog"><meta property="og:description" content="Part 1: Installing NixOS"><meta property="og:locale" content="en_GB"><meta property="og:image" content="https://mdleom.com/screenshot/blog/2020/02/23/caddy-nixos-part-1/"><meta property="article:published_time" content="2020-02-23T00:00:00.000Z"><meta property="article:modified_time" content="2021-02-22T00:00:00.000Z"><link rel="alternate" href="/atom.xml" title="Ming Di Leom's Blog" type="application/atom+xml"><link rel="icon" href="/favicon.ico"><link rel="icon" href="/svg/favicon.svg" type="image/svg+xml" sizes="any"><link rel="apple-touch-icon" href="/apple-touch-icon-180x180.png"><link rel="manifest" href="/site.webmanifest"><link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml"><link rel="stylesheet" href="/css/chameleon.css"><link rel="next" href="/blog/2020/03/04/caddy-nixos-part-2/" title="Setup Caddy as a reverse proxy on NixOS (Part 2: Hardening)"><meta name="yandex-verification" content="e026a03a5dd06730"><meta name="generator" content="Hexo 7.1.1"></head><body><div id="container" class="container"><article id="post-caddy-nixos-part-1" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting"><header id="header" class="header"><nav class="main-nav"><a class="main-nav-link" href="/">Home</a> <a class="main-nav-link" href="/blog/">Blog</a> <a class="main-nav-link" href="/about/">About</a> <a class="main-nav-link" href="/atom.xml">Feed</a> <a class="main-nav-link" href="https://gitlab.com/curben/blog" rel="noopener external nofollow noreferrer">GitLab</a><div class="search-container"><form id="searchForm" method="post" action="https://duckduckgo.com/" rel="noopener external nofollow noreferrer" role="search"><input type="search" name="q" class="search-box" placeholder="Search..." title="Powered by DuckDuckGo" enterkeyhint="search"> <input type="hidden" name="sites" value="mdleom.com"> <input type="hidden" name="kd" value="-1"> <input type="hidden" name="kg" value="p"> <input type="hidden" name="kae" value="#000"> <a class="search-button" id="search-click"><img src="/svg/search.svg"></a></form></div></nav><nav class="mobile-nav"><a class="site-title" href="/">mdleom.com</a><ul class="mobile-nav-menu"><label for="mobile-menu-toggle"><a class="no-underline" id="menu-button">&#9776;</a></label> <input id="mobile-menu-toggle" type="checkbox"><ul id="mobile-nav-link"><div class="search-container"><form id="searchFormMob" method="post" action="https://duckduckgo.com/" rel="noopener external nofollow noreferrer" role="search"><input type="search" name="q" class="search-box" placeholder="Search..." title="Powered by DuckDuckGo" enterkeyhint="search"> <input type="hidden" name="sites" value="mdleom.com"> <input type="hidden" name="kd" value="-1"> <input type="hidden" name="kg" value="p"> <input type="hidden" name="kae" value="#000"> <a class="search-button" id="search-click-mobile"><img src="/svg/search.svg"></a></form></div><i>Powered by DuckDuckGo</i> <a class="mobile-nav-link-a" href="/">Home</a> <a class="mobile-nav-link-a" href="/blog/">Blog</a> <a class="mobile-nav-link-a" href="/about/">About</a> <a class="mobile-nav-link-a" href="/atom.xml">Feed</a> <a class="mobile-nav-link-a" href="https://gitlab.com/curben/blog" rel="noopener external nofollow noreferrer">GitLab</a></ul></ul></nav></header><hr class="header-hr"><div class="article-inner"><header class="article-header"><h1 class="p-name entry-title article-title" itemprop="headline name">Setup Caddy as a reverse proxy on NixOS (Part 1: Installation) <a id="btnshare"><img src="/svg/share.svg"></a></h1></header><p class="p-summary">Part 1: Installing NixOS</p><div class="e-content article-entry" itemprop="articleBody"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Background"><span class="toc-text">Background</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Installation"><span class="toc-text">Installation</span></a></li></ol><p>In this segment, I show you how I install NixOS.</p><p>This post is Part 1 of a series of articles that show you how I set up Caddy, Tor hidden service and I2P Eepsite on NixOS:</p><ul><li>Part 1: Install NixOS</li><li><a href="/blog/2020/03/04/caddy-nixos-part-2/" title="Setup Caddy as a reverse proxy on NixOS (Part 2: Hardening)">Part 2: Configure NixOS</a></li><li><a href="/blog/2020/03/14/caddy-nixos-part-3/" title="Setup Caddy as a reverse proxy on NixOS (Part 3: Caddy)">Part 3: Configure Caddy</a></li><li><a href="/blog/2020/03/16/tor-hidden-onion-nixos/" title="How to make your website available over Tor hidden service on NixOS">Part 4: Setup Tor hidden service</a></li><li><a href="/blog/2020/03/21/i2p-eepsite-nixos/" title="How to make your website available over I2P Eepsite on NixOS">Part 5: Configure I2P</a></li></ul><h2 id="Background">Background <a href="#Background" class="headerlink" title="Background">§</a></h2><blockquote><p>Skip to <a href="#Installation">Installation</a> part.</p></blockquote><p>I set up this website with JAMstack architecture. Before moving to the current domain, I set four requirements:</p><ol><li>Retain current JAMstack workflow</li><li>Ability to add and <em>remove</em> HTTP headers</li><li>Available on Tor .onion</li><li>Cloudflare CDN</li></ol><p>This website’s JAMstack workflow goes like this:</p><ol><li>Pages are written in Markdown.</li><li>Markdown files are Git-hosted on GitLab</li><li>Any commit to GitLab repository triggers a build on Netlify CI</li><li>Markdown files are processed into HTML pages using Nodejs-powered Hexo.</li><li>Generated pages are hosted on curben.netlify.app</li></ol><p>(Edit: 22 Feb 2021) static site is now hosted primarily on Cloudflare Pages curben.pages.dev, with Netlify as a standby.</p><p>Right off the bat I can already see the need of setting up a private server due to the second requirement (ability to remove HTTP header). I had an option to drop Netlify by building the pages on my workstation and deploy to the web server (using a Hexo deployer plugin). So far I do find Netlify service to be reliable and it offers features like adding headers and reverse proxy which are easy to setup. Speaking of Netlify’s features, I then had an idea of setting up a web server which reverse proxy to Netlify. This approach meets all the four requirements; a side-benefit is that if I screw up the web server, at least my website is still up on curben.netlify.app and I can easily migrate this domain to Netlify.</p><p>As for web server, I went with Caddy, which has the most secured defaults. It is installed in NixOS, which is attractive for its centralised configuration. I initially planned to use Ubuntu, and then I noticed <a href="https://nixos.org/" rel="noopener external nofollow noreferrer">NixOS</a>; unlike most other Linux servers which has configs scattered around, NixOS is configured through a single “configuration.nix” file. It is <a href="https://en.wikipedia.org/wiki/Declarative_programming" rel="noopener external nofollow noreferrer">declarative</a>, meaning you simply supply the desired configuration and NixOS would figure how to achieve that. For example, to open port 80, you just need <code>networking.firewall.allowedTCPPorts = [ 80 ]</code>, instead of mucking around with iptables. This significantly helps reproducibility, making server migration much easier; simply supply the “configuration.nix” used in the previous server and the new server would have the same state. Having Caddy in the repo is the tipping point that finally made me dive into NixOS.</p><p><a href="/img/20200223/caddy-nixos.png"><img srcset="/img/20200223/caddy-nixos.png?f=auto&width=320 320w,/img/20200223/caddy-nixos.png?f=auto&width=468 468w,/img/20200223/caddy-nixos.png?f=auto&width=768 768w,/img/20200223/caddy-nixos.png?f=auto 800w" sizes="(max-width: 320px) 320px,(max-width: 468px) 468px,(max-width: 768px) 768px,800px" src="/img/20200223/caddy-nixos.png?f=auto" title="Architecture behind mdleom.com" alt="Architecture behind mdleom.com" loading="lazy"></a></p><p>Above diagram shows the architecture behind this website (mdleom.com). When a visitor browse mdleom.com, it will first go through Cloudflare CDN, the CDN then pass the request to my virtual private server (VPS). Before it reaches my VPS, there is a cloud firewall provided by the VPS host which I configure to allow inbound port 443. Once my VPS receive the request, the iptables port forward from 443 to 4430. The web server (Caddy) binds to (or listens on) port 4430 and it acts as a reverse proxy to the actual backend, curben.netlify.app.</p><p>The flow is slightly different when browsing via <a href="http://xw226dvxac7jzcpsf4xb64r4epr6o5hgn46dxlqk7gnjptakik6xnzqd.onion/" rel="noopener external nofollow noreferrer">.onion</a>. Tor hidden service is able to NAT-punching, only rely on outbound connection, so it can work behind a firewall that block inbound ports. The Tor daemon acts as a reverse proxy and forward the request to Caddy, which in turn is also a reverse proxy which finally forward the request to curben.netlify.app.</p><h2 id="Installation">Installation <a href="#Installation" class="headerlink" title="Installation">§</a></h2><p>NixOS has a detailed installation <a href="https://nixos.org/nixos/manual/index.html#sec-installation" rel="noopener external nofollow noreferrer">guide</a>, anyhow this is how I installed it.</p><ol><li>The LiveCD automatically login as “nixos”. Simply switch to the root shell. You could setup SSH before installation. Personally I can accept the KVM console latency and I didn’t want to open another port, so I never bother.</li></ol><pre><code class="hljs sh">sudo -s</code><button class="copy-button">Copy</button></pre><ol start="2"><li>Create the necessary partitions. I went with the classic MBR since my VPS provider still supports it and I don’t need 2 TB partition. I set up a “swap” partition due to having a tiny RAM; if you have less than 2 GB RAM, it’s better to have it, otherwise the <code>nixos-install</code> step would fail.</li></ol><pre><code class="hljs sh"><span class="hljs-comment"># Most KVM-powered VPS use &quot;/dev/vda&quot; naming scheme (instead of &quot;/dev/sda&quot;)</span>
<span class="hljs-comment"># Check the output of `ls /dev/` to make sure</span>
parted /dev/vda -- mklabel msdos

<span class="hljs-comment"># Create a new partition that fill the disk but</span>
<span class="hljs-comment"># leaves 1 GB space for the swap</span>
parted /dev/vda -- mkpart primary 1MiB -1GiB

<span class="hljs-comment"># Swap partition</span>
parted /dev/vda -- mkpart primary linux-swap -1GiB 100%</code><button class="copy-button">Copy</button></pre><ol start="3"><li>Format the partitions.</li></ol><pre><code class="hljs sh">mkfs.btrfs -L nixos /dev/vda1
<span class="hljs-comment"># Or &quot;mkfs.ext4&quot; if preferred</span>

mkswap -L swap /dev/vda2</code><button class="copy-button">Copy</button></pre><ol start="4"><li>Mount the partitions.</li></ol><pre><code class="hljs sh">mount /dev/disk/by-label/nixos /mnt
swapon /dev/vda2</code><button class="copy-button">Copy</button></pre><ol start="5"><li>Generate the configs. This generates “configuration.nix” and “hardware-configuration.nix”.</li></ol><pre><code class="hljs sh">nixos-generate-config --root /mnt</code><button class="copy-button">Copy</button></pre><ol start="6"><li><p>I replaced the generated “configuration.nix” with my own “configuration.nix”. Before uploading the config to the server, I did the following change,</p><ol><li>Replace “&#x2F;dev&#x2F;sda” with “&#x2F;dev&#x2F;vda” in <code>boot.loader.grub.device</code></li><li>Replace “eth0” to “ens3” in firewall config (check output of <code>ifconfig</code>)</li><li>Encrypt the file using 7zip before upload.</li></ol><pre><code class="hljs sh"><span class="hljs-comment"># This is much less memory-intensive than `nix-env -i package`</span>
<span class="hljs-comment"># wormhole-william is Go-implementation of magic-wormhole</span>
<span class="hljs-comment"># Available in 20.09+</span>
nix-env -f <span class="hljs-string">&#x27;&lt;nixpkgs&gt;&#x27;</span> -iA google-authenticator p7zip usbguard wormhole-william

<span class="hljs-built_in">cd</span> /tmp
wormhole-william receive configuration.7z
7z x configuration.7z

<span class="hljs-built_in">cp</span> configuration.nix /mnt/etc/nixos/</code><button class="copy-button">Copy</button></pre></li><li><p>Install it without setting root password (so that root remains disabled)</p></li></ol><pre><code class="hljs plaintext">nixos-install --no-root-passwd</code><button class="copy-button">Copy</button></pre><ol start="8"><li><p>In my setup, the installation downloaded around 1 GB of packages.</p></li><li><p>Once the installation is done, before shutting down, secure delete the downloaded files.</p></li></ol><pre><code class="hljs sh"><span class="hljs-built_in">shred</span> -uz configuration.7z configuration.nix</code><button class="copy-button">Copy</button></pre><ol start="10"><li>Shutdown, unmount the live cd, boot.</li></ol><p>Following is my “configuration.nix”. I’ll show you how to secure NixOS using hashed password, firewall, DNS-over-TLS and USBGuard in my next post. After that, I’ll show you how to setup Caddy and Tor (they are disabled for now).</p><pre><div class="caption"><span>/etc/nixos/configuration.nix</span></div><code class="hljs nix">&#123; config, pkgs, ... &#125;:

&#123;
  <span class="hljs-attr">imports</span> =
    [ <span class="hljs-comment"># Include the results of the hardware scan.</span>
      ./hardware-configuration.nix
    ];

  system.<span class="hljs-attr">stateVersion</span> = <span class="hljs-string">&quot;19.09&quot;</span>;

  <span class="hljs-comment"># Use the GRUB 2 boot loader.</span>
  boot.loader.grub.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  boot.loader.grub.<span class="hljs-attr">version</span> = <span class="hljs-number">2</span>;
  boot.loader.grub.<span class="hljs-attr">device</span> = <span class="hljs-string">&quot;/dev/vda&quot;</span>;

  networking.<span class="hljs-attr">useDHCP</span> = <span class="hljs-literal">false</span>;
  networking.interfaces.ens3.<span class="hljs-attr">useDHCP</span> = <span class="hljs-literal">true</span>;

  environment.<span class="hljs-attr">systemPackages</span> = <span class="hljs-keyword">with</span> pkgs; [
    dnsutils p7zip wormhole-william
  ];

  <span class="hljs-comment"># Save some typing</span>
  environment.<span class="hljs-attr">shellAliases</span> = &#123;
    <span class="hljs-attr">wormhole</span> = <span class="hljs-string">&quot;wormhole-william&quot;</span>;
  &#125;;

  time.<span class="hljs-attr">timeZone</span> = <span class="hljs-string">&quot;UTC&quot;</span>;

  <span class="hljs-comment">## Create service users</span>
  <span class="hljs-attr">users</span> = &#123;
    <span class="hljs-attr">mutableUsers</span> = <span class="hljs-literal">false</span>; <span class="hljs-comment"># Disable useradd &amp; passwd</span>

    <span class="hljs-attr">users</span> = &#123;
      <span class="hljs-attr">root</span> = &#123;
        <span class="hljs-attr">hashedPassword</span> = <span class="hljs-string">&quot;*&quot;</span>; <span class="hljs-comment"># Disable root password</span>
      &#125;;
      <span class="hljs-attr">nixos</span> = &#123;
        <span class="hljs-attr">hashedPassword</span> = <span class="hljs-string">&quot;xxxx&quot;</span>;
        <span class="hljs-attr">isNormalUser</span> = <span class="hljs-literal">true</span>;
        <span class="hljs-attr">extraGroups</span> = [ <span class="hljs-string">&quot;wheel&quot;</span> ]; <span class="hljs-comment"># Enable ‘sudo’ for the user.</span>
      &#125;;
      <span class="hljs-attr">caddyProxy</span> = &#123;
        <span class="hljs-attr">home</span> = <span class="hljs-string">&quot;/var/lib/caddyProxy&quot;</span>;
        <span class="hljs-attr">createHome</span> = <span class="hljs-literal">true</span>;
        <span class="hljs-attr">isSystemUser</span> = <span class="hljs-literal">true</span>;
        <span class="hljs-attr">group</span> = <span class="hljs-string">&quot;caddyProxy&quot;</span>;
      &#125;;
      <span class="hljs-attr">caddyTor</span> = &#123;
        <span class="hljs-attr">home</span> = <span class="hljs-string">&quot;/var/lib/caddyTor&quot;</span>;
        <span class="hljs-attr">createHome</span> = <span class="hljs-literal">true</span>;
        <span class="hljs-attr">isSystemUser</span> = <span class="hljs-literal">true</span>;
        <span class="hljs-attr">group</span> = <span class="hljs-string">&quot;caddyTor&quot;</span>;
      &#125;;
    &#125;;

    <span class="hljs-attr">groups</span> = &#123;
      <span class="hljs-attr">caddyProxy</span> = &#123;
        <span class="hljs-attr">members</span> = [ <span class="hljs-string">&quot;caddyProxy&quot;</span> ];
      &#125;;
      <span class="hljs-attr">caddyTor</span> = &#123;
        <span class="hljs-attr">members</span> = [ <span class="hljs-string">&quot;caddyTor&quot;</span> ];
      &#125;;
    &#125;;
  &#125;;
&#125;
</code><button class="copy-button">Copy</button></pre></div><footer class="article-footer"><ul class="article-meta"><li><span class="label">Last Updated:</span> <time class="dt-updated" datetime="2021-02-22T00:00:00.000Z" itemprop="dateModified">22 Feb 2021</time></li><li><span class="label">Published Date:</span> <time class="dt-published" datetime="2020-02-23T00:00:00.000Z" itemprop="datePublished">23 <a href="/blog/2020/02/" title="See February 2020's posts">Feb</a> <a href="/blog/2020/" title="See 2020's posts">2020</a></time></li><li><span class="label">Tag:</span><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/caddy/" rel="tag">Caddy</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/" rel="tag">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nixos/" rel="tag">Nixos</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/server/" rel="tag">Server</a></li></ul></li><li><span class="label">Source:</span> <a href="https://gitlab.com/curben/blog/-/blob/master/source/_posts/caddy-nixos-part-1.md" rel="noopener external nofollow noreferrer">caddy-nixos-part-1.md</a></li><hr></ul></footer></div><nav id="article-nav" class="article-nav"><span class="article-nav-link-wrap newer"><strong>Newer</strong> <a href="/blog/2020/03/04/caddy-nixos-part-2/"><div class="article-nav-title">Setup Caddy as a reverse proxy on NixOS (Part 2: Hardening)</div></a></span><span class="article-nav-link-wrap older"><strong>Older</strong> <a href="/blog/2020/01/20/how-to-use-camaro-xml/"><div class="article-nav-title">How to use Camaro to parse XML to JSON</div></a></span></nav></article></div><footer id="footer" class="post-footer footer"><hr><div id="copyright" class="copyright">&copy; 2018-2024 Ming Di Leom. <a href="https://gitlab.com/curben/blog" rel="noopener external nofollow noreferrer">Powered by </a><a href="https://hexo.io/" rel="noopener external nofollow noreferrer">Hexo</a> with <a href="https://gitlab.com/curben/blog/tree/master/themes/chameleon" rel="noopener external nofollow noreferrer">Chameleon</a> theme.<br>Content is available under <a href="https://creativecommons.org/licenses/by-sa/4.0/" rel="noopener external nofollow noreferrer license" itemprop="license">CC-BY-SA 4.0</a>, unless indicated otherwise.<br><a class="main-nav-link" href="/disclaimer/">Disclaimer</a> <a class="main-nav-link" href="https://stats.uptimerobot.com/1394zup2LQ" rel="noopener external nofollow noreferrer">Status</a> <a class="main-nav-link" href="https://xw226dvxac7jzcpsf4xb64r4epr6o5hgn46dxlqk7gnjptakik6xnzqd.onion/" rel="noopener external nofollow noreferrer">Onion</a> <a class="main-nav-link" href="https://gitlab.com/curben/blog#mirrors" rel="noopener external nofollow noreferrer">Eepsite</a></div></footer><script src="/libs/clipboard-2.0.6.min.js" defer></script><script src="/js/copy-button.js"></script><script src="/js/chameleon.js"></script></body></html>