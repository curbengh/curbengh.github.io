<!DOCTYPE html><html lang="en-GB"><head><meta charset="utf-8"><title>Enabling HSTS preload in Cloudflare | Ming Di Leom&#39;s Blog</title><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="canonical" href="https://mdleom.com/blog/2020/11/22/cloudflare-hsts/"><meta name="description" content="Take note if you have www -&gt; apex redirect"><meta property="article:author" content="Ming Di Leom"><meta property="article:tag" content="security"><meta property="article:tag" content="cloudflare"><meta property="og:type" content="article"><meta property="og:title" content="Enabling HSTS preload in Cloudflare"><meta property="og:url" content="https://mdleom.com/blog/2020/11/22/cloudflare-hsts/"><meta property="og:site_name" content="Ming Di Leom&#39;s Blog"><meta property="og:description" content="Take note if you have www -&gt; apex redirect"><meta property="og:locale" content="en_GB"><meta property="og:image" content="https://mdleom.com/screenshot/blog/2020/11/22/cloudflare-hsts/"><meta property="article:published_time" content="2020-11-22T00:00:00.000Z"><meta property="article:modified_time" content="2021-03-11T00:00:00.000Z"><link rel="alternate" href="/atom.xml" title="Ming Di Leom's Blog" type="application/atom+xml"><link rel="icon" href="/favicon.ico"><link rel="icon" href="/svg/favicon.svg" type="image/svg+xml" sizes="any"><link rel="apple-touch-icon" href="/apple-touch-icon-180x180.png"><link rel="manifest" href="/site.webmanifest"><link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml"><link rel="stylesheet" href="/css/chameleon.css"><meta name="yandex-verification" content="e026a03a5dd06730"><meta name="generator" content="Hexo 7.1.1"></head><body><div id="container" class="container"><article id="post-cloudflare-hsts" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting"><header id="header" class="header"><nav class="main-nav"><a class="main-nav-link" href="/">Home</a> <a class="main-nav-link" href="/blog/">Blog</a> <a class="main-nav-link" href="/about/">About</a> <a class="main-nav-link" href="/atom.xml">Feed</a> <a class="main-nav-link" href="https://gitlab.com/curben/blog" rel="noopener external nofollow noreferrer">GitLab</a><div class="search-container"><form id="searchForm" method="post" action="https://duckduckgo.com/" rel="noopener external nofollow noreferrer" role="search"><input type="search" name="q" class="search-box" placeholder="Search..." title="Powered by DuckDuckGo" enterkeyhint="search"> <input type="hidden" name="sites" value="mdleom.com"> <input type="hidden" name="kd" value="-1"> <input type="hidden" name="kg" value="p"> <input type="hidden" name="kae" value="#000"> <a class="search-button" id="search-click"><img src="/svg/search.svg"></a></form></div></nav><nav class="mobile-nav"><a class="site-title" href="/">mdleom.com</a><ul class="mobile-nav-menu"><label for="mobile-menu-toggle"><a class="no-underline" id="menu-button">&#9776;</a></label> <input id="mobile-menu-toggle" type="checkbox"><ul id="mobile-nav-link"><div class="search-container"><form id="searchFormMob" method="post" action="https://duckduckgo.com/" rel="noopener external nofollow noreferrer" role="search"><input type="search" name="q" class="search-box" placeholder="Search..." title="Powered by DuckDuckGo" enterkeyhint="search"> <input type="hidden" name="sites" value="mdleom.com"> <input type="hidden" name="kd" value="-1"> <input type="hidden" name="kg" value="p"> <input type="hidden" name="kae" value="#000"> <a class="search-button" id="search-click-mobile"><img src="/svg/search.svg"></a></form></div><i>Powered by DuckDuckGo</i> <a class="mobile-nav-link-a" href="/">Home</a> <a class="mobile-nav-link-a" href="/blog/">Blog</a> <a class="mobile-nav-link-a" href="/about/">About</a> <a class="mobile-nav-link-a" href="/atom.xml">Feed</a> <a class="mobile-nav-link-a" href="https://gitlab.com/curben/blog" rel="noopener external nofollow noreferrer">GitLab</a></ul></ul></nav></header><hr class="header-hr"><div class="article-inner"><header class="article-header"><h1 class="p-name entry-title article-title" itemprop="headline name">Enabling HSTS preload in Cloudflare <a id="btnshare"><img src="/svg/share.svg"></a></h1></header><p class="p-summary">Take note if you have www -> apex redirect</p><div class="e-content article-entry" itemprop="articleBody"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Redirect"><span class="toc-text">Redirect</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Update-17-Dec-2020"><span class="toc-text">Update (17 Dec 2020)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Update-11-Mar-2021"><span class="toc-text">Update (11 Mar 2021)</span></a></li></ol><p>HTTP Strict Transport Security (<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Strict-Transport-Security" rel="noopener external nofollow noreferrer">HSTS</a>) preload is used to instruct browsers to always use HTTPS for your website. Browsers will initiate and connect to any site in the preloaded HSTS list through HTTPS only. The list is currently maintained by <a href="https://cs.chromium.org/chromium/src/net/http/transport_security_state_static.json" rel="noopener external nofollow noreferrer">Chromium</a> (GitHub mirror <a href="https://github.com/chromium/chromium/raw/master/net/http/transport_security_state_static.json" rel="noopener external nofollow noreferrer">link</a>) and the list is utilised by all <a href="https://caniuse.com/stricttransportsecurity" rel="noopener external nofollow noreferrer">supported</a> browsers. Eligible website can request to be included at <a href="https://hstspreload.org/" rel="noopener external nofollow noreferrer">hstspreload.org</a>. In order to be accepted to the HSTS preload list through this form, your site must satisfy the following set of requirements:</p><ol><li>Serve a valid certificate.</li><li>Redirect from HTTP to HTTPS on the <strong>same host</strong>, if you are listening on port 80. (see <a href="#Redirect">next section</a>)</li><li>Serve all subdomains over HTTPS.<ol><li>In particular, you must support HTTPS for the <strong>www</strong> subdomain if a DNS record for that subdomain exists.</li></ol></li><li>Serve an HSTS header on the base domain for HTTPS requests:<ol><li>The max-age must be at least 31536000 seconds (1 year).</li><li>The includeSubDomains directive must be specified.</li><li>The preload directive must be specified.</li><li>If you are serving an additional redirect from your HTTPS site, that redirect must still have the HSTS header (rather than the page it redirects to).</li></ol></li></ol><p>In actual implementation, a website must have the following header to meet above requirements:</p><pre><code class="hljs plaintext">Strict-Transport-Security: max-age=31536000; includeSubDomains; preload</code><button class="copy-button">Copy</button></pre><p>To serve the above HTTP header in Cloudflare, head to SSL&#x2F;TLS → Edge Certificates. Enable “Always Use HTTPS”. Under the HSTS setting:</p><ol><li>Enable HSTS: On</li><li>Max Age: 12 months</li><li>Apply HSTS policy to subdomains: On</li><li>Preload: On</li><li>No-Sniff Header: On (optional)</li></ol><p><a href="/img/20201122/cf-hsts-config.png"><img srcset="/img/20201122/cf-hsts-config.png?f=auto&width=320 320w,/img/20201122/cf-hsts-config.png?f=auto&width=468 468w,/img/20201122/cf-hsts-config.png?f=auto&width=768 768w,/img/20201122/cf-hsts-config.png?f=auto 800w" sizes="(max-width: 320px) 320px,(max-width: 468px) 468px,(max-width: 768px) 768px,800px" src="/img/20201122/cf-hsts-config.png?f=auto" title="Cloudflare HSTS configuration" alt="Cloudflare HSTS configuration" loading="lazy"></a></p><p><a href="/img/20201122/cf-tls.png"><img srcset="/img/20201122/cf-tls.png?f=auto&width=320 320w,/img/20201122/cf-tls.png?f=auto&width=468 468w,/img/20201122/cf-tls.png?f=auto&width=768 768w,/img/20201122/cf-tls.png?f=auto 800w" sizes="(max-width: 320px) 320px,(max-width: 468px) 468px,(max-width: 768px) 768px,800px" src="/img/20201122/cf-tls.png?f=auto" title="Recommended SSL/TLS configuration" alt="Recommended SSL/TLS configuration" loading="lazy"></a></p><p>After enabling HSTS, you can proceed submit your website to <a href="https://hstspreload.org/" rel="noopener external nofollow noreferrer">hstspreload.org</a>. To check current status, you can either query hstspreload.org or Chromium-maintained list,</p><pre><code class="hljs plaintext">$ curl -L https://github.com/chromium/chromium/raw/master/net/http/transport_security_state_static.json -o hsts-chromium.json
$ grep example.com hsts-chromium.json</code><button class="copy-button">Copy</button></pre><h2 id="Redirect">Redirect <a href="#Redirect" class="headerlink" title="Redirect">§</a></h2><p>If you have www → apex redirect (<code>www.example.com</code> → <code>example.com</code>) or vice versa, it’s tempting to do the following redirect:</p><ul><li><code>http://www.example.com</code> → <code>https://example.com</code> (<strong>invalid</strong>)</li></ul><p>While it saves one redirect (<code>http://www.example.com</code> → <code>https://www.example.com</code>), it goes against the requirement. The valid redirect should be:</p><ul><li><code>http://www.example.com</code> → <code>https://www.example.com</code> → <code>https://example.com</code> (<strong>valid</strong>)</li></ul><p>You can use either use your origin server or Page Rules to handle the redirect; when combining with “Always Use HTTPS” feature, you only need to add the following redirect:</p><ul><li><code>https://www.example.com</code> → <code>https://example.com</code></li></ul><p>Covered by “Always use HTTPS”:</p><ul><li><code>http://example.com</code> → <code>https://example.com</code></li><li><code>http://www.example.com</code> → <code>https://www.example.com</code></li></ul><p><a href="/img/20201122/page-rules.png"><img srcset="/img/20201122/page-rules.png?f=auto&width=320 320w,/img/20201122/page-rules.png?f=auto&width=468 468w,/img/20201122/page-rules.png?f=auto&width=768 768w,/img/20201122/page-rules.png?f=auto 800w" sizes="(max-width: 320px) 320px,(max-width: 468px) 468px,(max-width: 768px) 768px,800px" src="/img/20201122/page-rules.png?f=auto" title="Page Rules" alt="Page Rules" loading="lazy"></a></p><h2 id="Update-17-Dec-2020">Update (17 Dec 2020) <a href="#Update-17-Dec-2020" class="headerlink" title="Update (17 Dec 2020)">§</a></h2><p>This website is now included in the Chromium’s preload list after I submitted a <a href="https://hstspreload.org/" rel="noopener external nofollow noreferrer">request</a> a month ago. The list hasn’t been deployed to browsers’ (Chrome and Firefox) stable version yet, that may take another month or two.</p><pre><code class="hljs plaintext">$ curl -L https://github.com/chromium/chromium/raw/master/net/http/transport_security_state_static.json -o hsts-chromium.json
$ grep mdleom.com hsts-chromium.json 
  &#123; &quot;name&quot;: &quot;mdleom.com&quot;, &quot;policy&quot;: &quot;bulk-1-year&quot;, &quot;mode&quot;: &quot;force-https&quot;, &quot;include_subdomains&quot;: true &#125;,</code><button class="copy-button">Copy</button></pre><h2 id="Update-11-Mar-2021">Update (11 Mar 2021) <a href="#Update-11-Mar-2021" class="headerlink" title="Update (11 Mar 2021)">§</a></h2><p>This website is now included in the HSTS list of Chrome 89.</p><p><a href="/img/20201122/chromium-hsts.png"><img srcset="/img/20201122/chromium-hsts.png?f=auto&width=320 320w,/img/20201122/chromium-hsts.png?f=auto&width=468 468w,/img/20201122/chromium-hsts.png?f=auto&width=768 768w,/img/20201122/chromium-hsts.png?f=auto 800w" sizes="(max-width: 320px) 320px,(max-width: 468px) 468px,(max-width: 768px) 768px,800px" src="/img/20201122/chromium-hsts.png?f=auto" title="Chromium 89 HSTS query" alt="Chromium 89 HSTS query" loading="lazy"></a></p></div><footer class="article-footer"><ul class="article-meta"><li><span class="label">Last Updated:</span> <time class="dt-updated" datetime="2021-03-11T00:00:00.000Z" itemprop="dateModified">11 Mar 2021</time></li><li><span class="label">Published Date:</span> <time class="dt-published" datetime="2020-11-22T00:00:00.000Z" itemprop="datePublished">22 <a href="/blog/2020/11/" title="See November 2020's posts">Nov</a> <a href="/blog/2020/" title="See 2020's posts">2020</a></time></li><li><span class="label">Tag:</span><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cloudflare/" rel="tag">Cloudflare</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/security/" rel="tag">Security</a></li></ul></li><li><span class="label">Source:</span> <a href="https://gitlab.com/curben/blog/-/blob/master/source/_posts/cloudflare-hsts.md" rel="noopener external nofollow noreferrer">cloudflare-hsts.md</a></li><hr></ul></footer></div><nav id="article-nav" class="article-nav"><span class="article-nav-link-wrap newer"><strong>Newer</strong> <a href="/blog/2021/02/15/cloudflare-pages/"><div class="article-nav-title">Deploy Hexo to Cloudflare Pages</div></a></span><span class="article-nav-link-wrap older"><strong>Older</strong> <a href="/blog/2020/11/21/cloudflare-html-cache/"><div class="article-nav-title">Cloudflare does not cache html by default</div></a></span></nav></article></div><footer id="footer" class="post-footer footer"><hr><div id="copyright" class="copyright">&copy; 2018-2024 Ming Di Leom. <a href="https://gitlab.com/curben/blog" rel="noopener external nofollow noreferrer">Powered by </a><a href="https://hexo.io/" rel="noopener external nofollow noreferrer">Hexo</a> with <a href="https://gitlab.com/curben/blog/tree/master/themes/chameleon" rel="noopener external nofollow noreferrer">Chameleon</a> theme.<br>Content is available under <a href="https://creativecommons.org/licenses/by-sa/4.0/" rel="noopener external nofollow noreferrer license" itemprop="license">CC-BY-SA 4.0</a>, unless indicated otherwise.<br><a class="main-nav-link" href="/disclaimer/">Disclaimer</a> <a class="main-nav-link" href="https://stats.uptimerobot.com/1394zup2LQ" rel="noopener external nofollow noreferrer">Status</a> <a class="main-nav-link" href="https://xw226dvxac7jzcpsf4xb64r4epr6o5hgn46dxlqk7gnjptakik6xnzqd.onion/" rel="noopener external nofollow noreferrer">Onion</a> <a class="main-nav-link" href="https://gitlab.com/curben/blog#mirrors" rel="noopener external nofollow noreferrer">Eepsite</a></div></footer><script src="/libs/clipboard-2.0.6.min.js" defer></script><script src="/js/copy-button.js"></script><script src="/js/chameleon.js"></script></body></html>