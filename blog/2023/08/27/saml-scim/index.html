<!DOCTYPE html><html lang="en-GB"><head><meta charset="utf-8"><title>Azure AD SSO integration with ServiceNow | Ming Di Leom&#39;s Blog</title><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="canonical" href="https://mdleom.com/blog/2023/08/27/saml-scim/"><meta name="description" content="Difference of SAML and SCIM"><meta property="article:author" content="Ming Di Leom"><meta property="article:tag" content="sso"><meta property="article:tag" content="servicenow"><meta property="article:tag" content="azure-ad"><meta property="og:type" content="article"><meta property="og:title" content="Azure AD SSO integration with ServiceNow"><meta property="og:url" content="https://mdleom.com/blog/2023/08/27/saml-scim/"><meta property="og:site_name" content="Ming Di Leom&#39;s Blog"><meta property="og:description" content="Difference of SAML and SCIM"><meta property="og:locale" content="en_GB"><meta property="og:image" content="https://mdleom.com/screenshot/blog/2023/08/27/saml-scim/"><meta property="article:published_time" content="2023-08-27T00:00:00.000Z"><link rel="alternate" href="/atom.xml" title="Ming Di Leom's Blog" type="application/atom+xml"><link rel="icon" href="/favicon.ico"><link rel="icon" href="/svg/favicon.svg" type="image/svg+xml" sizes="any"><link rel="apple-touch-icon" href="/apple-touch-icon-180x180.png"><link rel="manifest" href="/site.webmanifest"><link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml"><link rel="stylesheet" href="/css/chameleon.css"><meta name="yandex-verification" content="e026a03a5dd06730"><meta name="generator" content="Hexo 7.1.1"></head><body><div id="container" class="container"><article id="post-saml-scim" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting"><header id="header" class="header"><nav class="main-nav"><a class="main-nav-link" href="/">Home</a> <a class="main-nav-link" href="/blog/">Blog</a> <a class="main-nav-link" href="/about/">About</a> <a class="main-nav-link" href="/atom.xml">Feed</a> <a class="main-nav-link" href="https://gitlab.com/curben/blog" rel="noopener external nofollow noreferrer">GitLab</a><div class="search-container"><form id="searchForm" method="post" action="https://duckduckgo.com/" rel="noopener external nofollow noreferrer" role="search"><input type="search" name="q" class="search-box" placeholder="Search..." title="Powered by DuckDuckGo" enterkeyhint="search"> <input type="hidden" name="sites" value="mdleom.com"> <input type="hidden" name="kd" value="-1"> <input type="hidden" name="kg" value="p"> <input type="hidden" name="kae" value="#000"> <a class="search-button" id="search-click"><img src="/svg/search.svg"></a></form></div></nav><nav class="mobile-nav"><a class="site-title" href="/">mdleom.com</a><ul class="mobile-nav-menu"><label for="mobile-menu-toggle"><a class="no-underline" id="menu-button">&#9776;</a></label> <input id="mobile-menu-toggle" type="checkbox"><ul id="mobile-nav-link"><div class="search-container"><form id="searchFormMob" method="post" action="https://duckduckgo.com/" rel="noopener external nofollow noreferrer" role="search"><input type="search" name="q" class="search-box" placeholder="Search..." title="Powered by DuckDuckGo" enterkeyhint="search"> <input type="hidden" name="sites" value="mdleom.com"> <input type="hidden" name="kd" value="-1"> <input type="hidden" name="kg" value="p"> <input type="hidden" name="kae" value="#000"> <a class="search-button" id="search-click-mobile"><img src="/svg/search.svg"></a></form></div><i>Powered by DuckDuckGo</i> <a class="mobile-nav-link-a" href="/">Home</a> <a class="mobile-nav-link-a" href="/blog/">Blog</a> <a class="mobile-nav-link-a" href="/about/">About</a> <a class="mobile-nav-link-a" href="/atom.xml">Feed</a> <a class="mobile-nav-link-a" href="https://gitlab.com/curben/blog" rel="noopener external nofollow noreferrer">GitLab</a></ul></ul></nav></header><hr class="header-hr"><div class="article-inner"><header class="article-header"><h1 class="p-name entry-title article-title" itemprop="headline name">Azure AD SSO integration with ServiceNow <a id="btnshare"><img src="/svg/share.svg"></a></h1></header><p class="p-summary">Difference of SAML and SCIM</p><div class="e-content article-entry" itemprop="articleBody"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#SSO-in-Azure-AD"><span class="toc-text">SSO in Azure AD</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SCIM"><span class="toc-text">SCIM</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Single-space-value"><span class="toc-text">Single-space value</span></a></li></ol><p>Single sign-on (SSO) enables a user to access multiple systems using one login. Whenever a user wants to access a system, the system will redirect the user to an identity provider which has an existing account for that user; once the user authenticates with the identity provider successfully, the identity provider will redirect the user back to the system and the user can then access it. The system does not have the user’s password and the identity provider does not share it either.</p><p>In an enterprise environment, SSO provides convenience to the staff and several benefits to the enterprise. Three benefits to the enterprise:</p><ol><li>Less accounts to create (onboarding), maintain and disable&#x2F;delete (offboarding).</li><li>During offboarding, disabling an account from the identity provider will also revoke access to SSO-enabled systems, thus providing better security.</li><li>Identity provider is much more likely to support multi-factor authentication (MFA), enabling more systems to be MFA-secured.</li></ol><p>SSO does not necessarily provide better security all the time. Threat actor can utilise a compromised account to access any SSO-enabled system that the account has access prior, leading to wider blast radius. There are three mitigations to reduce such risk:</p><ol><li>Enforce MFA to minimise the chance of accounts being compromised.</li><li>Limit access to SSO-enabled systems through access control list (ACL).</li><li>Enforce conditional access. For example, identity provider can be configured to prompt for second-factor authentication when accessing a sensitive system, even when the user is already logged in using MFA before. Identity provider could also enforce phish-resistant MFA for access to sensitive systems.</li></ol><h2 id="SSO-in-Azure-AD">SSO in Azure AD <a href="#SSO-in-Azure-AD" class="headerlink" title="SSO in Azure AD">§</a></h2><p>Configuring a system to utilise Azure Active Directory (AAD) involves setting up <a href="https://en.wikipedia.org/wiki/Security_Assertion_Markup_Language" rel="noopener external nofollow noreferrer">SAML</a> and optionally <a href="https://en.wikipedia.org/wiki/System_for_Cross-domain_Identity_Management" rel="noopener external nofollow noreferrer">SCIM</a>. SCIM is only used to provision users, SAML can supply the necessary information (email, name, phone, etc) to the SSO-enabled system to create users on-demand upon first login (of that user) and update the user information in subsequent logins. In ServiceNow SAML configuration, under “User Provisioning” tab, on-demand user provision can be enabled by ticking “Auto Provisioning User” and “Update User Record Upon Each Login”.</p><p>During the initial SAML setup in ServiceNow, it requires a successful test login (using an AAD account, in this case) before SSO can be activated. This will fail if the user does not exist in ServiceNow yet. To pass it, simply create a new ServiceNow user that has the same email as the test AAD account. If you are confident the SAML setting is correct, the test login can be <a href="https://docs.servicenow.com/en-US/bundle/vancouver-platform-security/page/integrate/single-sign-on/task/t_TestIdPConnections.html" rel="noopener external nofollow noreferrer">made optional</a>. It is easier to utilise the “<a href="https://learn.microsoft.com/en-us/azure/active-directory/saas-apps/servicenow-tutorial#configure-servicenow" rel="noopener external nofollow noreferrer">Automatically configure</a> ServiceNow” option because it will also configure the transform mapping in ServiceNow which enables it to map SAML attributes (emailaddress, name, etc) to the respective ServiceNow’s sys_user table columns.</p><p>In SAML configuration, AAD uses the “user.userprincipalname” (UPN) attribute as the unique user identifier. UPN is <em>usually</em> equivalent to the email address, so the <a href="https://learn.microsoft.com/en-us/azure/active-directory/saas-apps/servicenow-tutorial#configure-servicenow" rel="noopener external nofollow noreferrer">AAD guide</a> recommends to change the user identifier to “email” in ServiceNow’s Multi-Provider SSO. However, it is possible for UPN to be different to email and will prevent affected users from accessing ServiceNow. UPN or email is also not immutable, a user may change their email to reflect a name change. This can results in duplicate users, if “Auto Provisioning User” is enabled in ServiceNow.</p><p>Even though <a href="#scim">SCIM</a> can avoid duplicates, users with a recently changed email may still face access issue for a while because AAD SCIM is not real-time and each sync can take up to <a href="https://learn.microsoft.com/en-us/azure/active-directory/app-provisioning/application-provisioning-when-will-provisioning-finish-specific-user#how-long-will-it-take-to-provision-users" rel="noopener external nofollow noreferrer">30 minutes</a>, longer if the attribute is sourced from on-premise AD (which will needs to be synced-up to AAD using AD Connect, and then to ServiceNow using SCIM).</p><p>To avoid this issue, there are three choices of source attribute that are immutable, each of them is suitable as a unique user identifier in SAML. They do not map with existing ServiceNow sys_user columns, so you will need a new column and a new mapping in the transform map.</p><ol><li><code>user.objectid</code>: for AAD-only environment.</li><li><code>user.onpremisesimmutableid</code>: refers to GUID. AAD uses this attribute as the primary key to identify on-premise AD user.</li><li><code>user.onpremisesecurityidentifier</code>: refers to SID, may not necessarily synced-up to AAD.</li></ol><h2 id="SCIM">SCIM <a href="#SCIM" class="headerlink" title="SCIM">§</a></h2><p>With on-demand user provision, it is possible to use SAML without SCIM. However, since a user is only created after the initial SSO login, user lookup will be limited. For example in ServiceNow, a support staff will not be able to enter the “this incident affects user X” field if that user has never login to ServiceNow before. SCIM can provision all users found in an identity provider into a target system. It is also possible to provision based on conditions, such as to exclude generic or service accounts.</p><p>Prior to configuring SCIM in ServiceNow, it is essential to disable SAML on-demand user provision “Auto Provisioning User” and “Update User Record Upon Each Login”. This is to avoid SAML-sourced attribute from overwriting SCIM’s in sys_user table, because SAML mapping does not necessarily match SCIM’s.</p><p>In AAD SCIM, the default primary mapping is userPrincipalName → user_name with user_name being set as the primary key (Show advanced options → Edit attribute list for ServiceNow). A mapping is considered as primary when it has “<a href="https://learn.microsoft.com/en-us/azure/active-directory/app-provisioning/customize-application-attributes" rel="noopener external nofollow noreferrer">Match objects using this attribute</a>“ enabled and has the lowest value in “Matching precedence”. “Match objects…” is to configure SCIM to utilise a mapping to check existence of each user, i.e. provision a user in the target system if it does not exist. Multiple mappings can be used in different order, in case a source attribute is empty. At least one mapping must have “Match objects…” enabled.</p><table><thead><tr><th>user</th><th>employeeId (AAD)</th><th>mail (AAD)</th><th>employee_number (SNow)</th><th>email (SNow)</th></tr></thead><tbody><tr><td>A</td><td>123</td><td><em>empty</em></td><td>123</td><td><em>empty</em></td></tr><tr><td>B</td><td><em>empty</em></td><td><a href="mailto:&#98;&#x40;&#101;&#x78;&#97;&#109;&#x70;&#x6c;&#x65;&#x2e;&#x63;&#x6f;&#109;" rel="noopener external nofollow noreferrer">&#98;&#x40;&#101;&#x78;&#97;&#109;&#x70;&#x6c;&#x65;&#x2e;&#x63;&#x6f;&#109;</a></td><td><em>empty</em></td><td><a href="mailto:&#98;&#64;&#x65;&#x78;&#x61;&#109;&#112;&#108;&#x65;&#x2e;&#99;&#x6f;&#109;" rel="noopener external nofollow noreferrer">&#98;&#64;&#x65;&#x78;&#x61;&#109;&#112;&#108;&#x65;&#x2e;&#99;&#x6f;&#109;</a></td></tr></tbody></table><p>What if user B has employeeId later on? There is a (unconfirmed) possibility that it can results in duplicate user B in the target system.</p><table><thead><tr><th>user</th><th>employeeId (AAD)</th><th>mail (AAD)</th><th>employee_number (SNow)</th><th>email (SNow)</th></tr></thead><tbody><tr><td>A</td><td>123</td><td><em>empty</em></td><td>123</td><td><em>empty</em></td></tr><tr><td>B</td><td>456</td><td><a href="mailto:&#98;&#x40;&#x65;&#x78;&#97;&#109;&#x70;&#108;&#101;&#46;&#99;&#x6f;&#x6d;" rel="noopener external nofollow noreferrer">&#98;&#x40;&#x65;&#x78;&#97;&#109;&#x70;&#108;&#101;&#46;&#99;&#x6f;&#x6d;</a></td><td><em>empty</em></td><td><a href="mailto:&#x62;&#x40;&#101;&#x78;&#x61;&#x6d;&#112;&#x6c;&#x65;&#46;&#x63;&#111;&#x6d;" rel="noopener external nofollow noreferrer">&#x62;&#x40;&#101;&#x78;&#x61;&#x6d;&#112;&#x6c;&#x65;&#46;&#x63;&#111;&#x6d;</a></td></tr><tr><td>B (<em>duplicate in SNow</em>)</td><td>456</td><td><a href="mailto:&#x62;&#x40;&#x65;&#x78;&#97;&#109;&#112;&#x6c;&#101;&#46;&#x63;&#x6f;&#x6d;" rel="noopener external nofollow noreferrer">&#x62;&#x40;&#x65;&#x78;&#97;&#109;&#112;&#x6c;&#101;&#46;&#x63;&#x6f;&#x6d;</a></td><td>456</td><td><a href="mailto:&#x62;&#64;&#x65;&#120;&#x61;&#109;&#x70;&#108;&#x65;&#46;&#99;&#111;&#x6d;" rel="noopener external nofollow noreferrer">&#x62;&#64;&#x65;&#120;&#x61;&#109;&#x70;&#108;&#x65;&#46;&#99;&#111;&#x6d;</a></td></tr></tbody></table><p>This can be avoided by using a <strong>mandatory</strong> and <strong>immutable</strong> AAD attribute. Similar to the three options mentioned in the previous section, they are:</p><ol><li><code>objectId</code></li><li><code>immutableId</code></li><li><code>onPremisesSecurityIdentifier</code></li></ol><p>Steps to configure:</p><ol><li>In ServiceNow, add a new column in sys_user ServiceNow table.</li><li>In AAD SCIM, Show advanced options → Edit attribute list for ServiceNow, add a new attribute with the same name as configured in previous step. Tick “Required” and “Primary”, untick “Primary” in existing attribute (usually “user_name”).</li><li>Add a new mapping with “Match objects” enabled.</li><li>Disable it in existing mapping (usually “userPrincipalName → user_name”).</li><li>Save</li></ol><h2 id="Single-space-value">Single-space value <a href="#Single-space-value" class="headerlink" title="Single-space value">§</a></h2><p>An interesting issue I encountered which was ultimately caused by an AAD attribute that had a value of just a single space. I initially configured a SCIM mapping as follow: Coalesce([attributeA], [attributeB]) → u*column_z. Coalesce() returns the first non-empty value. I knew attributeB is never empty, however somehow some users had *(blank)_ value in their u_column_z.</p><p>I fired up the Expression Builder in AAD SCIM and tried “Coalesce([attributeA], [attributeB])” on one of the affected users. It returned “Your expression is valid, but your expression evaluated to an empty string”. Tried “ToUpper([attributeA])”, same. Tried “IsNullorEmpty([attributeA])”, got “false”. If an attribute has empty value, it will return “null”. So, this meant attributeA is not empty. But what could it be?</p><pre><code class="hljs plaintext">IIF([attributeA]=&quot; &quot;, &quot;space&quot;, &quot;no space&quot;)

space</code><button class="copy-button">Copy</button></pre><p>AAD SCIM trims any leading and trailing whitespaces in the output, similar to <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/trim" rel="noopener external nofollow noreferrer"><code>trim()</code></a> JavaScript method.</p><p>Aside from an obvious fix by removing that space in AAD, a workaround like “Coalesce(Trim([attributeA]), [attributeB])” works too.</p></div><footer class="article-footer"><ul class="article-meta"><li><span class="label">Published Date:</span> <time class="dt-published" datetime="2023-08-27T00:00:00.000Z" itemprop="datePublished">27 <a href="/blog/2023/08/" title="See August 2023's posts">Aug</a> <a href="/blog/2023/" title="See 2023's posts">2023</a></time></li><li><span class="label">Tag:</span><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/azure-ad/" rel="tag">Azure-ad</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/servicenow/" rel="tag">Servicenow</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sso/" rel="tag">Sso</a></li></ul></li><li><span class="label">Source:</span> <a href="https://gitlab.com/curben/blog/-/blob/master/source/_posts/saml-scim.md" rel="noopener external nofollow noreferrer">saml-scim.md</a></li><hr></ul></footer></div><nav id="article-nav" class="article-nav"><span class="article-nav-link-wrap newer"><strong>Newer</strong> <a href="/blog/2023/10/01/splunk-ldapsearch-useraccountcontrol/"><div class="article-nav-title">Query LOCKOUT and PASSWORD_EXPIRED flags on Splunk SA-ldapsearch</div></a></span><span class="article-nav-link-wrap older"><strong>Older</strong> <a href="/blog/2023/07/17/ctrl-h-backspace/"><div class="article-nav-title">Mapping Ctrl+H to Backspace in terminal emulator</div></a></span></nav></article></div><footer id="footer" class="post-footer footer"><hr><div id="copyright" class="copyright">&copy; 2018-2024 Ming Di Leom. <a href="https://gitlab.com/curben/blog" rel="noopener external nofollow noreferrer">Powered by </a><a href="https://hexo.io/" rel="noopener external nofollow noreferrer">Hexo</a> with <a href="https://gitlab.com/curben/blog/tree/master/themes/chameleon" rel="noopener external nofollow noreferrer">Chameleon</a> theme.<br>Content is available under <a href="https://creativecommons.org/licenses/by-sa/4.0/" rel="noopener external nofollow noreferrer license" itemprop="license">CC-BY-SA 4.0</a>, unless indicated otherwise.<br><a class="main-nav-link" href="/disclaimer/">Disclaimer</a> <a class="main-nav-link" href="https://stats.uptimerobot.com/1394zup2LQ" rel="noopener external nofollow noreferrer">Status</a> <a class="main-nav-link" href="https://xw226dvxac7jzcpsf4xb64r4epr6o5hgn46dxlqk7gnjptakik6xnzqd.onion/" rel="noopener external nofollow noreferrer">Onion</a> <a class="main-nav-link" href="https://gitlab.com/curben/blog#mirrors" rel="noopener external nofollow noreferrer">Eepsite</a></div></footer><script src="/libs/clipboard-2.0.6.min.js" defer></script><script src="/js/copy-button.js"></script><script src="/js/chameleon.js"></script></body></html>