<!DOCTYPE html><html lang="en-GB"><head><meta charset="utf-8"><title>SSH certificate using Cloudflare Tunnel | Ming Di Leom&#39;s Blog</title><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="canonical" href="https://mdleom.com/blog/2023/02/13/ssh-certificate-cloudflare-tunnel/"><meta name="description" content="A quick quide to SSH certificate without using an identity provider."><meta property="article:author" content="Ming Di Leom"><meta property="article:tag" content="cloudflare"><meta property="og:type" content="article"><meta property="og:title" content="SSH certificate using Cloudflare Tunnel"><meta property="og:url" content="https://mdleom.com/blog/2023/02/13/ssh-certificate-cloudflare-tunnel/"><meta property="og:site_name" content="Ming Di Leom&#39;s Blog"><meta property="og:description" content="A quick quide to SSH certificate without using an identity provider."><meta property="og:locale" content="en_GB"><meta property="og:image" content="https://mdleom.com/screenshot/blog/2023/02/13/ssh-certificate-cloudflare-tunnel/"><meta property="article:published_time" content="2023-02-13T00:00:00.000Z"><meta property="article:modified_time" content="2023-02-21T00:00:00.000Z"><link rel="alternate" href="/atom.xml" title="Ming Di Leom's Blog" type="application/atom+xml"><link rel="icon" href="/favicon.ico"><link rel="icon" href="/svg/favicon.svg" type="image/svg+xml" sizes="any"><link rel="apple-touch-icon" href="/apple-touch-icon-180x180.png"><link rel="manifest" href="/site.webmanifest"><link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml"><link rel="stylesheet" href="/css/chameleon.css"><meta name="yandex-verification" content="e026a03a5dd06730"><meta name="generator" content="Hexo 7.1.1"></head><body><div id="container" class="container"><article id="post-ssh-certificate-cloudflare-tunnel" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting"><header id="header" class="header"><nav class="main-nav"><a class="main-nav-link" href="/">Home</a> <a class="main-nav-link" href="/blog/">Blog</a> <a class="main-nav-link" href="/about/">About</a> <a class="main-nav-link" href="/atom.xml">Feed</a> <a class="main-nav-link" href="https://gitlab.com/curben/blog" rel="noopener external nofollow noreferrer">GitLab</a><div class="search-container"><form id="searchForm" method="post" action="https://duckduckgo.com/" rel="noopener external nofollow noreferrer" role="search"><input type="search" name="q" class="search-box" placeholder="Search..." title="Powered by DuckDuckGo" enterkeyhint="search"> <input type="hidden" name="sites" value="mdleom.com"> <input type="hidden" name="kd" value="-1"> <input type="hidden" name="kg" value="p"> <input type="hidden" name="kae" value="#000"> <a class="search-button" id="search-click"><img src="/svg/search.svg"></a></form></div></nav><nav class="mobile-nav"><a class="site-title" href="/">mdleom.com</a><ul class="mobile-nav-menu"><label for="mobile-menu-toggle"><a class="no-underline" id="menu-button">&#9776;</a></label> <input id="mobile-menu-toggle" type="checkbox"><ul id="mobile-nav-link"><div class="search-container"><form id="searchFormMob" method="post" action="https://duckduckgo.com/" rel="noopener external nofollow noreferrer" role="search"><input type="search" name="q" class="search-box" placeholder="Search..." title="Powered by DuckDuckGo" enterkeyhint="search"> <input type="hidden" name="sites" value="mdleom.com"> <input type="hidden" name="kd" value="-1"> <input type="hidden" name="kg" value="p"> <input type="hidden" name="kae" value="#000"> <a class="search-button" id="search-click-mobile"><img src="/svg/search.svg"></a></form></div><i>Powered by DuckDuckGo</i> <a class="mobile-nav-link-a" href="/">Home</a> <a class="mobile-nav-link-a" href="/blog/">Blog</a> <a class="mobile-nav-link-a" href="/about/">About</a> <a class="mobile-nav-link-a" href="/atom.xml">Feed</a> <a class="mobile-nav-link-a" href="https://gitlab.com/curben/blog" rel="noopener external nofollow noreferrer">GitLab</a></ul></ul></nav></header><hr class="header-hr"><div class="article-inner"><header class="article-header"><h1 class="p-name entry-title article-title" itemprop="headline name">SSH certificate using Cloudflare Tunnel <a id="btnshare"><img src="/svg/share.svg"></a></h1></header><p class="p-summary">A quick quide to SSH certificate without using an identity provider.</p><div class="e-content article-entry" itemprop="articleBody"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction"><span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Prerequisites"><span class="toc-text">Prerequisites</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Cloudflare-Zero-Trust"><span class="toc-text">Cloudflare Zero Trust</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Add-an-application"><span class="toc-text">Add an application</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Generate-a-CA-certificate"><span class="toc-text">Generate a CA certificate</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Create-a-tunnel"><span class="toc-text">Create a tunnel</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Start-SSH-server"><span class="toc-text">Start SSH server</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Create-a-test-user"><span class="toc-text">Create a test user</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Matching-email-to-different-username"><span class="toc-text">Matching email to different username</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AuthorizedPrincipalsFile"><span class="toc-text">AuthorizedPrincipalsFile</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Browser-based-shell"><span class="toc-text">Browser-based shell</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Usage-monitoring"><span class="toc-text">Usage monitoring</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Inspect-user-certificate"><span class="toc-text">Inspect user certificate</span></a></li></ol><p>This article provides a quick-start guide to SSH certificate using Cloudflare Tunnel. More information can be found in the official docs.</p><ul><li><a href="https://blog.cloudflare.com/public-keys-are-not-enough-for-ssh-security/" rel="noopener external nofollow noreferrer">Public keys are not enough for SSH security</a></li><li><a href="https://developers.cloudflare.com/cloudflare-one/tutorials/ssh-cert-bastion/" rel="noopener external nofollow noreferrer">SSH with short-lived certificates</a></li><li><a href="https://developers.cloudflare.com/cloudflare-one/identity/users/short-lived-certificates/" rel="noopener external nofollow noreferrer">Configure short-lived certificates</a></li><li><a href="https://developers.cloudflare.com/cloudflare-one/applications/configure-apps/self-hosted-apps/" rel="noopener external nofollow noreferrer">Self-hosted applications</a></li><li><a href="https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/use_cases/ssh/" rel="noopener external nofollow noreferrer">Connect with SSH through Cloudflare Tunnel</a></li></ul><h2 id="Introduction">Introduction <a href="#Introduction" class="headerlink" title="Introduction">§</a></h2><p>One unpleasant task I had previously in an enterprise with Linux servers was SSH key management, specifically checking the SSH public keys of departed staff have been removed from the Ansible config. Then I learned from <a href="https://smallstep.com/blog/use-ssh-certificates/" rel="noopener external nofollow noreferrer">this article</a> that it is possible to SSH using a short-lived (&lt;1 day) certificate that is only issued to the user after successfully authenticate with the enterprise identity provider’s (e.g. Azure AD) single sign-on (SSO). This means once a user is revoked from the identity provider, that user would not be issued with a new certificate to SSH again the next day. At that time, I didn’t feel like configuring and integrating an identity provider, so I held off trying the feature.</p><p>Recently, I wanted to try out the Cloudflare Zero Trust free tier. While reading through the <a href="https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/use_cases/ssh/" rel="noopener external nofollow noreferrer">SSH configuration</a> guide, I found out that Cloudflare support issuing <a href="https://developers.cloudflare.com/cloudflare-one/identity/users/short-lived-certificates/" rel="noopener external nofollow noreferrer">SSH user certificate</a>. While Cloudflare supports several <a href="https://developers.cloudflare.com/cloudflare-one/identity/idp-integration/" rel="noopener external nofollow noreferrer">SSO integration</a>, it also supports authenticating using <a href="https://developers.cloudflare.com/cloudflare-one/identity/one-time-pin/" rel="noopener external nofollow noreferrer">one-time PIN</a> sent to an email address that does not have to be a Cloudflare account. Cloudflare also supports browser-based shell, just like the AWS <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager.html" rel="noopener external nofollow noreferrer">Session Manager</a>.</p><h2 id="Prerequisites">Prerequisites <a href="#Prerequisites" class="headerlink" title="Prerequisites">§</a></h2><ul><li>A domain hosted on Cloudflare DNS</li><li>Cloudflare Zero Trust (free for 50 users)</li><li>A VM or cloud instance (optional, easier to clean up)</li></ul><h2 id="Cloudflare-Zero-Trust">Cloudflare Zero Trust <a href="#Cloudflare-Zero-Trust" class="headerlink" title="Cloudflare Zero Trust">§</a></h2><p>Navigate to <strong>Zero Trust</strong> page shown on the sidebar after you login to <a href="https://dash.cloudflare.com/" rel="noopener external nofollow noreferrer">dash.cloudflare.com</a>. If this is your first time, Cloudflare will ask for billing info in which you can use an existing one or add a new credit card. You won’t get charged as long as you stay within the <strong>free tier</strong> (50 users), I will show you how to check later in this article.</p><p>The setup will then ask you to name your team domain <em>team-name</em>.cloudflareaccess.com. Just create a random name for now, you can always change it later.</p><h2 id="Add-an-application">Add an application <a href="#Add-an-application" class="headerlink" title="Add an application">§</a></h2><p>Once you’re in Zero Trust console, navigate to <strong>Access</strong> → <strong>Applications</strong>. <strong>Add an application</strong> and choose <strong>Self-hosted</strong>.</p><p><strong>Configure app</strong> tab,</p><ul><li>Application name: any name</li><li>Session duration: 15 minutes.<ul><li>In a corporate environment, “6 hours” is probably more user-friendly.</li><li>For sensitive server, consider “No duration”.</li></ul></li><li>Application domain: test.yourdomain.com<ul><li>The subdomain should not have an existing website.</li><li>It may be possible to use an existing website, by specifying test.yourdomain.com&#x2F;custom-path for SSH, though I haven’t try it.</li></ul></li><li>App Launcher visbility: No</li><li>Accept all available identity providers: No, unless you have integrated an identity provider.</li><li>Select One-time PIN</li><li>Instant Auth: Yes</li></ul><p><strong>Add policies</strong> tab,</p><ul><li>Policy name: any name</li><li>Action: Allow</li><li>Session duration: same</li><li>Configure rules: (Include) Emails &#x3D; an email address<ul><li>Any of your email is fine, regardless whether it’s a Cloudflare account.</li><li>Cloudflare <em>will not</em> create an account using that email, it will only be used to receive one-time PIN.</li></ul></li></ul><p><strong>Setup</strong> tab:</p><ul><li>CORS settings: leave it as is</li><li>Cookies settings:<ul><li>SameSite Attribute: blank or Lax<ul><li>Either setting is practically the same, browsers default to Lax when SameSite is not set.</li><li>“Strict” value cannot be used because Cloudflare will authenticate the user on <em>team-name</em>.cloudflareaccess.com and issue a cookie on test.yourdomain.com.</li></ul></li><li>HTTP Only: Yes</li></ul></li><li>Additional settings:<ul><li>Enable automatic cloudflared authentication: Yes</li><li>Browser rendering: SSH</li></ul></li></ul><h2 id="Generate-a-CA-certificate">Generate a CA certificate <a href="#Generate-a-CA-certificate" class="headerlink" title="Generate a CA certificate">§</a></h2><p>Navigate to <strong>Access</strong> → <strong>Service Auth</strong> → <strong>SSH</strong> tab. Select the application you just created and <strong>Generate certificate</strong>.</p><p>Copy the generated public key and save it to <code>/etc/ssh/ca.pub</code> in your host (the host you’re going to SSH into).</p><pre><code class="hljs plaintext">sudo -e /etc/ssh/ca.pub</code><button class="copy-button">Copy</button></pre><h2 id="Create-a-tunnel">Create a tunnel <a href="#Create-a-tunnel" class="headerlink" title="Create a tunnel">§</a></h2><p>Navigate to <strong>Access</strong> → <strong>Tunnels</strong></p><ul><li>Name: any name</li></ul><p><strong>Install connector</strong> tab, choose the relevant OS and run the installation command. Once installed, you should see “connected” status.</p><p><strong>Route tunnel</strong> tab,</p><ul><li>Public hostname: test.yourdomain.com<ul><li>This is the application domain in the <a href="#Add-an-application">Add an application</a> step.</li></ul></li><li>Service<ul><li>SSH type: URL &#x3D; localhost:22<ul><li>Replace 22 with the custom SSH port you are going to use.</li></ul></li></ul></li></ul><p>After finishing creating a tunnel, you should have a new CNAME DNS record that points to <em>tunnel-id</em>.cfargotunnel.com. If there is no CNAME entry, grab the tunnel ID and create a new DNS record.</p><h2 id="Start-SSH-server">Start SSH server <a href="#Start-SSH-server" class="headerlink" title="Start SSH server">§</a></h2><p>Install <code>openssh-server</code>.</p><p><code>sudo -e /etc/ssh/sshd_config.d/cf.conf</code></p><pre><div class="caption"><span>/etc/ssh/sshd_config.d/cf.conf</span></div><code class="hljs plain">TrustedUserCAKeys /etc/ssh/ca.pub
ListenAddress 127.0.0.1
ListenAddress ::1
PasswordAuthentication no
# Uncomment below line for custom port
# Port 1234</code><button class="copy-button">Copy</button></pre><p><code>systemctl restart ssh</code> or <code>systemctl restart sshd</code></p><h2 id="Create-a-test-user">Create a test user <a href="#Create-a-test-user" class="headerlink" title="Create a test user">§</a></h2><p>The easiest setup is one where a Unix username matches the email that you configured to receive one-time PIN in previous steps. For example, if you set <strong>loremipsum</strong>@youremail.com, then create a new user <strong>loremipsum</strong>.</p><p><code>sudo adduser loremipsum</code></p><p>Set a random password and leave everything else blank.</p><h3 id="Matching-email-to-different-username">Matching email to different username <a href="#Matching-email-to-different-username" class="headerlink" title="Matching email to different username">§</a></h3><p>To match <strong>loremipsum</strong>@youremail.com to <strong>lipsum</strong> user:</p><pre><div class="caption"><span>/etc/ssh/sshd_config.d/cf.conf</span></div><code class="hljs plain">Match user lipsum
  AuthorizedPrincipalsCommand /bin/echo &#x27;loremipsum&#x27;
  AuthorizedPrincipalsCommandUser nobody</code><button class="copy-button">Copy</button></pre><p><strong>loremipsum+somealias</strong>@youremail.com also works.</p><pre><div class="caption"><span>/etc/ssh/sshd_config.d/cf.conf</span></div><code class="hljs plain">Match user lipsum
  AuthorizedPrincipalsCommand /bin/echo &#x27;loremipsum+somealias&#x27;
  AuthorizedPrincipalsCommandUser nobody</code><button class="copy-button">Copy</button></pre><h3 id="AuthorizedPrincipalsFile">AuthorizedPrincipalsFile <a href="#AuthorizedPrincipalsFile" class="headerlink" title="AuthorizedPrincipalsFile">§</a></h3><p>For NixOS user, <code>AuthorizedPrincipalsCommand</code> will not work because the command will run within “&#x2F;nix&#x2F;store” but it is read-only. Instead, you should use <code>AuthorizedPrincipalsFile</code>. This config also enables you to match multiple emails to a username, just separate each email user by newline. This applies to all OpenSSH instances, not just NixOS.</p><p><code>echo &#39;loremipsum&#39; | sudo tee /etc/ssh/authorized_principals</code></p><pre><div class="caption"><span>/etc/nixos/configuration.nix</span></div><code class="hljs nix">  services.<span class="hljs-attr">openssh</span> = &#123;
    <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-attr">permitRootLogin</span> = <span class="hljs-string">&quot;no&quot;</span>;
    <span class="hljs-attr">passwordAuthentication</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-comment"># ports = [ 1234 ];</span>
    <span class="hljs-attr">extraConfig</span> =
      <span class="hljs-string">&#x27;&#x27;</span>
<span class="hljs-string">        TrustedUserCAKeys /etc/ssh/ca.pub</span>
<span class="hljs-string">        Match User lipsum</span>
<span class="hljs-string">          AuthorizedPrincipalsFile /etc/ssh/authorized_principals</span>
<span class="hljs-string">          # if there is no existing AuthenticationMethods</span>
<span class="hljs-string">          AuthenticationMethods publickey</span>
<span class="hljs-string">      &#x27;&#x27;</span>;
  &#125;;
```

<span class="hljs-comment">### Other use cases</span>

https://developers.cloudflare.com/cloudflare-one/identity/users/short-lived-certificates/<span class="hljs-comment">#2-ensure-unix-usernames-match-user-sso-identities</span>

<span class="hljs-comment">## Initiate SSH connection</span>

Install `cloudflared` on the host that you&#x27;re going to SSH from.

`cloudflared access ssh-config --hostname test.yourdomain.com --short-lived-cert`

Example output:

```plain ~/.ssh/config
Match host test.yourdomain.com exec <span class="hljs-string">&quot;/usr/local/bin/cloudflared access ssh-gen --hostname %h&quot;</span>
    ProxyCommand /usr/local/bin/cloudflared access ssh --hostname %h
    IdentityFile ~/.cloudflared/%h-cf_key
    CertificateFile ~/.cloudflared/%h-cf_key-cert.pub</code><button class="copy-button">Copy</button></pre><p>or</p><pre><div class="caption"><span>~/.ssh/config</span></div><code class="hljs plain">Host test.yourdomain.com
    ProxyCommand bash -c &#x27;/usr/local/bin/cloudflared access ssh-gen --hostname %h; ssh -tt %r@cfpipe-test.yourdomain.com &gt;&amp;2 &lt;&amp;1&#x27;

Host cfpipe-test.yourdomain.com
    HostName test.yourdomain.com
    ProxyCommand /usr/local/bin/cloudflared access ssh --hostname %h
    IdentityFile ~/.cloudflared/test.yourdomain.com-cf_key
    CertificateFile ~/.cloudflared/test.yourdomain.com-cf_key-cert.pub</code><button class="copy-button">Copy</button></pre><p>Save the output to <code>$HOME/.ssh/config</code>.</p><p>Now, the moment of truth.</p><p><code>ssh loremipsum@test.yourdomain.com</code> (replace the username with the one you created in <a href="#Create-a-test-user">Create a test user</a> step.)</p><p>The terminal should launch a website to <em>team-name</em>.cloudflareaccess.com. Enter the email you configured in <a href="#Add-an-application">Add an application</a> step and then enter the received 6-digit PIN.</p><p>Back to the terminal, wait for at least 5 seconds and you should see the usual SSH authentication.</p><blockquote><p>You may wondering why you still see fingerprint warning, I find this article <a href="https://goteleport.com/blog/how-to-ssh-properly/" rel="noopener external nofollow noreferrer">SSH Best Practices using Certificates, 2FA and Bastions</a> explains it well.</p></blockquote><h2 id="Browser-based-shell">Browser-based shell <a href="#Browser-based-shell" class="headerlink" title="Browser-based shell">§</a></h2><p>As a bonus, head to test.yourdomain.com (see <a href="#Add-an-application">Add an application</a> step) which will redirect you to a login page just the previous step. After login with a 6-digit PIN, you shall see a browser-based shell.</p><h2 id="Usage-monitoring">Usage monitoring <a href="#Usage-monitoring" class="headerlink" title="Usage monitoring">§</a></h2><p>Head to <strong>Settings</strong> → <strong>Account</strong> to monitor how many users you have, each email address you configured to receive one-time PIN is counted as one user.</p><p>To delete user(s), head to <strong>Users</strong>, tick the relevant users, <strong>Update status</strong> and then <strong>Remove</strong>. The seat usage column should show <em>Inactive</em>.</p><h2 id="Inspect-user-certificate">Inspect user certificate <a href="#Inspect-user-certificate" class="headerlink" title="Inspect user certificate">§</a></h2><p><code>ssh-keygen -L -f ~/.cloudflared/test.yourdomain.com-cf_key-cert.pub</code></p></div><footer class="article-footer"><ul class="article-meta"><li><span class="label">Last Updated:</span> <time class="dt-updated" datetime="2023-02-21T00:00:00.000Z" itemprop="dateModified">21 Feb 2023</time></li><li><span class="label">Published Date:</span> <time class="dt-published" datetime="2023-02-13T00:00:00.000Z" itemprop="datePublished">13 <a href="/blog/2023/02/" title="See February 2023's posts">Feb</a> <a href="/blog/2023/" title="See 2023's posts">2023</a></time></li><li><span class="label">Tag:</span><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cloudflare/" rel="tag">Cloudflare</a></li></ul></li><li><span class="label">Source:</span> <a href="https://gitlab.com/curben/blog/-/blob/master/source/_posts/ssh-certificate-cloudflare-tunnel.md" rel="noopener external nofollow noreferrer">ssh-certificate-cloudflare-tunnel.md</a></li><hr></ul></footer></div><nav id="article-nav" class="article-nav"><span class="article-nav-link-wrap newer"><strong>Newer</strong> <a href="/blog/2023/04/16/splunk-lookup-malware-filter/"><div class="article-nav-title">Malicious website detection on Splunk using malware-filter</div></a></span><span class="article-nav-link-wrap older"><strong>Older</strong> <a href="/blog/2022/11/27/grub-luks2-argon2/"><div class="article-nav-title">Enable LUKS2 and Argon2 support for Grub in Manjaro/Arch</div></a></span></nav></article></div><footer id="footer" class="post-footer footer"><hr><div id="copyright" class="copyright">&copy; 2018-2024 Ming Di Leom. <a href="https://gitlab.com/curben/blog" rel="noopener external nofollow noreferrer">Powered by </a><a href="https://hexo.io/" rel="noopener external nofollow noreferrer">Hexo</a> with <a href="https://gitlab.com/curben/blog/tree/master/themes/chameleon" rel="noopener external nofollow noreferrer">Chameleon</a> theme.<br>Content is available under <a href="https://creativecommons.org/licenses/by-sa/4.0/" rel="noopener external nofollow noreferrer license" itemprop="license">CC-BY-SA 4.0</a>, unless indicated otherwise.<br><a class="main-nav-link" href="/disclaimer/">Disclaimer</a> <a class="main-nav-link" href="https://stats.uptimerobot.com/1394zup2LQ" rel="noopener external nofollow noreferrer">Status</a> <a class="main-nav-link" href="https://xw226dvxac7jzcpsf4xb64r4epr6o5hgn46dxlqk7gnjptakik6xnzqd.onion/" rel="noopener external nofollow noreferrer">Onion</a> <a class="main-nav-link" href="https://gitlab.com/curben/blog#mirrors" rel="noopener external nofollow noreferrer">Eepsite</a></div></footer><script src="/libs/clipboard-2.0.6.min.js" defer></script><script src="/js/copy-button.js"></script><script src="/js/chameleon.js"></script></body></html>