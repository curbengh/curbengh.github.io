<!DOCTYPE html><html lang="en-GB"><head><meta charset="utf-8"><title>Malicious website detection on Splunk using malware-filter | Ming Di Leom&#39;s Blog</title><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="canonical" href="https://mdleom.com/blog/2023/04/16/splunk-lookup-malware-filter/"><meta name="description" content="A guide on using malware-filter lookups"><meta property="article:author" content="Ming Di Leom"><meta property="article:tag" content="splunk"><meta property="og:type" content="article"><meta property="og:title" content="Malicious website detection on Splunk using malware-filter"><meta property="og:url" content="https://mdleom.com/blog/2023/04/16/splunk-lookup-malware-filter/"><meta property="og:site_name" content="Ming Di Leom&#39;s Blog"><meta property="og:description" content="A guide on using malware-filter lookups"><meta property="og:locale" content="en_GB"><meta property="og:image" content="https://mdleom.com/screenshot/blog/2023/04/16/splunk-lookup-malware-filter/"><meta property="article:published_time" content="2023-04-16T00:00:00.000Z"><link rel="alternate" href="/atom.xml" title="Ming Di Leom's Blog" type="application/atom+xml"><link rel="icon" href="/favicon.ico"><link rel="icon" href="/svg/favicon.svg" type="image/svg+xml" sizes="any"><link rel="apple-touch-icon" href="/apple-touch-icon-180x180.png"><link rel="manifest" href="/site.webmanifest"><link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml"><link rel="stylesheet" href="/css/chameleon.css"><meta name="yandex-verification" content="e026a03a5dd06730"><meta name="generator" content="Hexo 7.1.1"></head><body><div id="container" class="container"><article id="post-splunk-lookup-malware-filter" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting"><header id="header" class="header"><nav class="main-nav"><a class="main-nav-link" href="/">Home</a> <a class="main-nav-link" href="/blog/">Blog</a> <a class="main-nav-link" href="/about/">About</a> <a class="main-nav-link" href="/atom.xml">Feed</a> <a class="main-nav-link" href="https://gitlab.com/curben/blog" rel="noopener external nofollow noreferrer">GitLab</a><div class="search-container"><form id="searchForm" method="post" action="https://duckduckgo.com/" rel="noopener external nofollow noreferrer" role="search"><input type="search" name="q" class="search-box" placeholder="Search..." title="Powered by DuckDuckGo" enterkeyhint="search"> <input type="hidden" name="sites" value="mdleom.com"> <input type="hidden" name="kd" value="-1"> <input type="hidden" name="kg" value="p"> <input type="hidden" name="kae" value="#000"> <a class="search-button" id="search-click"><img src="/svg/search.svg"></a></form></div></nav><nav class="mobile-nav"><a class="site-title" href="/">mdleom.com</a><ul class="mobile-nav-menu"><label for="mobile-menu-toggle"><a class="no-underline" id="menu-button">&#9776;</a></label> <input id="mobile-menu-toggle" type="checkbox"><ul id="mobile-nav-link"><div class="search-container"><form id="searchFormMob" method="post" action="https://duckduckgo.com/" rel="noopener external nofollow noreferrer" role="search"><input type="search" name="q" class="search-box" placeholder="Search..." title="Powered by DuckDuckGo" enterkeyhint="search"> <input type="hidden" name="sites" value="mdleom.com"> <input type="hidden" name="kd" value="-1"> <input type="hidden" name="kg" value="p"> <input type="hidden" name="kae" value="#000"> <a class="search-button" id="search-click-mobile"><img src="/svg/search.svg"></a></form></div><i>Powered by DuckDuckGo</i> <a class="mobile-nav-link-a" href="/">Home</a> <a class="mobile-nav-link-a" href="/blog/">Blog</a> <a class="mobile-nav-link-a" href="/about/">About</a> <a class="mobile-nav-link-a" href="/atom.xml">Feed</a> <a class="mobile-nav-link-a" href="https://gitlab.com/curben/blog" rel="noopener external nofollow noreferrer">GitLab</a></ul></ul></nav></header><hr class="header-hr"><div class="article-inner"><header class="article-header"><h1 class="p-name entry-title article-title" itemprop="headline name">Malicious website detection on Splunk using malware-filter <a id="btnshare"><img src="/svg/share.svg"></a></h1></header><p class="p-summary">A guide on using malware-filter lookups</p><div class="e-content article-entry" itemprop="articleBody"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Lookup-file-locations"><span class="toc-text">Lookup file locations</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#inputlookup-basics"><span class="toc-text">inputlookup basics</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Search-for-specific-events"><span class="toc-text">Search for specific events</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Wildcard"><span class="toc-text">Wildcard</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Wildcard-prefix"><span class="toc-text">Wildcard prefix</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Matching-multiple-fields"><span class="toc-text">Matching multiple fields</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Matching-individual-and-multiple-fields"><span class="toc-text">Matching individual and multiple fields</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Case-insensitive"><span class="toc-text">Case-insensitive</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CIDR-matching"><span class="toc-text">CIDR matching</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#inputlookup-lookup"><span class="toc-text">inputlookup + lookup</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lookup-definition"><span class="toc-text">Lookup definition</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Case-sensitive"><span class="toc-text">Case-sensitive</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Wildcard-lookup"><span class="toc-text">Wildcard (lookup)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CIDR-matching-lookup"><span class="toc-text">CIDR-matching (lookup)</span></a></li></ol></li></ol><p><a href="https://gitlab.com/malware-filter/splunk-malware-filter" rel="noopener external nofollow noreferrer">Splunk Add-on for malware-filter</a> includes the following CSV files:</p><ul><li>botnet-filter-splunk.csv</li><li>botnet_ip.csv</li><li>opendbl_ip.csv</li><li>phishing-filter-splunk.csv</li><li>pup-filter-splunk.csv</li><li>urlhaus-filter-splunk-online.csv</li><li>vn-badsite-filter-splunk.csv</li></ul><p>These CSV files can be used as <a href="https://docs.splunk.com/Documentation/Splunk/latest/Knowledge/Aboutlookupsandfieldactions" rel="noopener external nofollow noreferrer">lookups</a> to find potentially malicious traffic. They contain a list of bad IPs&#x2F;domains&#x2F;URLs and we are going to look for those values in the <a href="https://docs.splunk.com/Splexicon:Event" rel="noopener external nofollow noreferrer">events</a>.</p><p>We can view the content of a lookup file by using <a href="https://docs.splunk.com/Documentation/Splunk/latest/SearchReference/Inputlookup" rel="noopener external nofollow noreferrer"><code>inputlookup</code></a>. When using that command, there should always be a leading pipe character “|” because it is an <a href="https://docs.splunk.com/Splexicon:Generatingcommand" rel="noopener external nofollow noreferrer">event-generating</a> command.</p><h2 id="Lookup-file-locations">Lookup file locations <a href="#Lookup-file-locations" class="headerlink" title="Lookup file locations">§</a></h2><p>Lookup file can be uploaded via <a href="https://docs.splunk.com/Documentation/Splunk/latest/Knowledge/Usefieldlookupstoaddinformationtoyourevents#Upload_the_lookup_table_file" rel="noopener external nofollow noreferrer">Splunk Web</a> or creating the file in the following locations:</p><ul><li><code>$SPLUNK_HOME/etc/users/&lt;username&gt;/&lt;app_name&gt;/lookups/</code></li><li><code>$SPLUNK_HOME/etc/apps/&lt;app_name&gt;/lookups/</code></li><li><code>$SPLUNK_HOME/etc/system/lookups/</code></li></ul><p>In Splunk Web, setting the permission to app-sharing or global-sharing will automatically moves the file to the second or third location respectively. Uploaded lookup file can be used straight away without having to reload app or restart Splunk, regardless of which way it was created.</p><h2 id="inputlookup-basics">inputlookup basics <a href="#inputlookup-basics" class="headerlink" title="inputlookup basics">§</a></h2><pre><code class="hljs spl">| inputlookup botnet_ip.csv</code><button class="copy-button">Copy</button></pre><blockquote><p><code>_time</code> field is omitted for brevity.</p></blockquote><table><thead><tr><th>first_seen_utc</th><th>dst_ip</th><th>dst_port</th><th>c2_status</th><th>last_online</th><th>malware</th><th>updated</th></tr></thead><tbody><tr><td>2021-05-16 19:49:33</td><td>1.2.3.4</td><td>1234</td><td>online</td><td>2023-03-05</td><td>Lorem</td><td>2023-03-04T16:41:17Z</td></tr></tbody></table><p>The output is no different to any other event, we can specify which fields to be displayed and then rename the fields.</p><pre><code class="hljs spl">| inputlookup botnet_ip.csv | fields dst_ip | rename dst_ip AS dst</code><button class="copy-button">Copy</button></pre><table><thead><tr><th>dst</th></tr></thead><tbody><tr><td>178.128.23.9</td></tr></tbody></table><h2 id="Search-for-specific-events">Search for specific events <a href="#Search-for-specific-events" class="headerlink" title="Search for specific events">§</a></h2><p>Example firewall events:</p><pre><code class="hljs spl">index=firewall</code><button class="copy-button">Copy</button></pre><table><thead><tr><th>src</th><th>src_port</th><th>dst</th><th>action</th></tr></thead><tbody><tr><td>192.168.1.5</td><td>45454</td><td>1.2.3.4</td><td>allowed</td></tr><tr><td>192.168.1.3</td><td>45452</td><td>7.6.5.4</td><td>allowed</td></tr><tr><td>192.168.1.4</td><td>45457</td><td>4.3.2.1</td><td>allowed</td></tr><tr><td>192.168.1.6</td><td>45451</td><td>7.7.5.5</td><td>allowed</td></tr></tbody></table><p>Notice the second row’s <code>dst</code> value matches <code>dst_port</code> value of the example lookup table shown in the <a href="#inputlookup-basics">previous section</a>.</p><p>To match for <code>dst</code> value of the firewall events and <code>dst_ip</code> of the lookup file, use a <a href="https://docs.splunk.com/Documentation/SplunkCloud/latest/SearchTutorial/Useasubsearch" rel="noopener external nofollow noreferrer">subsearch</a> with <code>inputlookup</code>. In this example, the subsearch extracts only the <code>dst_ip</code> field and rename it to <code>dst</code> in order to match the same field in the firewall events.</p><pre><code class="hljs spl">index=firewall [| inputlookup botnet_ip.csv | fields dst_ip | rename dst_ip AS dst]</code><button class="copy-button">Copy</button></pre><table><thead><tr><th>src</th><th>src_port</th><th>dst</th><th>action</th></tr></thead><tbody><tr><td>192.168.1.5</td><td>45454</td><td>1.2.3.4</td><td>allowed</td></tr></tbody></table><p>To display events in table format, append <code>| table *</code></p><h2 id="Wildcard">Wildcard <a href="#Wildcard" class="headerlink" title="Wildcard">§</a></h2><p>Asterisk character (<code>*</code>) in the lookup file does work as a <a href="https://docs.splunk.com/Documentation/SCS/current/Search/Wildcards" rel="noopener external nofollow noreferrer">wildcard</a>.</p><pre><code class="hljs spl">index=proxy</code><button class="copy-button">Copy</button></pre><table><thead><tr><th>src</th><th>url</th><th>dst_port</th></tr></thead><tbody><tr><td>192.168.1.5</td><td>foo.com&#x2F;path1</td><td>443</td></tr><tr><td>192.168.1.3</td><td>foo.com&#x2F;path2</td><td>443</td></tr><tr><td>192.168.1.4</td><td>bar.com&#x2F;path3</td><td>443</td></tr></tbody></table><p>The lookup files do not include wildcard affix.</p><pre><code class="hljs spl">| inputlookup urlhaus-filter-splunk-online.csv</code><button class="copy-button">Copy</button></pre><table><thead><tr><th>host</th><th>path</th><th>message</th><th>updated</th></tr></thead><tbody><tr><td>foo.com</td><td></td><td>urlhaus-filter malicious website detected</td><td>2023-03-13T00:11:20Z</td></tr></tbody></table><p>The add-on includes <a href="https://gitlab.com/malware-filter/splunk-malware-filter#geturlhausfilter" rel="noopener external nofollow noreferrer"><code>geturlhausfilter</code></a> command along with other commands to update their respective lookup file. Those commands has <code>wildcard_suffix</code> argument to append wildcard to the field’s values.</p><pre><code class="hljs plaintext">| geturlhausfilter wildcard_suffix=host
| outputlookup override_if_empty=false urlhaus-filter-splunk-online.csv</code><button class="copy-button">Copy</button></pre><table><thead><tr><th>host</th><th>path</th><th>message</th><th>updated</th><th>host_wildcard_suffix</th></tr></thead><tbody><tr><td>foo.com</td><td></td><td>urlhaus-filter malicious website detected</td><td>2023-03-13T00:11:20Z</td><td>foo.com*</td></tr></tbody></table><pre><code class="hljs spl">index=proxy [| inputlookup urlhaus-filter-splunk-online.csv | fields host_wildcard_suffix | rename host_wildcard_suffix AS url ]</code><button class="copy-button">Copy</button></pre><table><thead><tr><th>src</th><th>url</th><th>dst_port</th></tr></thead><tbody><tr><td>192.168.1.5</td><td>foo.com&#x2F;path1</td><td>443</td></tr><tr><td>192.168.1.3</td><td>foo.com&#x2F;path2</td><td>443</td></tr></tbody></table><h3 id="Wildcard-prefix">Wildcard prefix <a href="#Wildcard-prefix" class="headerlink" title="Wildcard prefix">§</a></h3><p>Previous section showed an example using wildcard suffix (“foo.com*“). Wildcard also works as a prefix (“*foo.com”) or even in the middle (“f*o.com”), though these are <a href="https://docs.splunk.com/Documentation/SCS/current/Search/Wildcards#When_to_avoid_wildcard_characters" rel="noopener external nofollow noreferrer">discouraged</a>.</p><pre><code class="hljs spl">index=proxy</code><button class="copy-button">Copy</button></pre><table><thead><tr><th>src</th><th>domain</th><th>dst_port</th></tr></thead><tbody><tr><td>192.168.1.5</td><td>foo.com</td><td>443</td></tr><tr><td>192.168.1.3</td><td>lorem.foo.com</td><td>443</td></tr><tr><td>192.168.1.4</td><td>bar.com</td><td>443</td></tr></tbody></table><pre><code class="hljs spl">| geturlhausfilter wildcard_prefix=host
| outputlookup override_if_empty=false urlhaus-filter-splunk-online.csv</code><button class="copy-button">Copy</button></pre><table><thead><tr><th>host</th><th>path</th><th>message</th><th>updated</th><th>host_wildcard_prefix</th></tr></thead><tbody><tr><td>foo.com</td><td></td><td>urlhaus-filter malicious website detected</td><td>2023-03-13T00:11:20Z</td><td>*foo.com</td></tr></tbody></table><pre><code class="hljs spl">index=proxy [| inputlookup urlhaus-filter-splunk-online.csv | fields host_wildcard_prefix | rename host_wildcard_prefix AS domain ]</code><button class="copy-button">Copy</button></pre><table><thead><tr><th>src</th><th>domain</th><th>dst_port</th></tr></thead><tbody><tr><td>192.168.1.5</td><td>foo.com</td><td>443</td></tr><tr><td>192.168.1.3</td><td>lorem.foo.com</td><td>443</td></tr></tbody></table><h2 id="Matching-multiple-fields">Matching multiple fields <a href="#Matching-multiple-fields" class="headerlink" title="Matching multiple fields">§</a></h2><p>File hosting services like Google Docs and Dropbox are commonly abused to host phishing website. For those sites, the lookup should match both domain and path. When specifying more than one field in <code>fields</code> command, all fields will be matched using AND condition.</p><pre><code class="hljs spl">index=proxy</code><button class="copy-button">Copy</button></pre><table><thead><tr><th>src</th><th>domain</th><th>path</th></tr></thead><tbody><tr><td>192.168.1.5</td><td>foo.com</td><td>document1.html</td></tr><tr><td>192.168.1.3</td><td>foo.com</td><td>document2.html</td></tr><tr><td>192.168.1.4</td><td>foo.com</td><td>document3.html</td></tr></tbody></table><pre><code class="hljs spl">| inputlookup urlhaus-filter-splunk-online.csv</code><button class="copy-button">Copy</button></pre><table><thead><tr><th>host</th><th>path</th><th>message</th><th>updated</th></tr></thead><tbody><tr><td>foo.com</td><td>document1.html</td><td>urlhaus-filter malicious website detected</td><td>2023-03-13T00:11:20Z</td></tr></tbody></table><pre><code class="hljs spl">index=proxy [| inputlookup urlhaus-filter-splunk-online.csv | fields host, path | rename host AS domain ]</code><button class="copy-button">Copy</button></pre><table><thead><tr><th>src</th><th>domain</th><th>path</th></tr></thead><tbody><tr><td>192.168.1.5</td><td>foo.com</td><td>document1.html</td></tr></tbody></table><h3 id="Matching-individual-and-multiple-fields">Matching individual and multiple fields <a href="#Matching-individual-and-multiple-fields" class="headerlink" title="Matching individual and multiple fields">§</a></h3><p>A lookup file may have rows with empty <code>path</code> to denote a <code>domain</code> should be blocked regardless of paths, while also having rows with both <code>domain</code> and <code>path</code> to denote a specific URL should be blocked instead. The syntax is the same as what was shown in the <a href="#Matching-multiple-fields">previous section</a> because Splunk will only match <strong>non-empty</strong> values, empty values will be ignored instead.</p><pre><code class="hljs spl">index=proxy</code><button class="copy-button">Copy</button></pre><table><thead><tr><th>src</th><th>domain</th><th>path</th></tr></thead><tbody><tr><td>192.168.1.5</td><td>bad-domain.com</td><td>lorem-ipsum.html</td></tr><tr><td>192.168.1.3</td><td>bad-domain.com</td><td>foo-bar.html</td></tr><tr><td>192.168.1.4</td><td>docs.google.com</td><td>malware.exe</td></tr><tr><td>192.168.1.4</td><td>docs.google.com</td><td>safe.doc</td></tr></tbody></table><pre><code class="hljs spl">| inputlookup urlhaus-filter-splunk-online.csv</code><button class="copy-button">Copy</button></pre><table><thead><tr><th>host</th><th>path</th><th>message</th><th>updated</th></tr></thead><tbody><tr><td>bad-domain.com</td><td></td><td>urlhaus-filter malicious website detected</td><td>2023-03-13T00:11:20Z</td></tr><tr><td>docs.google.com</td><td>malware.exe</td><td>urlhaus-filter malicious website detected</td><td>2023-03-13T00:11:20Z</td></tr></tbody></table><pre><code class="hljs spl">index=proxy [| inputlookup urlhaus-filter-splunk-online.csv | fields host, path | rename host AS domain ]</code><button class="copy-button">Copy</button></pre><table><thead><tr><th>src</th><th>domain</th><th>path</th></tr></thead><tbody><tr><td>192.168.1.5</td><td>bad-domain.com</td><td>lorem-ipsum.html</td></tr><tr><td>192.168.1.3</td><td>bad-domain.com</td><td>foo-bar.html</td></tr><tr><td>192.168.1.4</td><td>docs.google.com</td><td>malware.exe</td></tr></tbody></table><h2 id="Case-insensitive">Case-insensitive <a href="#Case-insensitive" class="headerlink" title="Case-insensitive">§</a></h2><p>Lookup file is case-insensitive. If case-sensitive matching is required, use <code>lookup</code> and lookup definition.</p><pre><code class="hljs spl">index=proxy</code><button class="copy-button">Copy</button></pre><table><thead><tr><th>src</th><th>domain</th></tr></thead><tbody><tr><td>192.168.1.5</td><td>loremipsum.com</td></tr></tbody></table><pre><code class="hljs spl">| inputlookup urlhaus-filter-splunk-online.csv</code><button class="copy-button">Copy</button></pre><table><thead><tr><th>host</th><th>path</th><th>message</th><th>updated</th></tr></thead><tbody><tr><td>lOrEmIpSuM.com</td><td></td><td>urlhaus-filter malicious website detected</td><td>2023-03-13T00:11:20Z</td></tr><tr><td>docs.google.com</td><td>malware.exe</td><td>urlhaus-filter malicious website detected</td><td>2023-03-13T00:11:20Z</td></tr></tbody></table><pre><code class="hljs spl">index=proxy [| inputlookup urlhaus-filter-splunk-online.csv | fields host, path | rename host AS domain ]</code><button class="copy-button">Copy</button></pre><table><thead><tr><th>src</th><th>domain</th></tr></thead><tbody><tr><td>192.168.1.5</td><td>loremipsum.com</td></tr></tbody></table><h2 id="CIDR-matching">CIDR matching <a href="#CIDR-matching" class="headerlink" title="CIDR matching">§</a></h2><p>Splunk automatically detects CIDR-like value in a lookup file and performs CIDR-matching accordingly. However, this behaviour is on best-effort basis and may not work as intended. To explicitly use lookup fields for CIDR-matching, use <code>lookup</code> and lookup definition.</p><pre><code class="hljs spl">index=firewall</code><button class="copy-button">Copy</button></pre><table><thead><tr><th>src</th><th>src_port</th><th>dst</th><th>action</th></tr></thead><tbody><tr><td>192.168.1.5</td><td>45454</td><td>187.190.252.167</td><td>allowed</td></tr><tr><td>192.168.1.3</td><td>45452</td><td>7.6.5.4</td><td>allowed</td></tr><tr><td>192.168.1.4</td><td>45457</td><td>4.3.2.1</td><td>allowed</td></tr><tr><td>192.168.1.6</td><td>45451</td><td>89.248.163.100</td><td>allowed</td></tr></tbody></table><pre><code class="hljs spl">| inputlookup opendbl_ip.csv</code><button class="copy-button">Copy</button></pre><table><thead><tr><th>start</th><th>end</th><th>netmask</th><th>cidr_range</th><th>name</th><th>updated</th></tr></thead><tbody><tr><td>187.190.252.167</td><td>187.190.252.167</td><td>32</td><td>187.190.252.167&#x2F;32</td><td>Emerging Threats: Known Compromised Hosts</td><td>2023-01-30T08:03:00Z</td></tr><tr><td>89.248.163.0</td><td>89.248.163.255</td><td>24</td><td>89.248.163.0&#x2F;24</td><td>Dshield</td><td>2023-01-30T08:01:00Z</td></tr></tbody></table><pre><code class="hljs spl">index=firewall [| inputlookup opendbl_ip.csv | fields cidr_range | rename cidr_range AS dst ]</code><button class="copy-button">Copy</button></pre><table><thead><tr><th>src</th><th>src_port</th><th>dst</th><th>action</th></tr></thead><tbody><tr><td>192.168.1.5</td><td>45454</td><td>187.190.252.167</td><td>allowed</td></tr><tr><td>192.168.1.6</td><td>45451</td><td>89.248.163.100</td><td>allowed</td></tr></tbody></table><h2 id="inputlookup-lookup">inputlookup + lookup <a href="#inputlookup-lookup" class="headerlink" title="inputlookup + lookup">§</a></h2><p>When using as a subsearch, <code>inputlookup</code> filters the event data and only outputs rows with matching values of specified field(s). <code>lookup</code> enriches the event data by appending new fields to the rows with matching field values. Another way to understand the difference is that <code>inputlookup</code> performs <a href="https://en.wikipedia.org/wiki/Join_(SQL)#Inner_join" rel="noopener external nofollow noreferrer">inner join</a> while <code>lookup</code> performs <a href="https://en.wikipedia.org/wiki/Join_(SQL)#Left_outer_join" rel="noopener external nofollow noreferrer">left outer join</a> where the event data is the left table and the lookup file is the right table.</p><p>Despite their difference, it can be useful to use both at the same time to enrich filtered event data, even when using the same lookup file.</p><pre><code class="hljs spl">| inputlookup botnet_ip.csv</code><button class="copy-button">Copy</button></pre><blockquote><p><code>_time</code> field is omitted for brevity.</p></blockquote><table><thead><tr><th>first_seen_utc</th><th>dst_ip</th><th>dst_port</th><th>c2_status</th><th>last_online</th><th>malware</th><th>updated</th></tr></thead><tbody><tr><td>2021-05-16 19:49:33</td><td>1.2.3.4</td><td>1234</td><td>online</td><td>2023-03-05</td><td>Lorem</td><td>2023-03-04T16:41:17Z</td></tr><tr><td>2021-05-16 19:49:33</td><td>4.3.2.1</td><td>1234</td><td>online</td><td>2023-03-05</td><td>Ipsum</td><td>2023-03-04T16:41:17Z</td></tr></tbody></table><pre><code class="hljs spl">index=firewall</code><button class="copy-button">Copy</button></pre><table><thead><tr><th>src</th><th>src_port</th><th>dst</th><th>action</th></tr></thead><tbody><tr><td>192.168.1.5</td><td>45454</td><td>1.2.3.4</td><td>allowed</td></tr><tr><td>192.168.1.3</td><td>45452</td><td>7.6.5.4</td><td>allowed</td></tr><tr><td>192.168.1.4</td><td>45457</td><td>4.3.2.1</td><td>allowed</td></tr><tr><td>192.168.1.6</td><td>45451</td><td>7.7.5.5</td><td>allowed</td></tr></tbody></table><pre><code class="hljs spl">index=firewall [| inputlookup botnet_ip.csv | fields dst_ip | rename dst_ip AS dst]</code><button class="copy-button">Copy</button></pre><table><thead><tr><th>src</th><th>src_port</th><th>dst</th><th>action</th></tr></thead><tbody><tr><td>192.168.1.5</td><td>45454</td><td>1.2.3.4</td><td>allowed</td></tr><tr><td>192.168.1.3</td><td>45452</td><td>7.6.5.4</td><td>allowed</td></tr><tr><td>192.168.1.4</td><td>45457</td><td>4.3.2.1</td><td>allowed</td></tr><tr><td>192.168.1.6</td><td>45451</td><td>7.7.5.5</td><td>allowed</td></tr></tbody></table><pre><code class="hljs spl">index=firewall [| inputlookup botnet_ip.csv | fields dst_ip | rename dst_ip AS dst]
| lookup botnet_ip.csv dst_ip AS dst OUTPUT c2_status, malware</code><button class="copy-button">Copy</button></pre><table><thead><tr><th>src</th><th>src_port</th><th>dst</th><th>action</th><th>c2_status</th><th>malware</th></tr></thead><tbody><tr><td>192.168.1.5</td><td>45454</td><td>1.2.3.4</td><td>allowed</td><td>online</td><td>Lorem</td></tr><tr><td>192.168.1.4</td><td>45457</td><td>4.3.2.1</td><td>allowed</td><td>online</td><td>Ipsum</td></tr></tbody></table><p>It is also possible to rename lookup destination fields.</p><pre><code class="hljs spl">index=firewall [| inputlookup botnet_ip.csv | fields dst_ip | rename dst_ip AS dst]
| lookup botnet_ip.csv dst_ip AS dst OUTPUT c2_status AS &quot;C2 Server Status&quot;, malware AS &quot;Malware Family&quot;</code><button class="copy-button">Copy</button></pre><table><thead><tr><th>src</th><th>src_port</th><th>dst</th><th>action</th><th>C2 Server Status</th><th>Malware Family</th></tr></thead><tbody><tr><td>192.168.1.5</td><td>45454</td><td>1.2.3.4</td><td>allowed</td><td>online</td><td>Lorem</td></tr><tr><td>192.168.1.4</td><td>45457</td><td>4.3.2.1</td><td>allowed</td><td>online</td><td>Ipsum</td></tr></tbody></table><h2 id="Lookup-definition">Lookup definition <a href="#Lookup-definition" class="headerlink" title="Lookup definition">§</a></h2><p>Lookup definition provides matching rules for a lookup file. It can be configured for case-sensitivity, wildcard, CIDR-matching and others through <a href="https://docs.splunk.com/Documentation/Splunk/latest/Admin/Transformsconf" rel="noopener external nofollow noreferrer">transforms.conf</a>. It can also be configured via Splunk Web: Settings → Lookups → Lookup definitions.</p><p>A bare minimum lookup definition is as such:</p><pre><div class="caption"><span>transforms.conf</span></div><code class="hljs conf">[lookup-definition-name]
filename = lookup-filename.csv</code><button class="copy-button">Copy</button></pre><p>transforms.conf can be saved in the following directories in <a href="https://docs.splunk.com/Documentation/Splunk/latest/Admin/Wheretofindtheconfigurationfiles" rel="noopener external nofollow noreferrer">order of priority</a> (highest to lowest):</p><ul><li><code>$SPLUNK_HOME/etc/users/&lt;username&gt;/&lt;app_name&gt;/local/</code></li><li><code>$SPLUNK_HOME/etc/apps/&lt;app_name&gt;/local/</code></li><li><code>$SPLUNK_HOME/etc/system/local/</code></li></ul><p>My naming convention for lookup definition is simply removing the <code>.csv</code> extension, e.g. “example.csv” (lookup file), “example” (lookup definition). While it is possible to name a lookup definition with file extension (“example.csv”), I discourage it to avoid confusion.</p><p>It is imperative to note that lookup definition only applies to <code>lookup</code> search command and does <em>not</em> apply to <code>inputlookup</code>. Although <code>inputlookup</code> supports lookup definition as a lookup table (in addition to lookup file), its matching rules will be ignored.</p><h3 id="Case-sensitive">Case-sensitive <a href="#Case-sensitive" class="headerlink" title="Case-sensitive">§</a></h3><pre><div class="caption"><span>transforms.conf</span></div><code class="hljs conf">[urlhaus-filter-splunk-online]
filename = urlhaus-filter-splunk-online.csv
# applies to all fields
case_sensitive_match = 1</code><button class="copy-button">Copy</button></pre><pre><code class="hljs spl">index=proxy</code><button class="copy-button">Copy</button></pre><table><thead><tr><th>src</th><th>domain</th><th>path</th></tr></thead><tbody><tr><td>192.168.1.5</td><td>bad-domain.com</td><td>lorem-ipsum.html</td></tr><tr><td>192.168.1.3</td><td>bad-domain.com</td><td>lOrEm-iPsUm.hTmL</td></tr></tbody></table><pre><code class="hljs spl">| inputlookup urlhaus-filter-splunk-online</code><button class="copy-button">Copy</button></pre><table><thead><tr><th>host</th><th>path</th><th>message</th><th>updated</th></tr></thead><tbody><tr><td>bad-domain.com</td><td>lorem-ipsum.html</td><td>urlhaus-filter malicious website detected</td><td>2023-03-13T00:11:20Z</td></tr></tbody></table><pre><code class="hljs spl">index=proxy
| lookup urlhaus-filter-splunk-online host AS domain, path OUTPUT message</code><button class="copy-button">Copy</button></pre><table><thead><tr><th>src</th><th>domain</th><th>path</th><th>message</th></tr></thead><tbody><tr><td>192.168.1.5</td><td>bad-domain.com</td><td>lorem-ipsum.html</td><td>urlhaus-filter malicious website detected</td></tr><tr><td>192.168.1.3</td><td>bad-domain.com</td><td>lOrEm-iPsUm.hTmL</td><td></td></tr></tbody></table><h3 id="Wildcard-lookup">Wildcard (lookup) <a href="#Wildcard-lookup" class="headerlink" title="Wildcard (lookup)">§</a></h3><pre><div class="caption"><span>transforms.conf</span></div><code class="hljs conf">[urlhaus-filter-splunk-online]
filename = urlhaus-filter-splunk-online.csv
match_type = WILDCARD(host_wildcard_suffix)</code><button class="copy-button">Copy</button></pre><pre><code class="hljs spl">index=proxy</code><button class="copy-button">Copy</button></pre><table><thead><tr><th>src</th><th>url</th><th>dst_port</th></tr></thead><tbody><tr><td>192.168.1.5</td><td>foo.com&#x2F;path1</td><td>443</td></tr><tr><td>192.168.1.3</td><td>foo.com&#x2F;path2</td><td>443</td></tr><tr><td>192.168.1.4</td><td>bar.com&#x2F;path3</td><td>443</td></tr></tbody></table><p>The lookup files do not include wildcard affix.</p><pre><code class="hljs spl">| inputlookup urlhaus-filter-splunk-online</code><button class="copy-button">Copy</button></pre><table><thead><tr><th>host</th><th>path</th><th>message</th><th>updated</th><th>host_wildcard_suffix</th></tr></thead><tbody><tr><td>foo.com</td><td></td><td>urlhaus-filter malicious website detected</td><td>2023-03-13T00:11:20Z</td><td>foo.com*</td></tr></tbody></table><pre><code class="hljs spl">index=proxy
| lookup urlhaus-filter-splunk-online host_wildcard_suffix AS url OUTPUT message</code><button class="copy-button">Copy</button></pre><table><thead><tr><th>src</th><th>url</th><th>dst_port</th><th>message</th></tr></thead><tbody><tr><td>192.168.1.5</td><td>foo.com&#x2F;path1</td><td>443</td><td>urlhaus-filter malicious website detected</td></tr><tr><td>192.168.1.3</td><td>foo.com&#x2F;path2</td><td>443</td><td>urlhaus-filter malicious website detected</td></tr></tbody></table><h3 id="CIDR-matching-lookup">CIDR-matching (lookup) <a href="#CIDR-matching-lookup" class="headerlink" title="CIDR-matching (lookup)">§</a></h3><pre><div class="caption"><span>transforms.conf</span></div><code class="hljs conf">[opendbl_ip]
filename = opendbl_ip.csv
match_type = CIDR(cidr_range)</code><button class="copy-button">Copy</button></pre><pre><code class="hljs spl">index=firewall</code><button class="copy-button">Copy</button></pre><table><thead><tr><th>src</th><th>src_port</th><th>dst</th><th>action</th></tr></thead><tbody><tr><td>192.168.1.5</td><td>45454</td><td>187.190.252.167</td><td>allowed</td></tr><tr><td>192.168.1.3</td><td>45452</td><td>7.6.5.4</td><td>allowed</td></tr><tr><td>192.168.1.4</td><td>45457</td><td>4.3.2.1</td><td>allowed</td></tr><tr><td>192.168.1.6</td><td>45451</td><td>89.248.163.100</td><td>allowed</td></tr></tbody></table><pre><code class="hljs spl">| inputlookup opendbl_ip</code><button class="copy-button">Copy</button></pre><table><thead><tr><th>start</th><th>end</th><th>netmask</th><th>cidr_range</th><th>name</th><th>updated</th></tr></thead><tbody><tr><td>187.190.252.167</td><td>187.190.252.167</td><td>32</td><td>187.190.252.167&#x2F;32</td><td>Emerging Threats: Known Compromised Hosts</td><td>2023-01-30T08:03:00Z</td></tr><tr><td>89.248.163.0</td><td>89.248.163.255</td><td>24</td><td>89.248.163.0&#x2F;24</td><td>Dshield</td><td>2023-01-30T08:01:00Z</td></tr></tbody></table><pre><code class="hljs spl">index=firewall
| lookup opendbl_ip cidr_range AS dst OUTPUT name AS threat</code><button class="copy-button">Copy</button></pre><table><thead><tr><th>src</th><th>src_port</th><th>dst</th><th>action</th><th>threat</th></tr></thead><tbody><tr><td>192.168.1.5</td><td>45454</td><td>187.190.252.167</td><td>allowed</td><td>Emerging Threats: Known Compromised Hosts</td></tr><tr><td>192.168.1.3</td><td>45452</td><td>7.6.5.4</td><td>allowed</td><td></td></tr><tr><td>192.168.1.4</td><td>45457</td><td>4.3.2.1</td><td>allowed</td><td></td></tr><tr><td>192.168.1.6</td><td>45451</td><td>89.248.163.100</td><td>allowed</td><td>Dshield</td></tr></tbody></table></div><footer class="article-footer"><ul class="article-meta"><li><span class="label">Published Date:</span> <time class="dt-published" datetime="2023-04-16T00:00:00.000Z" itemprop="datePublished">16 <a href="/blog/2023/04/" title="See April 2023's posts">Apr</a> <a href="/blog/2023/" title="See 2023's posts">2023</a></time></li><li><span class="label">Tag:</span><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/splunk/" rel="tag">Splunk</a></li></ul></li><li><span class="label">Source:</span> <a href="https://gitlab.com/curben/blog/-/blob/master/source/_posts/splunk-lookup-malware-filter.md" rel="noopener external nofollow noreferrer">splunk-lookup-malware-filter.md</a></li><hr></ul></footer></div><nav id="article-nav" class="article-nav"><span class="article-nav-link-wrap newer"><strong>Newer</strong> <a href="/blog/2023/06/17/json-splunk-uf/"><div class="article-nav-title">Configure Splunk Universal Forwarder to ingest JSON files</div></a></span><span class="article-nav-link-wrap older"><strong>Older</strong> <a href="/blog/2023/02/13/ssh-certificate-cloudflare-tunnel/"><div class="article-nav-title">SSH certificate using Cloudflare Tunnel</div></a></span></nav></article></div><footer id="footer" class="post-footer footer"><hr><div id="copyright" class="copyright">&copy; 2018-2024 Ming Di Leom. <a href="https://gitlab.com/curben/blog" rel="noopener external nofollow noreferrer">Powered by </a><a href="https://hexo.io/" rel="noopener external nofollow noreferrer">Hexo</a> with <a href="https://gitlab.com/curben/blog/tree/master/themes/chameleon" rel="noopener external nofollow noreferrer">Chameleon</a> theme.<br>Content is available under <a href="https://creativecommons.org/licenses/by-sa/4.0/" rel="noopener external nofollow noreferrer license" itemprop="license">CC-BY-SA 4.0</a>, unless indicated otherwise.<br><a class="main-nav-link" href="/disclaimer/">Disclaimer</a> <a class="main-nav-link" href="https://stats.uptimerobot.com/1394zup2LQ" rel="noopener external nofollow noreferrer">Status</a> <a class="main-nav-link" href="https://xw226dvxac7jzcpsf4xb64r4epr6o5hgn46dxlqk7gnjptakik6xnzqd.onion/" rel="noopener external nofollow noreferrer">Onion</a> <a class="main-nav-link" href="https://gitlab.com/curben/blog#mirrors" rel="noopener external nofollow noreferrer">Eepsite</a></div></footer><script src="/libs/clipboard-2.0.6.min.js" defer></script><script src="/js/copy-button.js"></script><script src="/js/chameleon.js"></script></body></html>